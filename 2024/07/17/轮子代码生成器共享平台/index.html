<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Keep Team">
    
    <title>
        
            轮子代码生成器共享平台 |
        
        Keep Theme
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/logo.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"Keep Theme","author":"Keep Team","avatar":"/images/avatar.svg","logo":"/images/logo.svg","favicon":"/images/logo.svg"},"menu":{"home":"/","archives":"/archives"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":null,"category":false,"tag":false,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null}},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"toc":{"enable":false,"number":false,"expand_all":false,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":false,"preload":false},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":false,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.1.5"}
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"}
    KEEP.language_code_block = {"copy":"Copy code","copied":"Copied","fold":"Fold code block","folded":"Folded"}
    KEEP.language_copy_copyright = {"copy":"Copy copyright info","copied":"Copied","title":"Original post title","author":"Original post author","link":"Original post link"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Keep Theme
            </a>
        </div>

        <div class="right border-box">
            <div class="pc">
                <ul class="menu-list">
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                
                                HOME
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                
                                ARCHIVES
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/"
                    >HOME</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives"
                    >ARCHIVES</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        轮子代码生成器共享平台
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/avatar.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">Keep Team</span>
                                
                                    <span class="author-badge">Lv1</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2024-07-17 04:40:40</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Wed Jul 17 2024 05:42:12 GMT+0800">2024-07-17 05:42:12</span>
            </span>
        

        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/Java-FreeMarker-Picocli/">Java FreeMarker Picocli</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="1-制作代码生成器"><a href="#1-制作代码生成器" class="headerlink" title="1.制作代码生成器"></a>1.制作代码生成器</h2><h3 id="实际流程"><a href="#实际流程" class="headerlink" title="实际流程"></a>实际流程</h3><h4 id="1-制作静态文件生成器"><a href="#1-制作静态文件生成器" class="headerlink" title="1.制作静态文件生成器"></a>1.制作静态文件生成器</h4><p>实现方式：</p>
<p>​	1.直接调用api</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 静态文件生成器</span><br><span class="line"> */</span><br><span class="line">public class StaticGenerator &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        //获取相对路径</span><br><span class="line">        String projectPath = System.getProperty(&quot;user.dir&quot;);</span><br><span class="line">        //输入路径</span><br><span class="line">        String inputPath = projectPath+File.separator+&quot;code-generator-demo-projects&quot;+ File.separator +&quot;acm-template&quot;;</span><br><span class="line">        //输出路径</span><br><span class="line">        String outputPath = projectPath;</span><br><span class="line">        copyFileByHutool(inputPath,outputPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 拷贝文件</span><br><span class="line">     * @param inputPath 输入路径</span><br><span class="line">     * @param outputPath 输出路径</span><br><span class="line">     */</span><br><span class="line">    public static void copyFileByHutool(String inputPath, String outputPath) &#123;</span><br><span class="line">        FileUtil.copy(inputPath, outputPath, true);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>优点：非常简单，一行代码</p>
<p>缺点：整个目录进行复制，无法对部分文件进行操作</p>
<p>​	2.利用递归</p>
<h4 id="2-动态文件生成思路"><a href="#2-动态文件生成思路" class="headerlink" title="2.动态文件生成思路"></a>2.动态文件生成思路</h4><p>思路：全局搜索替换（正则表达式）</p>
<p>对于 ACM 示例模板项目，我们可以怎么定制生成呢?</p>
<p>让我们先明确几个动态生成的需求:</p>
<p>1.在代码开头增加作者 @Author 注释(增加代码)</p>
<p>2.修改程序输出的信息提示(替换代码)</p>
<p>3.将循环读取输入改为单次读取(可选代码)</p>
<h5 id="模板引擎（FreeMrker）"><a href="#模板引擎（FreeMrker）" class="headerlink" title="模板引擎（FreeMrker）"></a>模板引擎（FreeMrker）</h5><p>将预定义模板与特定数据合并，得到最终数据的工具，是一个挖坑的工具，开发者只需要去投喂数据即可</p>
<p>优点：不需要去写挖坑填坑的逻辑</p>
<p>官方文档：<a class="link"   target="_blank" rel="noopener" href="https://freemarker.apache.org/docs/index.html" >https://freemarker.apache.org/docs/index.html<i class="fas fa-external-link-alt"></i></a></p>
<p>中文：<a class="link"   target="_blank" rel="noopener" href="http://freemarker.foofun.cn/toc.html" >http://freemarker.foofun.cn/toc.html<i class="fas fa-external-link-alt"></i></a></p>
<p><strong>组成</strong></p>
<p>模板</p>
<p>FreeMarker 拥有自己的模板编写规则，一般用 FTL 表示 FreeMarker 模板语言。比如myweb.html.ftl 就是一个 FreeMarker 的模板文件。</p>
<p>模板文件由 4 个核心部分组成:<br>1)文本:固定的内容，会按原样输出。<br>2)插值:用 ${…} 语法来占位，尖括号中的内容在经过计算和替换后，才会输出。<br>3)FTL 指令:有点像 HTML的标签语法，通过&lt;#xxx…&gt;来实现各种特殊功能。比如#list elements as element&gt;实现循环输出。<br>4)注释:和 HTML 注释类似，使用–&gt;语法，注释中的内容不《并–会输出。</p>
<p>示例代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>鱼皮官网<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>欢迎来到鱼皮官网<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">u1</span>&gt;</span></span><br><span class="line">        &lt;#--循环渲染导航条 --&gt;</span><br><span class="line">        <span class="comment">&lt;!--FTL 指令--&gt;</span></span><br><span class="line">        &lt;#list menuItems as item&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>$fitem.label&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &lt;/#list&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">u1</span>&gt;</span></span><br><span class="line">    &lt;#--底部版权信息(注释部分，不会被输出)--&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">footer</span>&gt;</span></span><br><span class="line">            $&#123;currentYear&#125;鱼皮官网:All rightsreserved</span><br><span class="line">        <span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>数据模型</strong></p>
<p>我们把为模板准备的所有数据整体统称为 数据模型在 FreeMarker 中，数据模型一般是树形结构，可以是复杂的 Java 对象、也可以是 HashMap 等更通用的结构。</p>
<h5 id="freemarker实战"><a href="#freemarker实战" class="headerlink" title="freemarker实战"></a>freemarker实战</h5><p>1.引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.freemarker/freemarker --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.freemarker&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;freemarker&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.3.32&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>2.创建配置对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class FreeMarkerTest &#123;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void test() throws IOException &#123;</span><br><span class="line">        //new出Configeration对象，参数为Freemarker版本号</span><br><span class="line">        Configuration cfg = new Configuration(Configuration.VERSION_2_3_32);</span><br><span class="line"></span><br><span class="line">        //指定模板文件所在的路径</span><br><span class="line">        cfg.setDirectoryForTemplateLoading(new File(&quot;src/main/resources/templates&quot;));</span><br><span class="line"></span><br><span class="line">        //设置模板文件的字符集</span><br><span class="line">        cfg.setDefaultEncoding(&quot;UTF-8&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.准备模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;鱼皮官网&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;欢迎来到鱼皮官网&lt;/h1&gt;</span><br><span class="line">    &lt;u1&gt;</span><br><span class="line">        &lt;#--循环渲染导航条 --&gt;</span><br><span class="line">        &lt;#list menuItems as item&gt;</span><br><span class="line">            &lt;li&gt;$fitem.label&#125;&lt;/li&gt;</span><br><span class="line">        &lt;/#list&gt;</span><br><span class="line">    &lt;/u1&gt;</span><br><span class="line">    &lt;#--底部版权信息(注释部分，不会被输出)--&gt;</span><br><span class="line">        &lt;footer&gt;</span><br><span class="line">            $&#123;currentYear&#125;鱼皮官网:All rightsreserved</span><br><span class="line">        &lt;/footer&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>创建Template对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//创建模板对象，加载指定模板</span><br><span class="line">Template template = configuration.getTemplate(&quot;myweb.html.ftl&quot;);</span><br></pre></td></tr></table></figure>

<p>4.创建数据模型</p>
<pre><code>1. json
1. hashmap（更通用）
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//数据模型</span><br><span class="line">Map&lt;String, Object&gt;dataModel = new HashMap&lt;&gt;();</span><br><span class="line">dataModel.put(&quot;currentYear&quot;,2023);</span><br><span class="line">List&lt;Map&lt;String, Object&gt;&gt; menuItems = new ArrayList&lt;&gt;();</span><br><span class="line">Map&lt;String, Object&gt; menuItem1 = new HashMap&lt;&gt;();</span><br><span class="line">menuItem1.put(&quot;url&quot;,&quot;https://codefather.com&quot;);</span><br><span class="line">menuItem1.put(&quot;label&quot;,&quot;编程导航&quot;);</span><br><span class="line">Map&lt;String, Object&gt; menuItem2 = new HashMap&lt;&gt;();</span><br><span class="line">menuItem2.put(&quot;url&quot;,&quot;https://laoyujianli.com&quot;);</span><br><span class="line">menuItems.add(menuItem1);</span><br><span class="line">menuItems.add(menuItem2);</span><br><span class="line">dataModel.put(&quot;menuItenms&quot;,menuItems);</span><br></pre></td></tr></table></figure>

<p>5.指定生成的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//指定生成文件</span><br><span class="line">Writer out = new FileWriter(&quot;myweb.html&quot;);</span><br></pre></td></tr></table></figure>

<p>6.调用模板代码，调用后关闭</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//调用模板对象的生成文件</span><br><span class="line">template.process(dataModel,out);</span><br><span class="line">//生成后关闭</span><br><span class="line">out.close();</span><br></pre></td></tr></table></figure>

<p>完整代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public class FreeMarkerTest &#123;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void test() throws IOException, TemplateException &#123;</span><br><span class="line">        //new出Configeration对象，参数为Freemarker版本号</span><br><span class="line">        Configuration configuration = new Configuration(Configuration.VERSION_2_3_32);</span><br><span class="line"></span><br><span class="line">        //指定模板文件所在的路径</span><br><span class="line">        configuration.setDirectoryForTemplateLoading(new File(&quot;src/main/resources/templates&quot;));</span><br><span class="line"></span><br><span class="line">        //设置模板文件的字符集</span><br><span class="line">        configuration.setDefaultEncoding(&quot;UTF-8&quot;);</span><br><span class="line"></span><br><span class="line">        //解决本地化敏感 例如2,023-&gt;2023</span><br><span class="line">        configuration.setNumberFormat(&quot;0.######&quot;);</span><br><span class="line"></span><br><span class="line">        //创建模板对象，加载指定模板</span><br><span class="line">        Template template = configuration.getTemplate(&quot;myweb.html.ftl&quot;);</span><br><span class="line"></span><br><span class="line">        //数据模型</span><br><span class="line">        Map&lt;String, Object&gt;dataModel = new HashMap&lt;&gt;();</span><br><span class="line">        dataModel.put(&quot;currentYear&quot;, 2023);</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; menuItems = new ArrayList&lt;&gt;();</span><br><span class="line">        Map&lt;String, Object&gt; menuItem1 = new HashMap&lt;&gt;();</span><br><span class="line">        menuItem1.put(&quot;url&quot;,&quot;https://codefather.cn&quot;);</span><br><span class="line">        menuItem1.put(&quot;label&quot;,&quot;编程导航&quot;);</span><br><span class="line">        Map&lt;String, Object&gt; menuItem2 = new HashMap&lt;&gt;();</span><br><span class="line">        menuItem2.put(&quot;url&quot;,&quot;https://laoyujianli.com&quot;);</span><br><span class="line">        menuItem2.put(&quot;label&quot;,&quot;老鱼简历&quot;);</span><br><span class="line">        menuItems.add(menuItem1);</span><br><span class="line">        menuItems.add(menuItem2);</span><br><span class="line">        dataModel.put(&quot;menuItems&quot;,menuItems);</span><br><span class="line"></span><br><span class="line">        //指定生成文件</span><br><span class="line">        Writer out = new FileWriter(&quot;myweb.html&quot;);</span><br><span class="line"></span><br><span class="line">        //调用模板对象的生成文件</span><br><span class="line">        template.process(dataModel,out);</span><br><span class="line">        //生成后关闭</span><br><span class="line">        out.close();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="3-动态文件生成实现"><a href="#3-动态文件生成实现" class="headerlink" title="3.动态文件生成实现"></a>3.动态文件生成实现</h4><p>步骤</p>
<ol>
<li><p>定义数据模型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 静态模板配置</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">public class MainTemplateConfig &#123;</span><br><span class="line">    //让我们先明确几个动态生成的需求:</span><br><span class="line">    //1.在代码开头增加作者 @Author 注释(增加代码)</span><br><span class="line">    // 2.修改程序输出的信息提示(替换代码)</span><br><span class="line">    // 3.将循环读取输入改为单次读取(可选代码)</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 作者（填充值）</span><br><span class="line">     */</span><br><span class="line">    private String author;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 输出信息</span><br><span class="line">     */</span><br><span class="line">    private String outputText;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 是否循环（开关）</span><br><span class="line">     */</span><br><span class="line">    private boolean loop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写动态模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import java.util.Scanner;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * ACM 输入模板（多数之和）</span><br><span class="line"> * @author $&#123;author&#125;</span><br><span class="line"> */</span><br><span class="line">public class MainTemplate &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Scanner scanner = new Scanner(System.in);</span><br><span class="line"></span><br><span class="line">&lt;#if loop&gt;</span><br><span class="line">        while (scanner.hasNext()) &#123;</span><br><span class="line">&lt;/#if&gt;</span><br><span class="line"></span><br><span class="line">            // 读取输入元素个数</span><br><span class="line">            int n = scanner.nextInt();</span><br><span class="line"></span><br><span class="line">            // 读取数组</span><br><span class="line">            int[] arr = new int[n];</span><br><span class="line">            for (int i = 0; i &lt; n; i++) &#123;</span><br><span class="line">                arr[i] = scanner.nextInt();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 处理问题逻辑，根据需要进行输出</span><br><span class="line">            // 示例：计算数组元素的和</span><br><span class="line">            int sum = 0;</span><br><span class="line">            for (int num : arr) &#123;</span><br><span class="line">                sum += num;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot;$&#123;outputText&#125; &quot; + sum);</span><br><span class="line">//条件判断            </span><br><span class="line">&lt;#if loop&gt;</span><br><span class="line">        &#125;</span><br><span class="line">&lt;/#if&gt;</span><br><span class="line"></span><br><span class="line">        scanner.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>想法：模板项目想开启redis就需要更改多处代码，可以使用enable Redis控制这些代码</p>
</li>
<li><p>组合生成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 动态文件生成器</span><br><span class="line"> */</span><br><span class="line">public class DynamicGenerator &#123;</span><br><span class="line">    public static void main(String[] args) throws IOException, TemplateException &#123;</span><br><span class="line">        //new出Configeration对象，参数为Freemarker版本号</span><br><span class="line">        Configuration configuration = new Configuration(Configuration.VERSION_2_3_32);</span><br><span class="line"></span><br><span class="line">        //找到文件目录</span><br><span class="line">        String projectPath = System.getProperty(&quot;user.dir&quot;)+ File.separator+&quot;code-generator-basic&quot;;</span><br><span class="line">        File parentFile = new File(projectPath);</span><br><span class="line">        File file =new File(parentFile,&quot;src/main/resources/templates&quot;);</span><br><span class="line">        //指定模板文件所在的路径</span><br><span class="line">        configuration.setDirectoryForTemplateLoading(file);</span><br><span class="line"></span><br><span class="line">        //设置模板文件的字符集</span><br><span class="line">        configuration.setDefaultEncoding(&quot;UTF-8&quot;);</span><br><span class="line"></span><br><span class="line">        //解决本地化敏感 例如2,023-&gt;2023</span><br><span class="line">        configuration.setNumberFormat(&quot;0.######&quot;);</span><br><span class="line"></span><br><span class="line">        //创建模板对象，加载指定模板</span><br><span class="line">        Template template = configuration.getTemplate(&quot;mainTemplate.java.ftl&quot;);</span><br><span class="line"></span><br><span class="line">        //数据模型</span><br><span class="line">        MainTemplateConfig mainTemplateConfig = new MainTemplateConfig();</span><br><span class="line">        mainTemplateConfig.setAuthor(&quot;zlz&quot;);</span><br><span class="line">        mainTemplateConfig.setOutputText(&quot;输出结果：&quot;);</span><br><span class="line">        mainTemplateConfig.setLoop(false);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //指定生成文件</span><br><span class="line">        Writer out = new FileWriter(&quot;myweb.html&quot;);</span><br><span class="line"></span><br><span class="line">        //调用模板对象的生成文件</span><br><span class="line">        template.process(mainTemplateConfig,out);</span><br><span class="line">        //生成后关闭</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>完善优化</p>
<p>1.当用户如果不输入值也能生成，相当于给了默认值</p>
</li>
</ol>
<p>​	在数据模型当中优化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 作者（填充值）</span><br><span class="line"> */</span><br><span class="line">private String author = &quot;zlz&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 输出信息</span><br><span class="line"> */</span><br><span class="line">private String outputText = &quot;输出结果&quot;;</span><br></pre></td></tr></table></figure>

<p>​		2. 写静态方法（程序不要写死）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 动态文件生成器</span><br><span class="line"> */</span><br><span class="line">public class DynamicGenerator &#123;</span><br><span class="line">    public static void main(String[] args) throws IOException, TemplateException &#123;</span><br><span class="line"></span><br><span class="line">        String projectPath = System.getProperty(&quot;user.dir&quot;)+ File.separator+&quot;code-generator-basic&quot;;</span><br><span class="line">        String inpuPath = projectPath + File.separator+&quot;src/main/resources/templates/MainTemplate.java.ftl&quot;;</span><br><span class="line">        String outputPath = projectPath + File.separator+&quot;MainTemplate.java.ftl&quot;;</span><br><span class="line"></span><br><span class="line">        //数据模型</span><br><span class="line">        MainTemplateConfig mainTemplateConfig = new MainTemplateConfig();</span><br><span class="line">        mainTemplateConfig.setAuthor(&quot;zlz1&quot;);</span><br><span class="line">        mainTemplateConfig.setOutputText(&quot;输出的结果：&quot;);</span><br><span class="line">        mainTemplateConfig.setLoop(true);</span><br><span class="line">        doGenerator(inpuPath,outputPath,mainTemplateConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 生成文件</span><br><span class="line">     *</span><br><span class="line">     * @param inputPath 模板文件输入路径</span><br><span class="line">     * @param outputPath 输出路径</span><br><span class="line">     * @param model 数据模型</span><br><span class="line">     * @throws IOException</span><br><span class="line">     * @throws TemplateException</span><br><span class="line">     */</span><br><span class="line">    public static void doGenerator(String inputPath, String outputPath, Object model)throws IOException, TemplateException&#123;</span><br><span class="line">        //new出Configeration对象，参数为Freemarker版本号</span><br><span class="line">        Configuration configuration = new Configuration(Configuration.VERSION_2_3_32);</span><br><span class="line"></span><br><span class="line">        //获取实际模板所在文件的父目录（这样就不用写死了）</span><br><span class="line">        File templateDir = new File(inputPath).getParentFile();</span><br><span class="line">        configuration.setDirectoryForTemplateLoading(templateDir);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //设置模板文件的字符集</span><br><span class="line">        configuration.setDefaultEncoding(&quot;UTF-8&quot;);</span><br><span class="line"></span><br><span class="line">        //解决本地化敏感 例如2,023-&gt;2023</span><br><span class="line">        configuration.setNumberFormat(&quot;0.######&quot;);</span><br><span class="line"></span><br><span class="line">        //获取模板名称，创建模板对象，加载指定模板</span><br><span class="line">        String templateName = new File(inputPath).getName();</span><br><span class="line">        Template template = configuration.getTemplate(templateName);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //指定生成文件</span><br><span class="line">        Writer out = new FileWriter(outputPath);</span><br><span class="line"></span><br><span class="line">        //调用模板对象的生成文件</span><br><span class="line">        template.process(model,out);</span><br><span class="line">        //生成后关闭</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="4-动静结合"><a href="#4-动静结合" class="headerlink" title="4.动静结合"></a>4.动静结合</h4><p>先生成静态（把整个目录复制），再到静态生成的目录进行替换</p>
<p>public class MainGenerator {</p>
<pre><code>public static void main(String[] args) throws TemplateException, IOException &#123;
    //1.静态文件生成
    //获取相对路径
    String projectPath = System.getProperty(&quot;user.dir&quot;);
    //输入路径
    String inputPath = projectPath+ File.separator+&quot;code-generator-demo-projects&quot;+ File.separator +&quot;acm-template&quot;;
    //输出路径
    String outputPath = projectPath;
    //复制
    StaticGenerator.copyFileByHutool(inputPath,outputPath);

    //2.动态文件生成
    String dynamicInpuPath = projectPath +File.separator+ &quot;code-generator-basic&quot; + File.separator+&quot;src/main/resources/templates/MainTemplate.java.ftl&quot;;
    String dynamicOutputPath = projectPath + File.separator+&quot;acm-template/src/com/yupi/acm/MainTemplate.java&quot;;

    //数据模型
    MainTemplateConfig mainTemplateConfig = new MainTemplateConfig();
    mainTemplateConfig.setAuthor(&quot;zlz1&quot;);
    mainTemplateConfig.setOutputText(&quot;输出的结果：&quot;);
    mainTemplateConfig.setLoop(true);

    DynamicGenerator.doGenerator(dynamicInpuPath,dynamicOutputPath,mainTemplateConfig);
&#125;
&#125;
</code></pre>
<h4 id="5-命令行工具开发"><a href="#5-命令行工具开发" class="headerlink" title="5.命令行工具开发"></a>5.命令行工具开发</h4><h5 id="命令的结构"><a href="#命令的结构" class="headerlink" title="命令的结构"></a>命令的结构</h5><p><img   src="/../image/Snipaste_2024-02-18_11-21-18.png"  alt="Snipaste_2024-02-18_11-21-18"></p>
<p>-command:命令类型，具体要做的事</p>
<p>option:选项，用于改变命令的行为</p>
<p>parameter:参数，传递给命令行工具的值</p>
<h5 id="命令行工具的优点"><a href="#命令行工具的优点" class="headerlink" title="命令行工具的优点"></a>命令行工具的优点</h5><p>1.不依赖于特定的图形界面，非常轻量</p>
<p>2.通常可以直接在操作系统自带的终端环境中运行</p>
<p>3.可以和用户交互，给用户输入引导和帮助手册</p>
<p><img   src="/../image/Snipaste_2024-02-18_11-30-22.png"  alt="Snipaste_2024-02-18_11-30-22"></p>
<p>4.内置一些快捷操作（比如查看历史、上下文切换命令）</p>
<h5 id="picocli开发"><a href="#picocli开发" class="headerlink" title="picocli开发"></a>picocli开发</h5><p>看开发文档：<a class="link"   target="_blank" rel="noopener" href="https://picocli.info/" >https://picocli.info/<i class="fas fa-external-link-alt"></i></a></p>
<p><strong>跑demo</strong></p>
<p>1.引入库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/info.picocli/picocli --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;info.picocli&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;picocli&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.7.5&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>2.跑demo（将用户输入的参数传递给变量打印）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">//2.打上Command注解，表示是Cli的程序，版本号和名称随便起</span><br><span class="line">//mixinStandardHelpOptions = true 的作用：给命令行工具自动提供帮助手册的能力</span><br><span class="line">@Command(name = &quot;ASCIIArt&quot;, version = &quot;ASCIIArt 1.0&quot;, mixinStandardHelpOptions = true)</span><br><span class="line">//1.首先实现runnable接口，或者Callable</span><br><span class="line">public class ASCIIArt implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">    //打上Option注解的作用：声明fontSize这个变量是通过用户在命令行输入来接收值的（加-的方式输入）</span><br><span class="line">    @Option(names = &#123;&quot;-s&quot;, &quot;--font-size&quot;&#125;, description = &quot;Font size&quot;)</span><br><span class="line">    int fontSize = 19;</span><br><span class="line"></span><br><span class="line">    //Parameters的作用：声明Parameters这个变量是通过用户在命令行输入来接收值的（不加-的方式输入）</span><br><span class="line">    @Parameters(paramLabel = &quot;&lt;word&gt;&quot;, defaultValue = &quot;Hello, picocli&quot;,</span><br><span class="line">            description = &quot;Words to be translated into ASCII art.&quot;)</span><br><span class="line">    //默认值</span><br><span class="line">    private String[] words = &#123;&quot;Hello,&quot;, &quot;picocli&quot;&#125;;</span><br><span class="line"></span><br><span class="line">    //用户按回车后出现的界面（用户确认命令后执行的业务逻辑）</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        //自己实现业务逻辑</span><br><span class="line">        System.out.println(&quot;fontSize = &quot; + fontSize);</span><br><span class="line">        System.out.println(&quot;words=&quot; + String.join(&quot;,&quot;, words));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        //新建一个框架提供的CommandLine类的对象，传递的参数是ASCIIArt（Command类的对象和args用户的输入）和通过execute方法将用户的输入放到ASCIIArt对象中</span><br><span class="line">        int exitCode = new CommandLine(new ASCIIArt()).execute(args);</span><br><span class="line">        //通过exitCode码来判断程序是否正常执行</span><br><span class="line">        System.exit(exitCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Parameters和Option的作用</p>
<p><img   src="/../image/Snipaste_2024-02-18_13-47-44.png"  alt="Snipaste_2024-02-18_13-47-44"></p>
<p>步骤</p>
<p>1.首先实现runnable接口，或者Callable</p>
<p>2.打上Command注解，表示是Cli的程序，版本号和名称随便起</p>
<p>3.打上Option注解的作用：声明fontSize这个变量是通过用户在命令行输入来接收值的（加-的方式输入），该注解下的变量就是要用户输入的参数</p>
<p>4.写run方法，编写业务逻辑</p>
<p>5.通过CommandLine对象接收输入并执行命令</p>
<h5 id="框架自动生成帮助手册"><a href="#框架自动生成帮助手册" class="headerlink" title="框架自动生成帮助手册"></a>框架自动生成帮助手册</h5><p>1.帮助手册</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//打上Command注解，表示是Cli的程序，版本号和名称随便起</span><br><span class="line">//mixinStandardHelpOptions = true 的作用：给命令行工具自动提供帮助手册的能力</span><br><span class="line">@Command(name = &quot;ASCIIArt&quot;, version = &quot;ASCIIArt 1.0&quot;, mixinStandardHelpOptions = true)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>命令解析</li>
</ol>
<p>​			1.注解：</p>
<p>​				Option:用于解析选项</p>
<p>​						names:用户输入什么来触发</p>
<p>​						description:给选项打注释</p>
<p>​						requied:为true要求用户必填</p>
<p>​				Parameters:用于解析参数</p>
<p>​						paramLabel：给用户的展示信息</p>
<p>​						defaultValue:参数默认值</p>
<p>​						description:给帮助手册用的</p>
<p>​						requied:为true要求用户必填</p>
<p>​				2.支持多值选项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@Option(names = &quot;-option&quot;)</span><br><span class="line"></span><br><span class="line">      int [] value</span><br></pre></td></tr></table></figure>





<p>3.交互式输入能力</p>
<p>​	1.基本能力</p>
<hr>
<p>​		在Option注解中加interactive &#x3D; true</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * //引导用户交互式输入Demo</span><br><span class="line"> */</span><br><span class="line">public class Login implements Callable&lt;Integer&gt; &#123;</span><br><span class="line">    @Option(names = &#123;&quot;-u&quot;, &quot;--user&quot;&#125;, description = &quot;User name&quot;)</span><br><span class="line">    String user;</span><br><span class="line"></span><br><span class="line">    //interactive = true:给这个选项添加用户交互能力</span><br><span class="line">    //eco:是否在终端显示密码 </span><br><span class="line">    //prompt：用户提示</span><br><span class="line">    @Option(names = &#123;&quot;-p&quot;, &quot;--password&quot;&#125;, description = &quot;Passphrase&quot;, interactive = true,echo = true,prompt = &quot;请输入密码&quot;)</span><br><span class="line">    String password;</span><br><span class="line"></span><br><span class="line">    //所有参数输入完后才会调用call方法</span><br><span class="line">    public Integer call() throws Exception&#123;</span><br><span class="line">        System.out.println(&quot;passwoprd = &quot;+password);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        new CommandLine(new Login()).execute(&quot;-u&quot;,&quot;user123&quot;,&quot;-p&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：默认情况下如果用jar包运行上述程序，用户输入是不会显示在控制台（类似输入密码时的体验）</p>
<p>新特点：版本4.7以后</p>
<p>​	option新加参数</p>
<p>​		1.echo:jar包下是不会用户输入是不会显示在控制台</p>
<p>​		2.prompt：用户输入的提示</p>
<hr>
<p>​	2.多个选项交互式：按顺序提示用户输入</p>
<p>程序设计问题：在main方法中不指定再次输入密码的参数，这样设计合理吗？</p>
<p><img   src="/../image/Snipaste_2024-02-18_15-16-21.png"  alt="Snipaste_2024-02-18_15-16-21"></p>
<p>执行结果：</p>
<p><img   src="/../image/Snipaste_2024-02-18_15-18-38.png"  alt="Snipaste_2024-02-18_15-18-38"></p>
<p>合理，每增加一个选项，都要在main方法中传的参数就多一个，肯定是要多指定一个参数</p>
<p>但是对于用户来说，越方便越好，最好就是不传参数就可以让用户一步一步的输入最好！</p>
<p>代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 引导用户交互式输入Demo</span><br><span class="line"> */</span><br><span class="line">public class Login implements Callable&lt;Integer&gt; &#123;</span><br><span class="line">    @Option(names = &#123;&quot;-u&quot;, &quot;--user&quot;&#125;, description = &quot;User name&quot;)</span><br><span class="line">    String user;</span><br><span class="line"></span><br><span class="line">    //interactive = true:给这个选项添加用户交互能力</span><br><span class="line">    @Option(names = &#123;&quot;-p&quot;, &quot;--password&quot;&#125;, description = &quot;Passphrase&quot;, interactive = true,echo = true,prompt = &quot;请输入密码: &quot;)</span><br><span class="line">    String password;</span><br><span class="line"></span><br><span class="line">    //interactive = true:给这个选项添加用户交互能力</span><br><span class="line">    @Option(names = &#123;&quot;-cp&quot;, &quot;--checkPassword&quot;&#125;, description = &quot;Check Password&quot;, interactive = true,echo = true,prompt = &quot;请再次输入密码: &quot;)</span><br><span class="line">    String checkPassword;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //所有参数输入完后才会调用call方法</span><br><span class="line">    public Integer call() throws Exception&#123;</span><br><span class="line">        System.out.println(&quot;passwoprd = &quot;+password);</span><br><span class="line">        System.out.println(&quot;passwoprd = &quot;+checkPassword);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        new CommandLine(new Login()).execute(&quot;-u&quot;,&quot;user123&quot;,&quot;-p&quot;,&quot;-cp&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>3.根据实际使用情况，又可将交互式输入分为两种模式</p>
<p>​	1.可选交互式：用户可以直接在整行命令中输入选项，而不用给用户提示信息</p>
<p>直接修改代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new CommandLine(new Login()).execute(&quot;-u&quot;,&quot;user123&quot;,&quot;-p&quot;,&quot;xxx&quot;,&quot;-cp&quot;);</span><br></pre></td></tr></table></figure>

<p><img   src="/../image/Snipaste_2024-02-18_15-32-13.png"  alt="Snipaste_2024-02-18_15-32-13"></p>
<p>​		原因：没找到对应的参数</p>
<p>​		方法：在注解中增加，arity &#x3D; “0..1”</p>
<p>​		作用：指定这个选项能接受多少个参数</p>
<p>​		参数含义：可以输0个或1个参数</p>
<p>​		<img   src="/../image/Snipaste_2024-02-18_15-35-04.png"  alt="Snipaste_2024-02-18_15-35-04"></p>
<p>​		这样做的好处（应用场景）：让用户在输入的第一条命令中就加入arity &#x3D; “0..1”，这样用户就不需要再用交互式输入参数,以后在所有需要交互式输入的参数都要加这个（用户可以有两种方式选择）</p>
<p>​		</p>
<p>​		2.强制交互式：用户必须获得提示并输入某个选项，不允许不填（每一步都需要引导）</p>
<p>想法：</p>
<hr>
<p>之前用户有引导是因为在Commandline中定义了-p，-cp</p>
<p>有没有一种方式不需要上述参数也能实现用户强制引导</p>
<p>方法：，对用户的输入进行处理，用户输入后，再重新补上-p，-cp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">        args = new String[]&#123;&quot;-u&quot; , &quot;user123&quot;,&quot;-p&quot;&#125;;</span><br><span class="line">        new CommandLine(new Login()).execute(args);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这样做更灵活，对用户的输入只需要微调一下即可</p>
<hr>
<p>​		方案：编写一段通用的校验程序，如果用户的输入命令没有包含交互式选项，那么就自动输入补充该选项即可，这样就能触发强制交互，检测args数组中是否存在对应选项，不存在则为数组添加选项元素（tip：可以利用反射自动读取必填的选项名称）</p>
<p>4.子命令（命令中嵌套命令，如git，docker）</p>
<p>功能点：git使用命令直接打开一个网页</p>
<p>方法：</p>
<p>1.声明式：定义，提前在代码中写好</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//把其它开发好的命令直接作为子命令</span><br><span class="line">@CommandLine.Command(subcommands = &#123;ASCIIArt.class&#125;)</span><br></pre></td></tr></table></figure>

<p>优点：清晰</p>
<p>2.编程式：创建CommandLine对象调用addSubcommand（子命令名称，对象）方法绑定子命令</p>
<p>优点：灵活</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">@Command(name = &quot;main&quot;, mixinStandardHelpOptions = true)</span><br><span class="line">public class SubCommandExample implements Runnable&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        System.out.println(&quot;执行主命令&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Command(name = &quot;add&quot;, description = &quot;增加&quot;,mixinStandardHelpOptions =true)</span><br><span class="line">    static class AddCommand implements Runnable&#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            System.out.println(&quot;执行增加命令&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    @Command(name = &quot;delete&quot;, description = &quot;删除&quot;,mixinStandardHelpOptions =true)</span><br><span class="line">    static class DeleteCommand implements Runnable&#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            System.out.println(&quot;执行删除命令&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    @Command(name = &quot;query&quot;, description = &quot;查询&quot;,mixinStandardHelpOptions =true)</span><br><span class="line">    static class QueryCommand implements Runnable&#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            System.out.println(&quot;执行查询命令&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        //执行主命令</span><br><span class="line">//        String[] myArgs = new String[]&#123;&#125;;</span><br><span class="line">        //查看主命令的帮助手册</span><br><span class="line">//        String[] myArgs = new String[]&#123;&quot;--help&quot;&#125;;</span><br><span class="line">        //执行增加命令</span><br><span class="line">//        String[] myArgs = new String[]&#123;&quot;add&quot;&#125;;</span><br><span class="line">        //查看增加命令的帮助手册</span><br><span class="line">        String[] myArgs = new String[]&#123;&quot;add&quot;,&quot;--help&quot;&#125;;</span><br><span class="line"></span><br><span class="line">        //执行删除命令</span><br><span class="line">//        String[] myArgs = new String[]&#123;&quot;delete&quot;&#125;;</span><br><span class="line">        //查看增加命令的帮助手册</span><br><span class="line">//        String[] myArgs = new String[]&#123;&quot;delete&quot;,&quot;--help&quot;&#125;;</span><br><span class="line">        //执行查询命令</span><br><span class="line">//        String[] myArgs = new String[]&#123;&quot;query&quot;&#125;;</span><br><span class="line">        //查看增加命令的帮助手册</span><br><span class="line">//        String[] myArgs = new String[]&#123;&quot;query&quot;,&quot;--help&quot;&#125;;</span><br><span class="line">        //执行不存在的命令会报错,而且如果命令没输全，它会报错并且提示补充完整的命令</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        //先创建副命令，再绑定子命令</span><br><span class="line">        int exitCode = new CommandLine(new SubCommandExample())</span><br><span class="line">                .addSubcommand(new AddCommand())</span><br><span class="line">                .addSubcommand(new DeleteCommand())</span><br><span class="line">                .addSubcommand(new QueryCommand())</span><br><span class="line">                .execute(myArgs);</span><br><span class="line">        System.exit(exitCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="命令功能开发：命令模式"><a href="#命令功能开发：命令模式" class="headerlink" title="命令功能开发：命令模式"></a>命令功能开发：命令模式</h5><h6 id="应用场景："><a href="#应用场景：" class="headerlink" title="应用场景："></a>应用场景：</h6><p>​	1.系统需要统一处理多种复杂的操作，比如操作排队，记录操作历史，撤销重做等</p>
<p>​	2.系统需妖持续增加新的命令、或者要处理复杂的组合命令（子命令），使用命令模式可以实现解耦</p>
<h6 id="5大要素"><a href="#5大要素" class="headerlink" title="5大要素"></a>5大要素</h6><p>1.命令（定义了遥控器按钮的制作规范）</p>
<p>​	命令就是一个接口，它定义了执行操作的方法，通常是execute，该方法封装了具体的操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface Command &#123;</span><br><span class="line">    //按遥控器触发的接口</span><br><span class="line">    void execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.具体命令（相当于遥控器的某个操作按钮）</p>
<p>具体命令是命令接口的具体实现类，它负责将请求传递给接受者（设备）并执行具体操作。</p>
<p>比如定义一个打开设备的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class TurnOnCommand implements Command&#123;</span><br><span class="line"></span><br><span class="line">    private Device device;</span><br><span class="line">    public TurnOffCommand(Device device)&#123;</span><br><span class="line">        this.device =device;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void execute() &#123;</span><br><span class="line">        device.turnOn();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.接受者（相当于被遥控的设备）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class Device &#123;</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    public Device(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void turnOn() &#123;</span><br><span class="line">        System.out.println(name + &quot;设备打开&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void turnOff() &#123;</span><br><span class="line">        System.out.println(name + &quot;设备关闭&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.调用者（遥控器）</p>
<p>作用：接受客户端命令并执行（把按钮装到遥控器上）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class RemoteControl &#123;</span><br><span class="line">    private Command command;</span><br><span class="line"></span><br><span class="line">    private List&lt;Command&gt; historyCommands;</span><br><span class="line"></span><br><span class="line">    public void setCommand(Command command)&#123;</span><br><span class="line">        this.command = command;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void pressButton()&#123;</span><br><span class="line">        historyCommands.add(command);</span><br><span class="line">        command.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上只是基础的操作，如果要实现记录历史的功能，思考是放在遥控器上还是电视上，如果记录放在电视上，我拿遥控器操作别的电视，这样信息是否会丢弃</p>
<p>推荐：记录历史最好放在遥控器这个调用者上</p>
<p>5.客户端：相当于使用遥控器的人（main方法中进行的操作）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class Client &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        //创建接受者对象</span><br><span class="line">        Device tv = new Device(&quot;tv&quot;);</span><br><span class="line">        Device stereo = new Device(&quot;Stereo&quot;);</span><br><span class="line"></span><br><span class="line">        //创建具体命令对象，可以绑定不同设备</span><br><span class="line">        TurnOnCommand turnOn = new TurnOnCommand(tv);</span><br><span class="line">        TurnOffCommand turnOff = new TurnOffCommand(stereo);</span><br><span class="line"></span><br><span class="line">        //创建调用者（遥控器）</span><br><span class="line">        RemoteControl remote = new RemoteControl();</span><br><span class="line"></span><br><span class="line">        //执行命令</span><br><span class="line">        remote.setCommand(turnOn);</span><br><span class="line">        remote.pressButton();</span><br><span class="line"></span><br><span class="line">        remote.setCommand(turnOff);</span><br><span class="line">        remote.pressButton();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img   src="/../image/Snipaste_2024-02-18_17-41-21.png"  alt="Snipaste_2024-02-18_17-41-21"></p>
<h5 id="Picocli命令行代码生成器开发"><a href="#Picocli命令行代码生成器开发" class="headerlink" title="Picocli命令行代码生成器开发"></a>Picocli命令行代码生成器开发</h5><p>1.明确需求：目的生成ACM输入模板</p>
<p>这个命令行程序需要支持3种子命令</p>
<p>​	1.generate子命令：生成文件</p>
<p>​	2.list子命令：查看要生成的原始文件列表信息</p>
<p>​	3.config子命令：查看允许用户传入的动态参数信息</p>
<p>为了简化使用，要求能同时支持通过完整命令和交互式输入的方式来设置动态参数</p>
<p>设计步骤</p>
<p>​	1.创建命令执行器（主命令）</p>
<p>​	2.分别实现每种子命令</p>
<p>​	3.提供项目的全局调用入口</p>
<p>​	4.构建程序jar包</p>
<p>​	5.测试使用</p>
<p>​	6.简化使用（封装脚本）</p>
<p>实现步骤</p>
<p>1.创建3个子命令类分别和需求对应</p>
<p>2.创建主命令执行器（遥控器执行子命令），命令执行者类找到<strong>子命令</strong>（命令模式中的每个命令）操作并执行它们，并提供一个方法来接收外层传来的参数，执行命令类。</p>
<p><img   src="/../image/Snipaste_2024-02-18_17-56-14.png"  alt="Snipaste_2024-02-18_17-56-14"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@Command(name = &quot;code&quot;, mixinStandardHelpOptions = true)</span><br><span class="line">public class CommandExecutor implements Runnable&#123;</span><br><span class="line"></span><br><span class="line">    private final CommandLine commandLine;</span><br><span class="line"></span><br><span class="line">    //这个Command类的主命令就是执行器，就是调用者</span><br><span class="line">    //放代码块里初始化的原因：因为执行多少次命令，commandLine 绑定的对象都是一样的，这样做节省程序的开销</span><br><span class="line">    &#123;</span><br><span class="line">        commandLine = new CommandLine(this)</span><br><span class="line">                .addSubcommand(new GenerateCommand())</span><br><span class="line">                .addSubcommand(new ConfigCommand())</span><br><span class="line">                .addSubcommand(new ListCommand());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        //不输入子命令时，给出友好提示</span><br><span class="line">        System.out.println(&quot;请输入具体命令，或者输入 --help 查看命令提示&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 执行命令</span><br><span class="line">     *</span><br><span class="line">     * @param args</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public Integer doExecute(String[] args)&#123;</span><br><span class="line">        return commandLine.execute(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="实现子命令"><a href="#实现子命令" class="headerlink" title="实现子命令"></a>实现子命令</h6><p>generate子命令</p>
<p>1.定义参数选项</p>
<p>由于生成命令传的参数与之前做的动态生成的模板传的参数一样，所以只需要复制即可</p>
<p>2.思考变量是否需要交互式输入，还是直接生成（全都要）</p>
<p>3.接收到的参数要传递给动态模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 接收用户的输入的信息，发给上期写的静动结合的代码生成器</span><br><span class="line"> * 需要交互时继承Callable，不需要交互则使用Runnable</span><br><span class="line"> */</span><br><span class="line">@Command(name = &quot;generate&quot;, mixinStandardHelpOptions = true)</span><br><span class="line">public class GenerateCommand implements Callable &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 作者（填充值）</span><br><span class="line">     */</span><br><span class="line">    @Option(names = &#123;&quot;-a&quot;, &quot;--author&quot;&#125;, description = &quot;作者名称&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">    private String author = &quot;zlz&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 输出信息</span><br><span class="line">     */</span><br><span class="line">    @Option(names = &#123;&quot;-o&quot;, &quot;--outputText&quot;&#125;, description = &quot;输出文本&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">    private String outputText = &quot;输出结果&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 是否循环（开关）</span><br><span class="line">     */</span><br><span class="line">    @Option(names = &#123;&quot;-l&quot;, &quot;--loop&quot;&#125;, description = &quot;是否循环&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">    private boolean loop;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Integer call() throws Exception &#123;</span><br><span class="line">        //把传递的参数给动态模板配置</span><br><span class="line">        MainTemplateConfig mainTemplateConfig = new MainTemplateConfig();</span><br><span class="line">        //把对象的名称属性都复制到动态模板，这个copyProperties适用于传递过来的参数和要发送的对象都一模一样时使用,从this传过来，传递到mainTemplateConfig对象</span><br><span class="line">        BeanUtil.copyProperties(this, mainTemplateConfig);</span><br><span class="line">        MainGenerator.doGenerate(mainTemplateConfig);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2.list子命令：输出所有要生成的列表信息（acm模板的信息）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Command(name = &quot;list&quot;, mixinStandardHelpOptions = true)</span><br><span class="line">public class ListCommand implements Runnable&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public  void run() &#123;</span><br><span class="line">        //获取basic路径和整个项目的根路径</span><br><span class="line">        String parentFile = System.getProperty(&quot;user.dir&quot;);</span><br><span class="line">        String projectPath = parentFile+ File.separator+&quot;code-generator-basic&quot;;</span><br><span class="line">        System.out.println(projectPath);</span><br><span class="line">        //输入路径</span><br><span class="line">        String inputPath = new File(parentFile,&quot;code-generator-demo-projects/acm-template&quot;).getAbsolutePath();</span><br><span class="line">        //遍历获取所有的文件</span><br><span class="line">        List&lt;File&gt; files = FileUtil.loopFiles(inputPath);</span><br><span class="line"></span><br><span class="line">        for (File file; files)&#123;</span><br><span class="line">            System.out.println(file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>3.config子命令</p>
<p>允许输出用户传输的动态参数信息（获取对象的属性的信息）</p>
<p>方法：利用JDK反射语法或者利用hutool工具</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Command(name = &quot;config&quot;, mixinStandardHelpOptions = true)</span><br><span class="line">public class ConfigCommand implements Runnable&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        Field[] files = ReflectUtil.getFields(MainTemplateConfig.class);</span><br><span class="line">        for (Field filed;files)&#123;</span><br><span class="line">            System.out.println(&quot;字段类型&quot;+filed.getType());</span><br><span class="line">            System.out.println(&quot;字段名称&quot;+filed.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>4.全局调用入口（使用main方法使用遥控器）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        CommandExecutor commandExecutor = new CommandExecutor();</span><br><span class="line">        commandExecutor.doExecute(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        //测试</span><br><span class="line">        args =new String[]&#123;&quot;generator&quot;,&quot;-l&quot;,&quot;-a&quot;,&quot;-o&quot;&#125;;</span><br><span class="line">//        args = new String[]&#123;&quot;config&quot;&#125;;</span><br><span class="line">//        args = new String[]&#123;&quot;list&quot;&#125;;</span><br><span class="line">        CommandExecutor commandExecutor = new CommandExecutor();</span><br><span class="line">        commandExecutor.doExecute(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>目前为止都只能在idea中使用，用户体验还是不方便</p>
<h6 id="构建jar包"><a href="#构建jar包" class="headerlink" title="构建jar包"></a>构建jar包</h6><p>1.首先注释掉我们直接给的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        //测试</span><br><span class="line">//        args =new String[]&#123;&quot;generate&quot;,&quot;-l&quot;,&quot;-a&quot;,&quot;-o&quot;&#125;;</span><br><span class="line">//        args = new String[]&#123;&quot;config&quot;&#125;;</span><br><span class="line">//        args = new String[]&#123;&quot;list&quot;&#125;;</span><br><span class="line">        CommandExecutor commandExecutor = new CommandExecutor();</span><br><span class="line">        commandExecutor.doExecute(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.引入maven插件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.3.0&lt;/version&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;descriptorRefs&gt;</span><br><span class="line">                    &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class="line">                &lt;/descriptorRefs&gt;</span><br><span class="line">                &lt;archive&gt;</span><br><span class="line">                    &lt;manifest&gt;</span><br><span class="line">                        &lt;mainClass&gt;com.yupi.Main&lt;/mainClass&gt; &lt;!-- 替换为你的主类的完整类名 --&gt;</span><br><span class="line">                    &lt;/manifest&gt;</span><br><span class="line">                &lt;/archive&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">            &lt;executions&gt;</span><br><span class="line">                &lt;execution&gt;</span><br><span class="line">                    &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">                    &lt;goals&gt;</span><br><span class="line">                        &lt;goal&gt;single&lt;/goal&gt;</span><br><span class="line">                    &lt;/goals&gt;</span><br><span class="line">                &lt;/execution&gt;</span><br><span class="line">            &lt;/executions&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>

<p>3.生成jar包</p>
<p><img   src="/../image/Snipaste_2024-02-18_21-53-15.png"  alt="Snipaste_2024-02-18_21-53-15"></p>
<p>在target文件中多了两个jar包，用那个有依赖的</p>
<p>4.在终端输入命令（先记得调整路径）</p>
<p>java -jar code-generator-basic-1.0-SNAPSHOT-jar-with-dependencies.jar generate -l -o -a</p>
<p>命令太长了，如何解决？</p>
<p>写脚本</p>
<h6 id="Linux-Bash脚本（适合于Linux和mac系统）"><a href="#Linux-Bash脚本（适合于Linux和mac系统）" class="headerlink" title="Linux Bash脚本（适合于Linux和mac系统）"></a>Linux Bash脚本（适合于Linux和mac系统）</h6><p>好处：</p>
<p>1.不需要移动jar包，直接指定路径即可</p>
<p>2.缩短输入的命令</p>
<h2 id="2-配置功能增强"><a href="#2-配置功能增强" class="headerlink" title="2.配置功能增强"></a>2.配置功能增强</h2><p>需求拆解</p>
<p>1.基础的代码生成器工具，在已有项目模板（基于ftl）的基础上，通过读取人工配置跑通代码生成器的核心制作流程（不用再代码中找路径，改路径）</p>
<p>2.配置文件增强</p>
<p>以实现SpringBoot 初始化项目模板生成器的生成为目标，给配置文件增加更多参数，可以更灵活地制作更复杂的代码生成器</p>
<p>3.工具能力增强</p>
<p>给代码生成器制作工具增加更多能力，可以帮助开发者自动生成，更新配置文件，FTL动态模板文件，进一步提高制作效率</p>
<h3 id="1-基础代码生成器项目生成"><a href="#1-基础代码生成器项目生成" class="headerlink" title="1.基础代码生成器项目生成"></a>1.基础代码生成器项目生成</h3><p>思考前几期中哪个过程是最复杂的：生成原始模板代码</p>
<p>所以先跳过这个步骤，假设已经有了一个原始模板代码，通过程序生成一个能生成这个模板代码的代码生成器</p>
<p>1.先复制一个包含动态代码模板的ftl事例代码文件（复制acm-template）</p>
<p>2.之前的代码生成器的项目里有很多地方都是硬编码（配置信息都写死了）</p>
<p>方法：转化为配置</p>
<h4 id="元信息"><a href="#元信息" class="headerlink" title="元信息"></a>元信息</h4><p>描述信息的信息，不想把值写死在程序中，统一用一个文件管理这些允许被替换的变量</p>
<p>一般是用来描述项目的数据，比如项目的名称、作者等</p>
<p>如何设计？<br>跟设计数据库表非常类似，都要根据实际的业务需求，设置合理的存储结构、字段名和类别。</p>
<h5 id="元信息存储结构"><a href="#元信息存储结构" class="headerlink" title="元信息存储结构"></a>元信息存储结构</h5><p>此处选用JSON格式来存储元信息，理由是常用、通用、结构清晰、便于理解、对前端javaScript非常友好</p>
<h5 id="元信息字段配置"><a href="#元信息字段配置" class="headerlink" title="元信息字段配置"></a>元信息字段配置</h5><p>方法：</p>
<p>1.参考其他项目的配置信息（前端的package.json，后端的myApplication.yml）</p>
<p>2.分析自己的项目思考项目需要用到哪些配置信息</p>
<p>思考：</p>
<p>1.上个阶段的用户输入</p>
<p>2.生成代码生成器的生成器一定要读取到源代码或者jar包以及生成代码的位置</p>
<p>3.记录模板的信息</p>
<p>结合这两种方法，根据对元信息的作用对配置文件进行分类，然后后面按层级组织各种配置</p>
<p>1.记录代码生成器的基本信息（第一阶段的输入）</p>
<p>比如项目名称、作者、版本号</p>
<p>2.记录生成文件信息（这个阶段代码生成器的目的）</p>
<p>比如输入文件路径、输出路径、文件类别（目录或文件、生成类别（静态或动态））等</p>
<p>3.记录数据模型信息（这个阶段代码生成器的目的）</p>
<p>比如参数的名称、描述、类型、默认值等</p>
<p>注意：和设计库表一样，能提前确认的字段就提前确认，之后只尽量增加字段、避免修改字段</p>
<p>后面随着制作工具的能力增强，元信息的配置会越来越多，为此建议在外层尽量用对象组织字段，而不是数组。在不确定信息的情况下，这么做有利于字段的扩展</p>
<h5 id="代码生成器开发"><a href="#代码生成器开发" class="headerlink" title="代码生成器开发"></a>代码生成器开发</h5><p>步骤</p>
<p>1.项目初始化</p>
<p>2.读取元信息</p>
<p>3.生成数据模型文件</p>
<p>4.生成Picocli命令类</p>
<p>5.生成代码生成文件</p>
<p>6.程序构建jar包</p>
<p>7.程序封装脚本</p>
<p>8.测试验证</p>
<p>现在初始化项目springBoot不支持java8，可以修改Sever URL为：start.aliyun.com即可</p>
<p><img   src="/../image/Snipaste_2024-02-19_09-12-59.png"  alt="Snipaste_2024-02-19_09-12-59"></p>
<h5 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h5><p>步骤</p>
<p>1.先复制basic项目为maker项目（要生成basic就要先用到里面的文件，直接复制）</p>
<p>2.更改名字</p>
<p>3.删除多余代码</p>
<p>tips：什么情况下把文件放在一个子包下？</p>
<p>​			1.其他文件要调用这个子包，把其他文件放在这个子包下</p>
<p>​			2.把同类的文件放在子包下</p>
<p>4.使用maker代码生成basic代码</p>
<hr>
<p>​	想法：使用freemarker挖坑，使用配置文件里的信息放到这里</p>
<p>​	根据上一阶段做的项目，先实现在代码文件中自动生成对应的代码结构（哪个模板文件放到哪个目录下）</p>
<p>​			maker包下的文件分布在template下创建相应的文件目录</p>
<p><img   src="/../image/Snipaste_2024-02-19_10-44-19.png"  alt="Snipaste_2024-02-19_10-44-19"></p>
<h4 id="如何定义元信息，读取元信息（用json格式数据存储）"><a href="#如何定义元信息，读取元信息（用json格式数据存储）" class="headerlink" title="如何定义元信息，读取元信息（用json格式数据存储）"></a>如何定义元信息，读取元信息（用json格式数据存储）</h4><p>1.在template目录下新建meta.json</p>
<p>里面输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;acm-template-pro-generator&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;ACM 示例模板生成器&quot;,</span><br><span class="line">  &quot;basePackage&quot;: &quot;com.yupi&quot;,</span><br><span class="line">  &quot;version&quot;: &quot;1.0&quot;,</span><br><span class="line">  &quot;author&quot;: &quot;yupi&quot;,</span><br><span class="line">  &quot;createTime&quot;: &quot;2023-11-22&quot;,</span><br><span class="line">  &quot;fileConfig&quot;: &#123;</span><br><span class="line">  	//输入路径，inputRootPath用相对路径的原因是因为运行环境会发生变化，又保证了整体替换的特性</span><br><span class="line">    &quot;inputRootPath&quot;: &quot;/Users/yuzi-generator/yuzi-generator-demo-projects/acm-template-pro&quot;,</span><br><span class="line">    //输出路径</span><br><span class="line">    &quot;outputRootPath&quot;: &quot;generated&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;dir&quot;,</span><br><span class="line">    //列举想要生成哪些文件 &quot;generateType为动态的就用freeMaker发动态生成，静态的就复制</span><br><span class="line">    &quot;files&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;inputPath&quot;: &quot;src/com/yupi/acm/MainTemplate.java.ftl&quot;,</span><br><span class="line">        &quot;outputPath&quot;: &quot;src/com/yupi/acm/MainTemplate.java&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;file&quot;,</span><br><span class="line">        &quot;generateType&quot;: &quot;dynamic&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;inputPath&quot;: &quot;.gitignore&quot;,</span><br><span class="line">        &quot;outputPath&quot;: &quot;.gitignore&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;file&quot;,</span><br><span class="line">        &quot;generateType&quot;: &quot;static&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;inputPath&quot;: &quot;README.md&quot;,</span><br><span class="line">        &quot;outputPath&quot;: &quot;README.md&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;file&quot;,</span><br><span class="line">        &quot;generateType&quot;: &quot;static&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;modelConfig&quot;: &#123;</span><br><span class="line">    &quot;models&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;loop&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;boolean&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;是否生成循环&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: false,</span><br><span class="line">        &quot;abbr&quot;: &quot;l&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;author&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;作者注释&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: &quot;yupi&quot;,</span><br><span class="line">        &quot;abbr&quot;: &quot;a&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;outputText&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;输出信息&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: &quot;sum = &quot;,</span><br><span class="line">        &quot;abbr&quot;: &quot;o&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.新建meta包（源代码信息读取类：整个项目核心组成部分）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">@NoArgsConstructor</span><br><span class="line">@Data</span><br><span class="line">public class Meta &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private String name;</span><br><span class="line">    private String description;</span><br><span class="line">    private String basePackage;</span><br><span class="line">    private String version;</span><br><span class="line">    private String author;</span><br><span class="line">    private String createTime;</span><br><span class="line">    private FileConfig fileConfig;</span><br><span class="line">    private ModelConfig modelConfig;</span><br><span class="line"></span><br><span class="line">    @NoArgsConstructor</span><br><span class="line">    @Data</span><br><span class="line">    public static class FileConfig &#123;</span><br><span class="line">        private String inputRootPath;</span><br><span class="line">        private String outputRootPath;</span><br><span class="line">        private String type;</span><br><span class="line">        private List&lt;FileInfo&gt; files;</span><br><span class="line"></span><br><span class="line">        @NoArgsConstructor</span><br><span class="line">        @Data</span><br><span class="line">        public static class FileInfo &#123;</span><br><span class="line">            private String inputPath;</span><br><span class="line">            private String outputPath;</span><br><span class="line">            private String type;</span><br><span class="line">            private String generateType;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @NoArgsConstructor</span><br><span class="line">    @Data</span><br><span class="line">    public static class ModelConfig &#123;</span><br><span class="line">        private List&lt;ModelsInfo&gt; models;</span><br><span class="line"></span><br><span class="line">        @NoArgsConstructor</span><br><span class="line">        @Data</span><br><span class="line">        public static class ModelsInfo &#123;</span><br><span class="line">            private String fieldName;</span><br><span class="line">            private String type;</span><br><span class="line">            private String description;</span><br><span class="line">            private Object defaultValue;</span><br><span class="line">            private String abbr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.转json，读对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class MetaManager &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String metaJson = ResourceUtil.readUtf8Str(&quot;meta.json&quot;);</span><br><span class="line">        Meta newMeta = JSONUtil.toBean(metaJson, Meta.class);</span><br><span class="line">        System.out.println(newMeta);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样写问题不大，但是还有优化的空间，每次都要执行这两行代码会浪费性能</p>
<p>优化：在项目第一次运行时就放到内存中</p>
<p>优化后的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 业务层:读取meta文件</span><br><span class="line"> */</span><br><span class="line">public class MetaManager &#123;</span><br><span class="line"></span><br><span class="line">    //单例模式</span><br><span class="line"></span><br><span class="line">    //volatile关键字是为了确保多线程情况下的内存可见性（多个线程设置一个值的时候，不是共享内存，而是有每个线程各自先更新本地内存，经过一段时间后才会去合并共享）</span><br><span class="line">    //如果没有这个关键字，还是有可能会出现重复初始化</span><br><span class="line">    private static volatile Meta meta;</span><br><span class="line"></span><br><span class="line">    public static Meta getMetaObject()&#123;</span><br><span class="line">        //双检索单例模式</span><br><span class="line">        //不加锁直接这样写，当有多个线程同时进来时，此时的meta都为null，就有问题</span><br><span class="line">        if (meta == null)&#123;</span><br><span class="line">            //静态对象：基于整个类加锁</span><br><span class="line">            synchronized (MetaManager.class)&#123;</span><br><span class="line">                if (meta == null)&#123;</span><br><span class="line">                    meta = initMeta();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return meta;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static Meta initMeta()&#123;</span><br><span class="line">        String metaJson = ResourceUtil.readUtf8Str(&quot;meta.json&quot;);</span><br><span class="line">        Meta newMeta = JSONUtil.toBean(metaJson, Meta.class);</span><br><span class="line">        //todo 校验配置文件的合法性，处理默认值</span><br><span class="line">        return newMeta;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h5><p>在项目运行期间只存在一个被初始化的对象实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//双检索单例模式</span><br><span class="line">//不加锁直接这样写，当有多个线程同时进来时，此时的meta都为null，就有问题</span><br><span class="line">if (meta == null)&#123;</span><br><span class="line">    //静态对象：基于整个类加锁</span><br><span class="line">    synchronized (MetaManager.class)&#123;</span><br><span class="line">        if (meta == null)&#123;</span><br><span class="line">            meta = initMeta();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个判空是为了防止许多线程抢锁导致性能的下降</p>
<p>第二个判空是为了防止多个线程进入该程序后没判空从而创建了多个对象</p>
<p>并发编程书推荐：《并发编程的艺术》，《并发编程之美》</p>
<h4 id="生成代码的代码实现"><a href="#生成代码的代码实现" class="headerlink" title="生成代码的代码实现"></a>生成代码的代码实现</h4><p>方法：</p>
<p>1.反射</p>
<p>​	应用场景:：java程序运行时，生成一些代码或者类，让它立刻会被java代码加载，结束后再释放掉</p>
<p>而代码生成的是java文件，它是要一直存在的，而不是临时用</p>
<p>2.用freemarker动态模板的方式生成</p>
<p>json与DataModel类的对应关系</p>
<p><img   src="/../image/Snipaste_2024-02-19_15-34-31.png"  alt="Snipaste_2024-02-19_15-34-31"></p>
<p>abbr的作用：命令的简称</p>
<p><img   src="/../image/Snipaste_2024-02-19_15-38-41.png"  alt="Snipaste_2024-02-19_15-38-41"></p>
<p>技巧：参数的多少需要你确认你要输入的json文件生成的类被哪些地方使用到了，这样才不会出现遗漏</p>
<p>如何查看一个类被其他类调用的情况</p>
<p>alt+f7或者右键找到findusages</p>
<p>复制model类的内容到templates文件的对应位置中</p>
<p>注意：先创建一个aaa文件，再复制内容，最后再把文件名改成DataModel.java.ftl（防止格式被打乱）</p>
<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public class MainGenerator &#123;</span><br><span class="line">    public static void main(String[] args) throws TemplateException, IOException &#123;</span><br><span class="line">        Meta meta = MetaManager.getMetaObject();</span><br><span class="line">        System.out.println(meta);</span><br><span class="line"></span><br><span class="line">        //输出的根路径</span><br><span class="line">        String projectPath = System.getProperty(&quot;user.dir&quot;);</span><br><span class="line">        String outputPath = projectPath + File.separator + &quot;generated&quot;;</span><br><span class="line">        if (!FileUtil.exist(outputPath))&#123;</span><br><span class="line">            FileUtil.mkdir(outputPath);</span><br><span class="line">        &#125;</span><br><span class="line">        //读取 resources目录</span><br><span class="line">        ClassPathResource classPathResource = new ClassPathResource(&quot;&quot;);</span><br><span class="line">        String inputResourcePath = classPathResource.getAbsolutePath();</span><br><span class="line"></span><br><span class="line">        //java包的基础路径</span><br><span class="line">        //com.yupi</span><br><span class="line">        String outputBasePackages = meta.getBasePackage();</span><br><span class="line">        //com/yupi</span><br><span class="line">        String outputBasePackagePath = StrUtil.join(&quot;/&quot;,StrUtil.split(outputBasePackages,&quot;.&quot;));</span><br><span class="line">        //完整路径 generated/src/main/java/com/yupi/xxx</span><br><span class="line">        String outputBaseJavaPackagePath = outputPath + File.separator +&quot;src/main/java/&quot;+outputBasePackagePath;</span><br><span class="line"></span><br><span class="line">        String inputFilePath;</span><br><span class="line">        String outputFilePath;</span><br><span class="line"></span><br><span class="line">        //templates下的model.DataModel</span><br><span class="line">        inputFilePath = inputResourcePath + File.separator +&quot;templates/java/model/DataModel.java.ftl&quot;;</span><br><span class="line">        outputFilePath = outputBaseJavaPackagePath + &quot;/model/DataModel.java&quot;;</span><br><span class="line">        DynamicFileGenerator.doGenerator(inputFilePath, outputFilePath, meta);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img   src="/../image/Snipaste_2024-02-19_16-20-59.png"  alt="Snipaste_2024-02-19_16-20-59"></p>
<p><img   src="/../image/Snipaste_2024-02-19_16-21-20.png"  alt="Snipaste_2024-02-19_16-21-20"></p>
<p>原因：ftl文件中modelInfo.defaultValue无法从Boolean类型转换成String类型</p>
<p>解决方法：在modelInfo.defaultValue后面加?c即可</p>
<p>结果</p>
<p><img   src="/../image/Snipaste_2024-02-19_16-25-43.png"  alt="Snipaste_2024-02-19_16-25-43"></p>
<h5 id="生成各种各样的命令类"><a href="#生成各种各样的命令类" class="headerlink" title="生成各种各样的命令类"></a>生成各种各样的命令类</h5><p>思考要生成哪些命令类</p>
<p>ConfigCommand、GenerateCommand、ListCommand、CommandExecutor子命令执行器</p>
<p>还有一个调用命令的主类</p>
<p>注意：listCommand下获取根路径的代码有所不同</p>
<p><img   src="/../image/Snipaste_2024-02-19_17-08-53.png"  alt="Snipaste_2024-02-19_17-08-53"></p>
<p>代码如下</p>
<p>ConfigCommand.java.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package $&#123;basePackage&#125;.cli.command;</span><br><span class="line"></span><br><span class="line">import cn.hutool.core.util.ReflectUtil;</span><br><span class="line">import $&#123;basePackage&#125;.model.DataModel;</span><br><span class="line">import picocli.CommandLine.Command;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line">@Command(name = &quot;config&quot;, mixinStandardHelpOptions = true)</span><br><span class="line">public class ConfigCommand implements Runnable&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        Field[] files = ReflectUtil.getFields(DataModel.class);</span><br><span class="line">        for (Field filed:files)&#123;</span><br><span class="line">            System.out.println(&quot;字段类型&quot;+filed.getType());</span><br><span class="line">            System.out.println(&quot;字段名称&quot;+filed.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GenerateCommand.java.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package $&#123;basePackage&#125;.cli.command;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import cn.hutool.core.bean.BeanUtil;</span><br><span class="line">import $&#123;basePackage&#125;.generator.file.FileGenerator;</span><br><span class="line">import $&#123;basePackage&#125;.model.DataModel;</span><br><span class="line">import lombok.Data;</span><br><span class="line">import picocli.CommandLine.Command;</span><br><span class="line">import picocli.CommandLine.Option;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.Callable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Command(name = &quot;generate&quot;, mixinStandardHelpOptions = true)</span><br><span class="line">@Data</span><br><span class="line">public class GenerateCommand implements Callable &#123;</span><br><span class="line"></span><br><span class="line">&lt;#list modelConfig.models as modelInfo&gt;</span><br><span class="line">    &lt;#if modelInfo.description??&gt;</span><br><span class="line">        /**</span><br><span class="line">        * $&#123;modelInfo.description&#125;</span><br><span class="line">        */</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">    @Option(names = &#123;&lt;#if modelInfo.abbr??&gt;&quot;-$&#123;modelInfo.abbr&#125;&quot;,&lt;/#if&gt; &quot;--$&#123;modelInfo.fieldName&#125;&quot;&#125;,&lt;#if modelInfo.description??&gt; description = &quot;$&#123;modelInfo.description&#125;&quot;,&lt;/#if&gt; arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">    private $&#123;modelInfo.type&#125; $&#123;modelInfo.fieldName&#125; &lt;#if modelInfo.defaultValue??&gt; = $&#123;modelInfo.defaultValue?c&#125;&lt;/#if&gt; ;</span><br><span class="line">&lt;/#list &gt;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Integer call() throws Exception &#123;</span><br><span class="line">        //把传递的参数给动态模板配置</span><br><span class="line">        DataModel dataModel = new DataModel();</span><br><span class="line">        //把对象的名称属性都复制到动态模板，这个copyProperties适用于传递过来的参数和要发送的对象都一模一样时使用,从this传过来，传递到mainTemplateConfig对象</span><br><span class="line">        BeanUtil.copyProperties(this, dataModel);</span><br><span class="line">        FileGenerator.doGenerate(dataModel);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ListCommand.java.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package $&#123;basePackage&#125;.cli.command;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import cn.hutool.core.io.FileUtil;</span><br><span class="line">import picocli.CommandLine.Command;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Command(name = &quot;list&quot;, mixinStandardHelpOptions = true)</span><br><span class="line">public class ListCommand implements Runnable&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public  void run() &#123;</span><br><span class="line"></span><br><span class="line">        //输入路径</span><br><span class="line">        String inputPath = &quot;$&#123;fileConfig.inputRootPath&#125;&quot;;</span><br><span class="line">        //遍历获取所有的文件</span><br><span class="line">        List&lt;File&gt; files = FileUtil.loopFiles(inputPath);</span><br><span class="line"></span><br><span class="line">        for (File file: files)&#123;</span><br><span class="line">            System.out.println(file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CommandExecutor.java.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package $&#123;basePackage&#125;.cli;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import $&#123;basePackage&#125;.cli.command.ConfigCommand;</span><br><span class="line">import $&#123;basePackage&#125;r.cli.command.GenerateCommand;</span><br><span class="line">import $&#123;basePackage&#125;.cli.command.ListCommand;</span><br><span class="line">import picocli.CommandLine;</span><br><span class="line">import picocli.CommandLine.Command;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Command(name = &quot;$&#123;name&#125;&quot;, mixinStandardHelpOptions = true)</span><br><span class="line">public class CommandExecutor implements Runnable&#123;</span><br><span class="line"></span><br><span class="line">    private final CommandLine commandLine;</span><br><span class="line"></span><br><span class="line">    //这个Command类的主命令就是执行器，就是调用者</span><br><span class="line">    //放代码块里初始化的原因：因为执行多少次命令，commandLine 绑定的对象都是一样的，这样做节省程序的开销</span><br><span class="line">    &#123;</span><br><span class="line">        commandLine = new CommandLine(this)</span><br><span class="line">                .addSubcommand(new GenerateCommand())</span><br><span class="line">                .addSubcommand(new ConfigCommand())</span><br><span class="line">                .addSubcommand(new ListCommand());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        //不输入子命令时，给出友好提示</span><br><span class="line">        System.out.println(&quot;请输入具体命令，或者输入 --help 查看命令提示&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 执行命令</span><br><span class="line">     *</span><br><span class="line">     * @param args</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public Integer doExecute(String[] args)&#123;</span><br><span class="line">        return commandLine.execute(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Main.java.ftl(主执行类)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package $&#123;basePackage&#125;.maker;</span><br><span class="line"></span><br><span class="line">import $&#123;basePackage&#125;.maker.cli.CommandExecutor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        CommandExecutor commandExecutor = new CommandExecutor();</span><br><span class="line">        commandExecutor.doExecute(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在mainGenerator类下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//templates下的cli.command.GenerateCommand</span><br><span class="line">inputFilePath = inputResourcePath + File.separator +&quot;templates/java/cli/command/GenerateCommand.java.ftl&quot;;</span><br><span class="line">outputFilePath = outputBaseJavaPackagePath + &quot;/cli/command/GenerateCommand.java&quot;;</span><br><span class="line">DynamicFileGenerator.doGenerator(inputFilePath, outputFilePath, meta);</span><br><span class="line"></span><br><span class="line">//templates下的cli.command.ConfigCommand</span><br><span class="line">inputFilePath = inputResourcePath + File.separator +&quot;templates/java/cli/command/ConfigCommand.java.ftl&quot;;</span><br><span class="line">outputFilePath = outputBaseJavaPackagePath + &quot;/cli/command/ConfigCommand.java&quot;;</span><br><span class="line">DynamicFileGenerator.doGenerator(inputFilePath, outputFilePath, meta);</span><br><span class="line"></span><br><span class="line">//templates下的cli.command.ListCommand</span><br><span class="line">inputFilePath = inputResourcePath + File.separator +&quot;templates/java/cli/command/ListCommand.java.ftl&quot;;</span><br><span class="line">outputFilePath = outputBaseJavaPackagePath + &quot;/cli/command/ListCommand.java&quot;;</span><br><span class="line">DynamicFileGenerator.doGenerator(inputFilePath, outputFilePath, meta);</span><br><span class="line"></span><br><span class="line">//templates下的cli.CommandExecutor</span><br><span class="line">inputFilePath = inputResourcePath + File.separator +&quot;templates/java/cli/CommandExecutor.java.ftl&quot;;</span><br><span class="line">outputFilePath = outputBaseJavaPackagePath + &quot;/cli/CommandExecutor.java&quot;;</span><br><span class="line">DynamicFileGenerator.doGenerator(inputFilePath, outputFilePath, meta);</span><br><span class="line"></span><br><span class="line">//templates下的Main</span><br><span class="line">inputFilePath = inputResourcePath + File.separator +&quot;templates/java/Main.java.ftl&quot;;</span><br><span class="line">outputFilePath = outputBaseJavaPackagePath + &quot;/Main.java&quot;;</span><br><span class="line">DynamicFileGenerator.doGenerator(inputFilePath, outputFilePath, meta);</span><br></pre></td></tr></table></figure>



<h5 id="生成代码的模板文件"><a href="#生成代码的模板文件" class="headerlink" title="生成代码的模板文件"></a>生成代码的模板文件</h5><p>1.修改basic目录下MainGenerator中的doGenerator写死的代码（路径）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public static void doGenerate(Object model) throws TemplateException, IOException &#123;</span><br><span class="line"></span><br><span class="line">    //动态文件配置</span><br><span class="line">    //绝对路径</span><br><span class="line">    String inputRootPath = &quot;E:\\work\\project\\code-generator\\code-generator-demo-projects\\acm-template-pro&quot;;</span><br><span class="line">    String outputRootPath = &quot;E:\\work\\project\\code-generator&quot;;</span><br><span class="line"></span><br><span class="line">    //相对路径</span><br><span class="line">    String inputPath;</span><br><span class="line">    String outputPath;</span><br><span class="line"></span><br><span class="line">    inputPath = new File(inputRootPath,&quot;src/com/yupi/acm/MainTemplate.java.ftl&quot;).getAbsolutePath();</span><br><span class="line">    outputPath = new File(outputRootPath,&quot;src/com/yupi/acm/MainTemplate.java&quot;).getAbsolutePath();</span><br><span class="line">    DynamicGenerator.doGenerator(inputPath,outputPath,model);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //动态文件生成</span><br><span class="line">    String inputPath = new File(inputRootPath,&quot;.gitignore&quot;).getAbsolutePath();</span><br><span class="line">    String outputPath = new File(outputRootPath,&quot;.gitignore&quot;).getAbsolutePath();</span><br><span class="line">    StaticGenerator.copyFileByHutool(inputPath,outputPath);</span><br><span class="line"></span><br><span class="line">    //静态文件生成</span><br><span class="line">    String inputPath = new File(inputRootPath, &quot;README.md&quot;).getAbsolutePath();</span><br><span class="line">    String outputPath = new File(outputRootPath,&quot;README.md&quot;).getAbsolutePath();</span><br><span class="line">    StaticGenerator.copyFileByHutool(inputPath,outputPath);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.复制代码带maker&#x2F;templates&#x2F;generator,并修改代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">package $&#123;basePackage&#125;.generator.file;</span><br><span class="line"></span><br><span class="line">import cn.hutool.core.io.FileUtil;</span><br><span class="line">import freemarker.template.Configuration;</span><br><span class="line">import freemarker.template.Template;</span><br><span class="line">import freemarker.template.TemplateException;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileWriter;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.Writer;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 动态文件生成器</span><br><span class="line"> */</span><br><span class="line">public class DynamicGenerator &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 生成文件</span><br><span class="line">     *</span><br><span class="line">     * @param inputPath 模板文件输入路径</span><br><span class="line">     * @param outputPath 输出路径</span><br><span class="line">     * @param model 数据模型</span><br><span class="line">     * @throws IOException</span><br><span class="line">     * @throws TemplateException</span><br><span class="line">     */</span><br><span class="line">    public static void doGenerator(String inputPath, String outputPath, Object model)throws IOException, TemplateException&#123;</span><br><span class="line">        //new出Configeration对象，参数为Freemarker版本号</span><br><span class="line">        Configuration configuration = new Configuration(Configuration.VERSION_2_3_32);</span><br><span class="line"></span><br><span class="line">        //获取实际模板所在文件的父目录（这样就不用写死了）</span><br><span class="line">        File templateDir = new File(inputPath).getParentFile();</span><br><span class="line">        configuration.setDirectoryForTemplateLoading(templateDir);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //设置模板文件的字符集</span><br><span class="line">        configuration.setDefaultEncoding(&quot;UTF-8&quot;);</span><br><span class="line"></span><br><span class="line">        //解决本地化敏感 例如2,023-&gt;2023</span><br><span class="line">        configuration.setNumberFormat(&quot;0.######&quot;);</span><br><span class="line"></span><br><span class="line">        //获取模板名称，创建模板对象，加载指定模板</span><br><span class="line">        String templateName = new File(inputPath).getName();</span><br><span class="line">        Template template = configuration.getTemplate(templateName);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //如果文件目录不存在则创建目录</span><br><span class="line">        if (!FileUtil.exist(outputPath))&#123;</span><br><span class="line">            FileUtil.touch(outputPath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //指定生成文件</span><br><span class="line">        Writer out = new FileWriter(outputPath);</span><br><span class="line"></span><br><span class="line">        //调用模板对象的生成文件</span><br><span class="line">        template.process(model,out);</span><br><span class="line">        //生成后关闭</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package $&#123;basePackage&#125;.generator;</span><br><span class="line"></span><br><span class="line">import $&#123;basePackage&#125;.model.MainTemplateConfig;</span><br><span class="line">import freemarker.template.TemplateException;</span><br><span class="line">import picocli.CommandLine;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 核心生成器</span><br><span class="line"> */</span><br><span class="line">public class MainGenerator &#123;</span><br><span class="line"></span><br><span class="line">    public static void doGenerate(Object model) throws TemplateException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        //动态文件配置</span><br><span class="line">        //绝对路径</span><br><span class="line">        String inputRootPath = &quot;$&#123;fileConfig.inputRootPath&#125;&quot;;</span><br><span class="line">        String outputRootPath = &quot;$&#123;fileConfig.outputRootPath&#125;&quot;;</span><br><span class="line"></span><br><span class="line">        //相对路径</span><br><span class="line">        String inputPath;</span><br><span class="line">        String outputPath;</span><br><span class="line"></span><br><span class="line">&lt;#list fileConfig.files as fileInfo&gt;</span><br><span class="line">        inputPath = new File(inputRootPath,&quot;$&#123;fileInfo.inputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">        outputPath = new File(outputRootPath,&quot;$&#123;fileInfo.outputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">    &lt;#if fileInfo.generateType == &quot;static&quot;&gt;</span><br><span class="line">        StaticGenerator.copyFileByHutool(inputPath,outputPath);</span><br><span class="line">    &lt;#else &gt;</span><br><span class="line">        DynamicGenerator.doGenerator(inputPath,outputPath,model);</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line"></span><br><span class="line">&lt;/#list&gt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package $&#123;basePackage&#125;.generator.file;</span><br><span class="line"></span><br><span class="line">import cn.hutool.core.io.FileUtil;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 静态文件生成器</span><br><span class="line"> */</span><br><span class="line">public class StaticFileGenerator &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 拷贝文件</span><br><span class="line">     * @param inputPath 输入路径</span><br><span class="line">     * @param outputPath 输出路径</span><br><span class="line">     */</span><br><span class="line">    public static void copyFileByHutool(String inputPath, String outputPath) &#123;</span><br><span class="line">        FileUtil.copy(inputPath, outputPath, true);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在mainGenerator类下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//templates下的generator.DynamicGenerator</span><br><span class="line">inputFilePath = inputResourcePath + File.separator +&quot;templates/java/generator/DynamicGenerator.java.ftl&quot;;</span><br><span class="line">outputFilePath = outputBaseJavaPackagePath + &quot;/generator/DynamicGenerator.java&quot;;</span><br><span class="line">DynamicFileGenerator.doGenerator(inputFilePath, outputFilePath, meta);</span><br><span class="line"></span><br><span class="line">//templates下的generator.MainGenerator</span><br><span class="line">inputFilePath = inputResourcePath + File.separator +&quot;templates/java/generator/MainGenerator.java.ftl&quot;;</span><br><span class="line">outputFilePath = outputBaseJavaPackagePath + &quot;/generator/MainGenerator.java&quot;;</span><br><span class="line">DynamicFileGenerator.doGenerator(inputFilePath, outputFilePath, meta);</span><br><span class="line"></span><br><span class="line">//templates下的generator.StaticGenerator</span><br><span class="line">inputFilePath = inputResourcePath + File.separator +&quot;templates/java/generator/StaticGenerator.java.ftl&quot;;</span><br><span class="line">outputFilePath = outputBaseJavaPackagePath + &quot;/generator/StaticGenerator.java&quot;;</span><br><span class="line">DynamicFileGenerator.doGenerator(inputFilePath, outputFilePath, meta);</span><br></pre></td></tr></table></figure>

<h4 id="利用程序构建jar包"><a href="#利用程序构建jar包" class="headerlink" title="利用程序构建jar包"></a>利用程序构建jar包</h4><p>首先本地得有maven：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45344586/article/details/130935169" >https://blog.csdn.net/qq_45344586/article/details/130935169<i class="fas fa-external-link-alt"></i></a></p>
<p>写配置类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public class JarGenerator &#123;</span><br><span class="line"></span><br><span class="line">    public static void doGenerate(String projectDir) throws IOException, InterruptedException &#123;</span><br><span class="line">        //调用 Process 类执行Maven 打包命令</span><br><span class="line">        //先执行clean清除缓存，再打包</span><br><span class="line">        // -DiskTests=true:跳过所有的测试用例，打包更快</span><br><span class="line">        //不同操作系统的命令是不一样的</span><br><span class="line"></span><br><span class="line">        String winMavenCommand = &quot;mvn.cmd clean package -DiskTests=true&quot;;</span><br><span class="line">        String otherMavenCommand = &quot;mvn clean package -DiskTests=true&quot;;</span><br><span class="line">        String mavenCommand = winMavenCommand;</span><br><span class="line"></span><br><span class="line">        //为命令选择执行的路径，在项目所在的路径打jar包</span><br><span class="line">        //maven要按空格拆（命令本身也是按空格来区分参数）</span><br><span class="line">        ProcessBuilder processBuilder = new ProcessBuilder(mavenCommand.split(&quot; &quot;));</span><br><span class="line">        processBuilder.directory(new File(projectDir));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //相当于打开终端执行命令行工具</span><br><span class="line">        Process process = processBuilder.start();</span><br><span class="line"></span><br><span class="line">        //读取命令的输出</span><br><span class="line">        //读取输入流</span><br><span class="line">        InputStream inputStream = process.getInputStream();</span><br><span class="line">        //根据输入流去读取缓冲区读取器</span><br><span class="line">        BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream));</span><br><span class="line">        //利用for循环读取缓冲区的每一行</span><br><span class="line">        String line;</span><br><span class="line">        while ((line = bufferedReader.readLine())!= null)&#123;</span><br><span class="line">            System.out.println(line);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int exitCode = process.waitFor();</span><br><span class="line">        System.out.println(&quot;命令执行结束，退出码：&quot;+ exitCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用jar包生成器</p>
<h4 id="pom-xml文件生成"><a href="#pom-xml文件生成" class="headerlink" title="pom.xml文件生成"></a>pom.xml文件生成</h4><p>动态生成</p>
<p>pom.xml.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;$&#123;basePackage&#125;&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;$&#123;name&#125;&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- https://mvnrepository.com/artifact/cn.hutool/hutool-all --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;cn.hutool&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;hutool-all&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.8.16&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-collections4 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.4&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.18.30&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.13.2&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https://mvnrepository.com/artifact/org.freemarker/freemarker --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.freemarker&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;freemarker&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.3.32&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https://picocli.info/ --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;info.picocli&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;picocli&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.7.5&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.3.0&lt;/version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;descriptorRefs&gt;</span><br><span class="line">                        &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class="line">                    &lt;/descriptorRefs&gt;</span><br><span class="line">                    &lt;archive&gt;</span><br><span class="line">                        &lt;manifest&gt;</span><br><span class="line">                            &lt;mainClass&gt;$&#123;basePackage&#125;.Main&lt;/mainClass&gt; &lt;!-- 替换为你的主类的完整类名 --&gt;</span><br><span class="line">                        &lt;/manifest&gt;</span><br><span class="line">                    &lt;/archive&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;single&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>在mainGenerator类下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//templates下的pom.xml</span><br><span class="line">inputFilePath = inputResourcePath + File.separator +&quot;templates/pom.xml.ftl&quot;;</span><br><span class="line">outputFilePath = outputBaseJavaPackagePath + &quot;pom.xml&quot;;</span><br><span class="line">DynamicFileGenerator.doGenerator(inputFilePath, outputFilePath, meta);</span><br></pre></td></tr></table></figure>



<p>tips：最好从basic项目里复制代码</p>
<h4 id="封装程序脚本-缩短输入命令的长度"><a href="#封装程序脚本-缩短输入命令的长度" class="headerlink" title="封装程序脚本(缩短输入命令的长度)"></a>封装程序脚本(缩短输入命令的长度)</h4><p>不用freemarker生成，而是直接用字符串拼接</p>
<p>创建ScriptGenerator.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public class ScriptGenerator &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *</span><br><span class="line">     * @param outputPath 脚本文件的输出路径（调用方指定，根据配置文件输出）</span><br><span class="line">     * @param jarPath jar包路径，没办法写死，根据外层配置文件读取</span><br><span class="line">     */</span><br><span class="line">    public static void doGenerate(String outputPath ,String jarPath )&#123;</span><br><span class="line">        //Linux脚本</span><br><span class="line">        StringBuilder sb =new StringBuilder();</span><br><span class="line">        //#!/bin/bash</span><br><span class="line">        //java -jar target/code-generator-basic-1.0-SNAPSHOT-jar-with-dependencies.jar &quot;$@&quot;</span><br><span class="line">        //拼接字符串</span><br><span class="line">        sb.append(&quot;#!/bin/bash&quot;).append(&quot;\n&quot;);</span><br><span class="line">        sb.append(String.format(&quot;java -jar %s \&quot;$@\&quot;&quot;, jarPath)).append(&quot;\n&quot;);</span><br><span class="line">        //写入到输出路径的文件</span><br><span class="line">        FileUtil.writeBytes(sb.toString().getBytes(StandardCharsets.UTF_8),outputPath);</span><br><span class="line">        //linux默认是没有可执行权限，所有需要添加可执行权限</span><br><span class="line">        //用try-cache而不直接抛出去是为了防止windows执行不报错</span><br><span class="line">        try &#123;</span><br><span class="line">            Set&lt;PosixFilePermission&gt; permissions = PosixFilePermissions.fromString(&quot;rmxrmxrmx&quot;);</span><br><span class="line">            Files.setPosixFilePermissions(Paths.get(outputPath),permissions);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //windows脚本</span><br><span class="line">        sb = new StringBuilder();</span><br><span class="line">        // @echo off</span><br><span class="line">        //java -jar target/code-generator-basic-1.0-SNAPSHOT-jar-with-dependencies.jar %*</span><br><span class="line">        sb.append(&quot;@echo off&quot;).append(&quot;\n&quot;);</span><br><span class="line">        //%表示转义</span><br><span class="line">        sb.append(String.format(&quot;java -jar %s %%*&quot;, jarPath)).append(&quot;\n&quot;);</span><br><span class="line">        FileUtil.writeBytes(sb.toString().getBytes(StandardCharsets.UTF_8),outputPath  +&quot;.bat&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MainGenerator调用脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//封装脚本</span><br><span class="line">//脚本输出路径</span><br><span class="line">String shellOutputFilePath = outputPath + File.separator + &quot;generator&quot;;</span><br><span class="line">//脚本名称</span><br><span class="line">String jarName = String.format(&quot;%s-%s-jar-with-dependencies.jar&quot;,meta.getName(),meta.getVersion());</span><br><span class="line">//脚本生成路径</span><br><span class="line">String jarPath = &quot;target/&quot; + jarName;</span><br><span class="line">ScriptGenerator.doGenerate(shellOutputFilePath,jarPath);</span><br></pre></td></tr></table></figure>

<p>为什么”target&#x2F;“这里用&#x2F;？因为File.separator用的地方是前面是绝对路径后面是相对路径</p>
<p>执行到最后，发现list无法使用</p>
<p>解决方法：修改meta.json中的输入路径即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;inputRootPath&quot;: &quot;E:/work/project/code-generator/code-generator-demo-projects/acm-template-pro&quot;,</span><br></pre></td></tr></table></figure>





<h3 id="2-优化"><a href="#2-优化" class="headerlink" title="2.优化"></a>2.优化</h3><h4 id="可移植性优化"><a href="#可移植性优化" class="headerlink" title="可移植性优化"></a>可移植性优化</h4><p>现在项目是不具备可移植性，就是这个项目依赖的模板文件（acm-template-pro）要通过绝对路径去找</p>
<p>实现思路：先根据生成模板代码的方式，生成.source文件，里面存的是指向依赖的代码模板的相对路径</p>
<p>实现步骤</p>
<p>1.修改meta.json下的输入路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;inputRootPath&quot;: &quot;.source/acm-template-pro&quot;,</span><br></pre></td></tr></table></figure>

<p>2.新建sourceRootPath字段：让代码生成器知道原始的代码生成文件在哪里，存储用户原始的没有修改的原始模板文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;sourceRootPath&quot;: &quot;E:/work/project/code-generator/code-generator-demo-projects/acm-template-pro&quot;,</span><br></pre></td></tr></table></figure>

<p>3.meta.java的FileConfig方法中增加相应字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private String sourceRootPath;</span><br></pre></td></tr></table></figure>

<p>4.在MainGenerator实现文件的复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//从原始模板文件路径复制到生成的代码包中</span><br><span class="line">        String sourceRootPath = meta.getFileConfig().getSourceRootPath();</span><br><span class="line">        String sourceCopyDestPath = outputPath + File.separator + &quot;./source&quot;;</span><br><span class="line">        FileUtil.copy(sourceRootPath,sourceCopyDestPath,false);</span><br></pre></td></tr></table></figure>



<p>bug：目标acm模板代码没有生成</p>
<p>解决：GenerateCommand的ftl文件忘了执行生成代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Integer call() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    DataModel dataModel = new DataModel();</span><br><span class="line">    BeanUtil.copyProperties(this, dataModel);</span><br><span class="line">    MainGenerator.doGenerate(dataModel);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="系统的功能优化"><a href="#系统的功能优化" class="headerlink" title="系统的功能优化"></a>系统的功能优化</h4><h5 id="自动生成README-md"><a href="#自动生成README-md" class="headerlink" title="自动生成README.md"></a>自动生成README.md</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">//生成README.md项目文件</span><br><span class="line">inputFilePath = inputResourcePath + File.separator + &quot;templates/README.md.ftl&quot;;</span><br><span class="line">outputFilePath = outputPath + File.separator + &quot;README.md&quot;;</span><br><span class="line">System.out.println(outputFilePath);</span><br><span class="line">DynamicFileGenerator.doGenerator(inputFilePath, outputFilePath, meta);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># $&#123;name&#125;</span><br><span class="line"></span><br><span class="line">&gt; $&#123;description&#125;</span><br><span class="line">&gt;</span><br><span class="line">&gt; 作者：$&#123;author&#125;</span><br><span class="line">&gt;</span><br><span class="line">&gt; 基于 [程序员鱼皮](https://yuyuanweb.feishu.cn/wiki/Abldw5WkjidySxkKxU2cQdAtnah) 的 [鱼籽代码生成器项目](https://github.com/liyupi/yuzi-generator) 制作，感谢您的使用！</span><br><span class="line"></span><br><span class="line">可以通过命令行交互式输入的方式动态生成想要的项目代码</span><br><span class="line"></span><br><span class="line">## 使用说明</span><br><span class="line"></span><br><span class="line">执行项目根目录下的脚本文件：</span><br><span class="line"></span><br><span class="line">```</span><br><span class="line">generator &lt;命令&gt; &lt;选项参数&gt;</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">示例命令：</span><br><span class="line"></span><br><span class="line">```</span><br><span class="line">generator generate &lt;#list modelConfig.models as modelInfo&gt;-$&#123;modelInfo.abbr&#125; &lt;/#list&gt;</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">## 参数说明</span><br><span class="line"></span><br><span class="line">&lt;#list modelConfig.models as modelInfo&gt;</span><br><span class="line">$&#123;modelInfo?index + 1&#125;）$&#123;modelInfo.fieldName&#125;</span><br><span class="line"></span><br><span class="line">类型：$&#123;modelInfo.type&#125;</span><br><span class="line"></span><br><span class="line">描述：$&#123;modelInfo.description&#125;</span><br><span class="line"></span><br><span class="line">默认值：$&#123;modelInfo.defaultValue?c&#125;</span><br><span class="line"></span><br><span class="line">缩写： -$&#123;modelInfo.abbr&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/#list&gt;</span><br></pre></td></tr></table></figure>



<h4 id="空间优化"><a href="#空间优化" class="headerlink" title="空间优化"></a>空间优化</h4><h5 id="存储空间优化"><a href="#存储空间优化" class="headerlink" title="存储空间优化"></a>存储空间优化</h5><p>复制生成的代码，删除多余的不必要的文件，只保留运行所必须的</p>
<p>方式</p>
<p>1.复制生成的项目，然后删除多余的（x）</p>
<p>2.生成目录，把原有的需要的文件复制过去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//生成精简版的程序（产物包）-运行必须要用的</span><br><span class="line">String distOutputPath = outputPath + &quot;-dist&quot;;</span><br><span class="line">//拷贝jar包</span><br><span class="line">String targetAbsolutePath = distOutputPath + File.separator + &quot;target&quot;;</span><br><span class="line">FileUtil.mkdir(targetAbsolutePath);</span><br><span class="line">String jarAbsolutePath = outputPath + File.separator + jarPath;</span><br><span class="line">FileUtil.copy(jarAbsolutePath, targetAbsolutePath, true);</span><br><span class="line"></span><br><span class="line">//拷贝脚本文件</span><br><span class="line">FileUtil.copy(shellOutputFilePath, distOutputPath, true);</span><br><span class="line">FileUtil.copy(shellOutputFilePath + &quot;.bat&quot;, distOutputPath, true);</span><br><span class="line"></span><br><span class="line">//拷贝源模板文件</span><br><span class="line">FileUtil.copy(sourceCopyDestPath,distOutputPath,true);</span><br></pre></td></tr></table></figure>

<p>todo：git托管</p>
<h4 id="健壮性"><a href="#健壮性" class="headerlink" title="健壮性"></a>健壮性</h4><p>程序在不同条件下能否稳定运行</p>
<p>1.用户的各种不同的输入,传参请求,并能处理一些异常情况</p>
<p>​	输入校验</p>
<p>2.异常处理try-catch</p>
<p>3.系统出故障后的自恢复能力</p>
<p>​	定时任务（例如去查数据库或者告警）</p>
<p>4.自动重试（第三方调用），加阈值（重试次数）</p>
<p>5.降级：参数输入失败或者不输入这个参数，可以用一个默认的参数继续去跑这个项目，保证系统不会挂的太惨，能够继续处理请求</p>
<p>这个项目最大的问题：meta.json文件的值可能会出现错误</p>
<p>思考：怎么对配置文件进行校验</p>
<p>1.校验用户输入是否合法</p>
<p>2.用户如果没有输入，那么就要给他添加默认值，让用户不需要写这么一大段文件</p>
<h5 id="通过源信息校验和默认值填充来提高系统的健壮性"><a href="#通过源信息校验和默认值填充来提高系统的健壮性" class="headerlink" title="通过源信息校验和默认值填充来提高系统的健壮性"></a>通过源信息校验和默认值填充来提高系统的健壮性</h5><p>本质上跟设计数据库表一致</p>
<p>1.先梳理一下meta.json里的值哪些是必填项，哪些是默认值</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>默认值</th>
<th>校验规则</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>my-generator</td>
<td></td>
</tr>
<tr>
<td>description</td>
<td>我的模板代码生成器</td>
<td></td>
</tr>
<tr>
<td>basePackage</td>
<td>com.yupi</td>
<td></td>
</tr>
<tr>
<td>version</td>
<td>1.0</td>
<td></td>
</tr>
<tr>
<td>author</td>
<td>zlz</td>
<td></td>
</tr>
<tr>
<td>createTime</td>
<td>当前日期</td>
<td></td>
</tr>
<tr>
<td>fileConfig.sourceRootPath</td>
<td></td>
<td>必填</td>
</tr>
<tr>
<td>fileConfig.inputRootPath</td>
<td>source+sourceRootPath的最后一个层级路径</td>
<td></td>
</tr>
<tr>
<td>fileConfig.outputRootPath</td>
<td>当前路径下的generated</td>
<td></td>
</tr>
<tr>
<td>fileConfig.type</td>
<td>dir</td>
<td></td>
</tr>
<tr>
<td>fileConfig.files.inputPath</td>
<td></td>
<td>必填</td>
</tr>
<tr>
<td>fileConfig.files.outputPath</td>
<td></td>
<td></td>
</tr>
<tr>
<td>fileConfig.files.type</td>
<td>inputPath有文件后缀(如.java)为file,否则为dir</td>
<td></td>
</tr>
<tr>
<td>fileConfig.files.generateType</td>
<td>如果文件结尾不为.ftl，generateType默认为static,否则为dynamic</td>
<td></td>
</tr>
<tr>
<td>modelConfig.models.fieldName</td>
<td></td>
<td>必填</td>
</tr>
<tr>
<td>modelConfig.models.type</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>modelConfig.models.description</td>
<td></td>
<td></td>
</tr>
<tr>
<td>modelConfig.models.defaultValue</td>
<td></td>
<td></td>
</tr>
<tr>
<td>modelConfig.models.abbr</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>2.自定义异常类</p>
<p>3.校验</p>
<p>iter：增强for循环</p>
<p>代码圈复杂度：量化，便于评估代码复杂度的软件工程术语（大厂最好小于10，如果多的话就有可能被打回去重改）</p>
<p>使用的工具：MetricsReloaded</p>
<p>使用：在类上右键有analyze-&gt;Calculate Metrics（分析圈复杂度）-&gt;直接用默认的即可-&gt;CogC是圈复杂度指标</p>
<p><img   src="/../image/Snipaste_2024-02-20_22-40-44.png"  alt="Snipaste_2024-02-20_22-40-44"></p>
<p>思考如何优化？</p>
<p>​	1.根据业务逻辑分成三个方法（抽出3个代码块）</p>
<p>​		选中要抽出的代码右键refactor-&gt;extract…抽取代码</p>
<p><img   src="/../image/Snipaste_2024-02-20_22-53-29.png"  alt="Snipaste_2024-02-20_22-53-29"></p>
<p>​	2.校验结果能尽早返回的尽早返回，减少一层嵌套（卫引聚）</p>
<p>​	在进入主流程代码之前先做一层校验，保证进入程序的代码是合法的</p>
<p>​	操作：在判断语句的不等或等于符号上按alt+enter -&gt;选择invert if condition</p>
<p>​	作用：把if的嵌套for循环-&gt;if后再for循环</p>
<p><img   src="/../image/Snipaste_2024-02-20_23-01-24.png"  alt="Snipaste_2024-02-20_23-01-24"></p>
<p><img   src="/../image/Snipaste_2024-02-20_23-01-34.png"  alt="Snipaste_2024-02-20_23-01-34"></p>
<p>3.使用工具类来减少判断的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String name = meta.getName();</span><br><span class="line">if (StrUtil.isBlank(name)) &#123;</span><br><span class="line">    name = &quot;my-generator&quot;;</span><br><span class="line">    meta.setName(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String name = StrUtil.blankToDefault(meta.getName(),&quot;my-generator&quot;);</span><br><span class="line">meta.setName(name);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private static void validAndFillMetaRoot(Meta meta) &#123;</span><br><span class="line">    //基础信息校验和默认值</span><br><span class="line">    String name = StrUtil.blankToDefault(meta.getName(),&quot;my-generator&quot;);</span><br><span class="line">    meta.setName(name);</span><br><span class="line"></span><br><span class="line">    String description = StrUtil.emptyToDefault(meta.getDescription(),&quot;我的模板代码生成器&quot;);</span><br><span class="line">    meta.setDescription(description);</span><br><span class="line"></span><br><span class="line">    String basePackage = StrUtil.blankToDefault(meta.getBasePackage(), &quot;com.yupi&quot;);</span><br><span class="line">    meta.setBasePackage(basePackage);</span><br><span class="line"></span><br><span class="line">    String version = StrUtil.emptyToDefault(meta.getVersion(), &quot;1.0&quot;);</span><br><span class="line">    meta.setVersion(version);</span><br><span class="line"></span><br><span class="line">    String author = StrUtil.emptyToDefault(meta.getAuthor(), &quot;zlz&quot;);</span><br><span class="line">    meta.setAuthor(author);</span><br><span class="line"></span><br><span class="line">    String createTime = StrUtil.emptyToDefault(meta.getCreateTime(), DateUtil.now());</span><br><span class="line">    meta.setCreateTime(createTime);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>校验的完整代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 校验元信息</span><br><span class="line"> */</span><br><span class="line">public class MetaValidator &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 校验和默认值填充</span><br><span class="line">     *</span><br><span class="line">     * @param meta 元信息文件</span><br><span class="line">     */</span><br><span class="line">    public static void doValidAndFill(Meta meta) &#123;</span><br><span class="line"></span><br><span class="line">        validAndFillMetaRoot(meta);</span><br><span class="line"></span><br><span class="line">        validAndFillFileConfig(meta);</span><br><span class="line"></span><br><span class="line">        validAndFillModelConfig(meta);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void validAndFillModelConfig(Meta meta) &#123;</span><br><span class="line">        //modelConfig校验和默认值</span><br><span class="line">        ModelConfig modelConfig = meta.getModelConfig();</span><br><span class="line">        if (modelConfig == null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;ModelConfig.ModelsInfo&gt; modelInfoList = modelConfig.getModels();</span><br><span class="line">        if (CollUtil.isEmpty(modelInfoList)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        for (ModelConfig.ModelsInfo modelInfo : modelInfoList) &#123;</span><br><span class="line">            String fieldName = modelInfo.getFieldName();</span><br><span class="line">            if (StrUtil.isBlank(fieldName)) &#123;</span><br><span class="line">                throw new MetaException(&quot;未填写fileName&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String modelInfoType = modelInfo.getType();</span><br><span class="line">            if (StrUtil.isEmpty(modelInfoType)) &#123;</span><br><span class="line">                modelInfo.setType(&quot;String&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void validAndFillFileConfig(Meta meta) &#123;</span><br><span class="line">        //fileConfig校验和默认值</span><br><span class="line">        FileConfig fileConfig = meta.getFileConfig();</span><br><span class="line">        if (fileConfig == null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //sourceRootPath必填</span><br><span class="line">        String sourceRootPath = fileConfig.getSourceRootPath();</span><br><span class="line">        if (StrUtil.isBlank(sourceRootPath)) &#123;</span><br><span class="line">            throw new MetaException(&quot;未填写 sourceRootPath&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //inputRootPath: .source + sourceRootPath 的最后一个层级路径</span><br><span class="line">        //todo 对不同系统的路径符号做判断</span><br><span class="line">        String inputRootPath = fileConfig.getInputRootPath();</span><br><span class="line">        String defaultInputRootPath = &quot;source/&quot; +</span><br><span class="line">               FileUtil.getLastPathEle(Paths.get(sourceRootPath)).getFileName().toString();</span><br><span class="line">        //如果输入路径为空则给他自动天机最后一层路径</span><br><span class="line">        if (StrUtil.isEmpty(inputRootPath)) &#123;</span><br><span class="line">            fileConfig.setInputRootPath(defaultInputRootPath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //outputRootPath默认为当前路径下的generated路径</span><br><span class="line">        String outputRootPath = fileConfig.getOutputRootPath();</span><br><span class="line">        String defaultOutputRootPath = &quot;generated&quot;;</span><br><span class="line">        if (StrUtil.isEmpty(outputRootPath)) &#123;</span><br><span class="line">            fileConfig.setOutputRootPath(defaultOutputRootPath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String fileConfigType = fileConfig.getType();</span><br><span class="line">        String defaultType = &quot;dir&quot;;</span><br><span class="line">        if (StrUtil.isEmpty(fileConfigType)) &#123;</span><br><span class="line">            fileConfig.setType(defaultType);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;FileConfig.FileInfo&gt; fileInfoList = fileConfig.getFiles();</span><br><span class="line">        if (!CollUtil.isEmpty(fileInfoList)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        for (FileConfig.FileInfo fileInfo : fileInfoList) &#123;</span><br><span class="line"></span><br><span class="line">            //inputPath: 必填</span><br><span class="line">            String inputPath = fileInfo.getInputPath();</span><br><span class="line">            if (StrUtil.isBlank(inputPath)) &#123;</span><br><span class="line">                throw new MetaException(&quot;未填写 inputPath&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            // outputPath:默认等于inputPath</span><br><span class="line">            String outputPath = fileInfo.getOutputPath();</span><br><span class="line">            if (StrUtil.isEmpty(outputPath)) &#123;</span><br><span class="line">                fileInfo.setOutputPath(inputPath);</span><br><span class="line">            &#125;</span><br><span class="line">            //type: 默认inputPath 有文件后缀(比如.java)默认为file,否则就dir</span><br><span class="line">            String type = fileInfo.getType();</span><br><span class="line">            if (StrUtil.isBlank(type)) &#123;</span><br><span class="line">                //无文件后缀</span><br><span class="line">                if (StrUtil.isBlank(FileUtil.getSuffix(inputPath))) &#123;</span><br><span class="line">                    fileInfo.setType(&quot;dir&quot;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    fileInfo.setType(&quot;file&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // generateType 文件结尾不为ftl,generateType 为static,否则为dynamic</span><br><span class="line">            String generateType = fileInfo.getGenerateType();</span><br><span class="line">            if (StrUtil.isBlank(generateType)) &#123;</span><br><span class="line">                if (inputPath.endsWith(&quot;.ftl&quot;)) &#123;</span><br><span class="line">                    fileInfo.setGenerateType(&quot;dynamic&quot;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    fileInfo.setGenerateType(&quot;static&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void validAndFillMetaRoot(Meta meta) &#123;</span><br><span class="line">        //基础信息校验和默认值</span><br><span class="line">        String name = StrUtil.blankToDefault(meta.getName(),&quot;my-generator&quot;);</span><br><span class="line">        meta.setName(name);</span><br><span class="line"></span><br><span class="line">        String description = StrUtil.emptyToDefault(meta.getDescription(),&quot;我的模板代码生成器&quot;);</span><br><span class="line">        meta.setDescription(description);</span><br><span class="line"></span><br><span class="line">        String basePackage = StrUtil.blankToDefault(meta.getBasePackage(), &quot;com.yupi&quot;);</span><br><span class="line">        meta.setBasePackage(basePackage);</span><br><span class="line"></span><br><span class="line">        String version = StrUtil.emptyToDefault(meta.getVersion(), &quot;1.0&quot;);</span><br><span class="line">        meta.setVersion(version);</span><br><span class="line"></span><br><span class="line">        String author = StrUtil.emptyToDefault(meta.getAuthor(), &quot;zlz&quot;);</span><br><span class="line">        meta.setAuthor(author);</span><br><span class="line"></span><br><span class="line">        String createTime = StrUtil.emptyToDefault(meta.getCreateTime(), DateUtil.now());</span><br><span class="line">        meta.setCreateTime(createTime);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调用校验代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 校验配置文件的合法性，处理默认值</span><br><span class="line">MetaValidator.doValidAndFill(newMeta);</span><br></pre></td></tr></table></figure>



<h4 id="可扩展性优化"><a href="#可扩展性优化" class="headerlink" title="可扩展性优化"></a>可扩展性优化</h4><p>让别人改你的代码更方便</p>
<p>1.代码层面可扩展性（让别人方便增加功能）</p>
<p>2.性能层面的可扩展性（增加机器，增加数据库，增加redis可以线性增加系统的负载量）</p>
<p>3.资源可扩展性（是否能再加内存条）</p>
<p>项目可扩展点</p>
<h5 id="1-定义枚举类（如果一个项目里直接用双引号的模仿值用的很多可以考虑定义枚举或者常量）"><a href="#1-定义枚举类（如果一个项目里直接用双引号的模仿值用的很多可以考虑定义枚举或者常量）" class="headerlink" title="1.定义枚举类（如果一个项目里直接用双引号的模仿值用的很多可以考虑定义枚举或者常量）"></a>1.定义枚举类（如果一个项目里直接用双引号的模仿值用的很多可以考虑定义枚举或者常量）</h5><p>​	一般枚举类都是两个值，一个中文描述，一个英文参数</p>
<p>​	枚举类最开始就被赋值，不允许修改（只有get，没有set）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 文件类型枚举</span><br><span class="line"> */</span><br><span class="line">public enum FileTypeEnum &#123;</span><br><span class="line">    DIR(&quot;目录&quot;,&quot;dir&quot;),</span><br><span class="line">    FILE(&quot;文件&quot;,&quot;file&quot;);</span><br><span class="line"></span><br><span class="line">    private final String text;</span><br><span class="line"></span><br><span class="line">    private final String value;</span><br><span class="line"></span><br><span class="line">    FileTypeEnum(String text,String value)&#123;</span><br><span class="line">        this.text = text;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getText() &#123;</span><br><span class="line">        return text;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getValue() &#123;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写一个需求时，先看看别人怎么写的</p>
<p>ctrl+shift+u把全大写替换成全小写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 文件生成类型枚举</span><br><span class="line"> */</span><br><span class="line">public enum FileGenerateTypeEnum &#123;</span><br><span class="line">    DYNAMIC(&quot;动态&quot;,&quot;dynamic&quot;),</span><br><span class="line">    STATIC(&quot;静态&quot;,&quot;static&quot;);</span><br><span class="line"></span><br><span class="line">    private final String text;</span><br><span class="line"></span><br><span class="line">    private final String value;</span><br><span class="line"></span><br><span class="line">    FileGenerateTypeEnum(String text, String value)&#123;</span><br><span class="line">        this.text = text;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getText() &#123;</span><br><span class="line">        return text;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getValue() &#123;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 模型类型枚举</span><br><span class="line"> */</span><br><span class="line">public enum ModelTypeEnum &#123;</span><br><span class="line">    STRING(&quot;字符串&quot;,&quot;string&quot;),</span><br><span class="line">    BOOLEAN(&quot;布尔&quot;,&quot;boolean&quot;);</span><br><span class="line"></span><br><span class="line">    private final String text;</span><br><span class="line"></span><br><span class="line">    private final String value;</span><br><span class="line"></span><br><span class="line">    ModelTypeEnum(String text, String value)&#123;</span><br><span class="line">        this.text = text;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getText() &#123;</span><br><span class="line">        return text;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getValue() &#123;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改之前写的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String modelInfoType = modelInfo.getType();</span><br><span class="line">if (StrUtil.isEmpty(modelInfoType)) &#123;</span><br><span class="line">    modelInfo.setType(ModelTypeEnum.STRING.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String defaultType = FileTypeEnum.DIR.getValue();</span><br></pre></td></tr></table></figure>



<h5 id="2-优化MainGenerator-java（流程太多）"><a href="#2-优化MainGenerator-java（流程太多）" class="headerlink" title="2.优化MainGenerator.java（流程太多）"></a>2.优化MainGenerator.java（流程太多）</h5><p>用模板方法模式优化</p>
<p>场景：完成一套复杂的工作或算法时，将算法或者工作的流程抽出来，定义成一套模板，再由具体的子类去实现不同的步骤，这样就可以实现可扩展性（子类遵循模板流程，又可以通过新增子类来进行扩展，覆盖父类的方法来进行定制）</p>
<p>实现：</p>
<p>1.梳理流程（每个流程对应构建一个方法）</p>
<p>​	从原始模板文件路径复制到生成的代码包中</p>
<p>​	生成代码</p>
<p>​	构建jar包</p>
<p>​	封装脚本</p>
<p>​	生成精简版的jar包</p>
<p>2.创建生成模板类（抽象类：表示被其他类继承）</p>
<p>​	1.定义流程方法，复制MainGenerator.java的代码到这个方法中</p>
<p>​	2.抽方法GenerateTemplate.java</p>
<p>​	建议：这个方法中定义变量的不要抽，因为在这个流程中会被多次用到，作为一个参数被其他流程传递</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public void doGenerate()throws TemplateException, IOException, InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    Meta meta = MetaManager.getMetaObject();</span><br><span class="line">    System.out.println(meta);</span><br><span class="line"></span><br><span class="line">    //输出的根路径</span><br><span class="line">    String projectPath = System.getProperty(&quot;user.dir&quot;);</span><br><span class="line">    String outputPath = projectPath + File.separator + &quot;generated&quot; + File.separator + meta.getName();</span><br><span class="line">    if (!FileUtil.exist(outputPath)) &#123;</span><br><span class="line">        FileUtil.mkdir(outputPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //1.从原始模板文件路径复制到生成的代码包中</span><br><span class="line">    String sourceCopyDestPath = copySource(meta, outputPath);</span><br><span class="line"></span><br><span class="line">    //2.生成代码</span><br><span class="line">    generateCode(meta, outputPath);</span><br><span class="line"></span><br><span class="line">    //3.构建jar包</span><br><span class="line">    buildJar(outputPath);</span><br><span class="line"></span><br><span class="line">    //4.封装脚本</span><br><span class="line">    Result result = buildScript(outputPath, meta);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //5.生成精简版的程序（产物包）-运行必须要用的</span><br><span class="line">    buildDist(outputPath, result, sourceCopyDestPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>思考：GenerateTemplate.java是否规范，是否还能优化</p>
<p>再把代码流程优化</p>
<p>缺点：发现流程中每个方法都是调用原始定义的变量，而没有调用每个流程的返回值，这样就有可能产生重复的操作和变量的污染</p>
<p>先思考每一步流程返回的参数（有些有返回参数，有些没有返回）</p>
<p>把如下代码从构建脚本方法移到构建jar包的方法中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//脚本名称</span><br><span class="line">String jarName = String.format(&quot;%s-%s-jar-with-dependencies.jar&quot;, meta.getName(), meta.getVersion());</span><br><span class="line">//脚本生成路径</span><br><span class="line">String jarPath = &quot;target/&quot; + jarName;</span><br></pre></td></tr></table></figure>





<p>优化每个流程的输入输出：上一步流程得到的结果是下一步流程的参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//3.构建jar包</span><br><span class="line">String jarPath = buildJar(outputPath, meta);</span><br><span class="line"></span><br><span class="line">//4.封装脚本</span><br><span class="line">Result result = buildScript(outputPath, jarPath);</span><br></pre></td></tr></table></figure>



<p>代码：修改了buildjar方法，buildScript方法，buildDist方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private static String buildScript(String outputPath, String jarPath) &#123;</span><br><span class="line">    //脚本输出路径</span><br><span class="line">    String shellOutputFilePath = outputPath + File.separator + &quot;generator&quot;;</span><br><span class="line"></span><br><span class="line">    ScriptGenerator.doGenerate(shellOutputFilePath, jarPath);</span><br><span class="line">    return shellOutputFilePath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private static String buildJar(String outputPath, Meta meta) throws IOException, InterruptedException &#123;</span><br><span class="line">    JarGenerator.doGenerate(outputPath);</span><br><span class="line">    //脚本名称</span><br><span class="line">    String jarName = String.format(&quot;%s-%s-jar-with-dependencies.jar&quot;, meta.getName(), meta.getVersion());</span><br><span class="line">    //脚本生成路径</span><br><span class="line">    String jarPath = &quot;target/&quot; + jarName;</span><br><span class="line">    return jarPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private static void buildDist(String outputPath, String sourceCopyDestPath, String jarPath ,String shellOutputFilePath) &#123;</span><br><span class="line">    String distOutputPath = outputPath + &quot;-dist&quot;;</span><br><span class="line">    //拷贝jar包</span><br><span class="line">    String targetAbsolutePath = distOutputPath + File.separator + &quot;target&quot;;</span><br><span class="line">    FileUtil.mkdir(targetAbsolutePath);</span><br><span class="line">    String jarAbsolutePath = outputPath + File.separator + jarPath;</span><br><span class="line">    FileUtil.copy(jarAbsolutePath, targetAbsolutePath, true);</span><br><span class="line"></span><br><span class="line">    //拷贝脚本文件</span><br><span class="line">    FileUtil.copy(shellOutputFilePath, distOutputPath, true);</span><br><span class="line">    FileUtil.copy(shellOutputFilePath + &quot;.bat&quot;, distOutputPath, true);</span><br><span class="line"></span><br><span class="line">    //拷贝源模板文件</span><br><span class="line">    FileUtil.copy(sourceCopyDestPath,distOutputPath,true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dogenerate方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//3.构建jar包</span><br><span class="line">String jarPath = buildJar(outputPath, meta);</span><br><span class="line"></span><br><span class="line">//4.封装脚本</span><br><span class="line">String shellOutputFilePath = buildScript(outputPath, jarPath);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//5.生成精简版的程序（产物包）-运行必须要用的</span><br><span class="line">buildDist(outputPath, sourceCopyDestPath,jarPath,shellOutputFilePath);</span><br></pre></td></tr></table></figure>



<h5 id="3-子类继承抽象类（实现）"><a href="#3-子类继承抽象类（实现）" class="headerlink" title="3.子类继承抽象类（实现）"></a>3.子类继承抽象类（实现）</h5><p>抽象类实现的子类都要实现这个方法，以后调用生成器的时候，里面就要实现这个流程</p>
<p>如下继承抽象类就要实现这个流程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class MainGenerator extends GenerateTemplate &#123;</span><br><span class="line">    public static void main(String[] args) throws TemplateException, IOException, InterruptedException &#123;</span><br><span class="line">        MainGenerator mainGenerator = new MainGenerator();</span><br><span class="line">        mainGenerator.doGenerate();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>也可以实现定制：子类不想生成精简版的jar包了</p>
<p>注意：复写方法不要是static</p>
<p>调用过程：MainGenerator-&gt;doGenerate.buildDist-&gt;MainGenerator.buildDist</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class MainGenerator extends GenerateTemplate &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void buildDist(String outputPath, String sourceCopyDestPath, String jarPath, String shellOutputFilePath) &#123;</span><br><span class="line">        System.out.println(&quot;不输出dist了&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws TemplateException, IOException, InterruptedException &#123;</span><br><span class="line">        MainGenerator mainGenerator = new MainGenerator();</span><br><span class="line">        mainGenerator.doGenerate();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这个复写功能可以应用的场景：普通用户只能够用这个功能，而VIP用户则不仅能用还能拿到源码</p>
<h2 id="3-改变生成目标-SpringBoot后端模板"><a href="#3-改变生成目标-SpringBoot后端模板" class="headerlink" title="3.改变生成目标-SpringBoot后端模板"></a>3.改变生成目标-SpringBoot后端模板</h2><p>1.生成目标–Spring Boot模板项目介绍</p>
<p>2.工具通用能力分析</p>
<p>3.配置能力增强开发</p>
<p>根据模板的能力，定制出七个能否开启的功能</p>
<p>1.替换生成的代码包名</p>
<p>2.控制是否生成帖子的相关功能</p>
<p>3.控制是否需要开启跨域</p>
<p>4.自定义Kinfe4jConfig接口文档配置</p>
<p>5.自定义MySql配置信息</p>
<p>6.控制是否开启Redis</p>
<p>7.控制是否开启Elasticsearch</p>
<h3 id="开发实现"><a href="#开发实现" class="headerlink" title="开发实现"></a>开发实现</h3><p>从上述需求中提取出的通用能力</p>
<p>1.模型参数控制单个文件生成</p>
<p>2.同一模型参数控制多个文件生成</p>
<p>3.一个模型参数同时控制多处代码修改以及文件是否生成</p>
<p>4.定义一组相关的模型参数，控制代码修改和文件生成</p>
<p>5.定义一组相关的模型参数，并能够通过其他的模型参数控制是否需要输入该组参数</p>
<h4 id="模型参数控制单个文件生成（一个或多个参数）"><a href="#模型参数控制单个文件生成（一个或多个参数）" class="headerlink" title="模型参数控制单个文件生成（一个或多个参数）"></a>模型参数控制单个文件生成（一个或多个参数）</h4><p>1.新增一个models</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;fieldName&quot;: &quot;needGit&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;boolean&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;是否生成 .gitignore 文件&quot;,</span><br><span class="line">  &quot;defaultValue&quot;: true,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>2.修改MainGenerator.java.ftl文件中的输入参数的类型改为DataModel</p>
<p>3.思考：如何将某些语句放到if中起到开关的作用</p>
<p>方法：在meta.json文件中关联变量，给file文件加个字段，在对应逻辑判断中${condition}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;inputPath&quot;: &quot;.gitignore&quot;,</span><br><span class="line">  &quot;outputPath&quot;: &quot;.gitignore&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;file&quot;,</span><br><span class="line">  &quot;generateType&quot;: &quot;static&quot;,</span><br><span class="line">  &quot;condition&quot;: &quot;needGit&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>如何被多个参数控制？</p>
<p>方法：在condition中用&amp;&amp;连接多个参数判断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;condition&quot;: &quot;needGit &amp;&amp; loop&quot;</span><br></pre></td></tr></table></figure>

<p>然后再对应逻辑判断语句中写needGit &amp;&amp; loop</p>
<p><img   src="/../image/Snipaste_2024-02-22_09-49-44.png"  alt="Snipaste_2024-02-22_09-49-44"></p>
<p>4.思考：变量的定义如何生成？</p>
<p>难点：不同的数据类型要区分不同的方法名</p>
<p><img   src="/../image/Snipaste_2024-02-22_09-47-49.png"  alt="Snipaste_2024-02-22_09-47-49"></p>
<p>思考：如何更方便的获取DataModel属性(怎么让所有的参数通过fieldName获取)</p>
<p>原因：lombok生成的getset方法有问题</p>
<p>方法：</p>
<p>1.通过将DataModel对象的属性公有化</p>
<p>不要觉得这种方式不好，我们之所以使用private隔离属性是因为能更好的封装和隔离属性，而一般情况下是没有这种约定的</p>
<p>2.让lombok生成的方法无论什么类型生成的方法名都是统一的（在@Data下加@Accessors(fluent &#x3D; true)）(不推荐，freemarker会报错，因为freemarker读取参数时会调用getXXX，setXXX方法)</p>
<p><img   src="/../image/Snipaste_2024-02-22_09-59-47.png"  alt="Snipaste_2024-02-22_09-59-47"></p>
<p><img   src="/../image/Snipaste_2024-02-22_10-00-19.png"  alt="Snipaste_2024-02-22_10-00-19"></p>
<p>步骤</p>
<p>1.修改DataModel.java.ftl文件将private改为public</p>
<p><img   src="/../image/Snipaste_2024-02-22_10-04-07.png"  alt="Snipaste_2024-02-22_10-04-07"></p>
<p>2.修改mainGenerator.java.ftl文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> &lt;#list modelConfig.models as modelInfo&gt;</span><br><span class="line">        $&#123;modelInfo.Type&#125; $&#123;modelInfo.fieldName&#125; = model.$&#123;modelInfo.field.Name&#125;;</span><br><span class="line">    &lt;/#list&gt;</span><br><span class="line"></span><br><span class="line">&lt;#list fileConfig.files as fileInfo&gt;</span><br><span class="line">    &lt;#if fileInfo.condition??&gt;</span><br><span class="line">    if ($&#123;fileInfo.condition&#125;)&#123;</span><br><span class="line">        inputPath = new File(inputRootPath,&quot;$&#123;fileInfo.inputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">        outputPath = new File(outputRootPath,&quot;$&#123;fileInfo.outputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">        &lt;#if fileInfo.generateType == &quot;static&quot;&gt;</span><br><span class="line">        StaticGenerator.copyFileByHutool(inputPath,outputPath);</span><br><span class="line">        &lt;#else &gt;</span><br><span class="line">        DynamicGenerator.doGenerator(inputPath,outputPath,model);</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;#else &gt;</span><br><span class="line">        inputPath = new File(inputRootPath,&quot;$&#123;fileInfo.inputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">        outputPath = new File(outputRootPath,&quot;$&#123;fileInfo.outputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">        &lt;#if fileInfo.generateType == &quot;static&quot;&gt;</span><br><span class="line">        StaticGenerator.copyFileByHutool(inputPath,outputPath);</span><br><span class="line">        &lt;#else &gt;</span><br><span class="line">        DynamicGenerator.doGenerator(inputPath,outputPath,model);</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/#list&gt;</span><br></pre></td></tr></table></figure>

<p>3.执行Main</p>
<p>效果</p>
<p><img   src="/../image/Snipaste_2024-02-22_11-19-07.png"  alt="Snipaste_2024-02-22_11-19-07"></p>
<p><img   src="/../image/Snipaste_2024-02-22_11-19-25.png"  alt="Snipaste_2024-02-22_11-19-25"></p>
<h4 id="使用同一个参数控制多个文件生成"><a href="#使用同一个参数控制多个文件生成" class="headerlink" title="使用同一个参数控制多个文件生成"></a>使用同一个参数控制多个文件生成</h4><p>方法：</p>
<p>1.在meta.json中的每一个file对象加condition</p>
<p>缺点：</p>
<p>​	修改不方便</p>
<p>2.把每一类功能相关的文件定义成一个组，给整个组添加一个condition条件</p>
<p>好处：查分组方便</p>
<p>缺点：没办法知道哪些文件是放在组下的，还得去遍历files文件找group字段的值，而且写逻辑的时候会充斥着重复的if不优雅</p>
<p><img   src="/../image/Snipaste_2024-02-22_11-30-25.png"  alt="Snipaste_2024-02-22_11-30-25"></p>
<p><img   src="/../image/Snipaste_2024-02-22_11-30-34.png"  alt="Snipaste_2024-02-22_11-30-34"></p>
<p>3.定义一个组，组内定义参数condition，在这个组内定义多个文件</p>
<p>所谓组就是文件夹的概念，就是把多个文件放在文件夹下，从而进行分组</p>
<p>优点：清晰、方便</p>
<p>缺点：多判断type是否是组类别</p>
<p>比如按文件静态动态分，把静态文件放在同一个文件夹下定义成files</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;groupKey&quot;: &quot;git&quot;,</span><br><span class="line">  &quot;groupName&quot;: &quot;开源&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;group&quot;,</span><br><span class="line">  //传输的条件</span><br><span class="line">  &quot;condition&quot;: &quot;needGit&quot;,</span><br><span class="line">  //同一类功能的文件</span><br><span class="line">  &quot;files&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;inputPath&quot;: &quot;.gitignore&quot;,</span><br><span class="line">      &quot;outputPath&quot;: &quot;.gitignore&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;file&quot;,</span><br><span class="line">      &quot;generateType&quot;: &quot;static&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;inputPath&quot;: &quot;README.md&quot;,</span><br><span class="line">      &quot;outputPath&quot;: &quot;README.md&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;file&quot;,</span><br><span class="line">      &quot;generateType&quot;: &quot;static&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在写逻辑的时候</p>
<p>if（condition）{</p>
<p>文件</p>
<p>}</p>
<p>步骤</p>
<p>1.修改meta.json</p>
<p>2.修改meta类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@NoArgsConstructor</span><br><span class="line">@Data</span><br><span class="line">public static class FileInfo &#123;</span><br><span class="line">    private String inputPath;</span><br><span class="line">    private String outputPath;</span><br><span class="line">    private String type;</span><br><span class="line">    private String generateType;</span><br><span class="line">    private String condition;</span><br><span class="line">    private String groupKey;</span><br><span class="line">    private String groupName;</span><br><span class="line">    private List&lt;FileInfo&gt; files ;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.修改枚举类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 文件类型枚举</span><br><span class="line"> */</span><br><span class="line">public enum FileTypeEnum &#123;</span><br><span class="line">    DIR(&quot;目录&quot;,&quot;dir&quot;),</span><br><span class="line">    FILE(&quot;文件&quot;,&quot;file&quot;),</span><br><span class="line">    Group(&quot;文件组&quot;,&quot;group&quot;);</span><br><span class="line"></span><br><span class="line">    private final String text;</span><br><span class="line"></span><br><span class="line">    private final String value;</span><br><span class="line"></span><br><span class="line">    FileTypeEnum(String text,String value)&#123;</span><br><span class="line">        this.text = text;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getText() &#123;</span><br><span class="line">        return text;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getValue() &#123;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样之后在web端界面也可以展开，便于管理</p>
<p>4.这样子修改后files里的字段就不一定需要指定输入路径和输出路径，还要修改校验逻辑</p>
<p>如果是组类别就不需要做校验了</p>
<p>在equals上alt+enter，找到filp，这样做是为了防止FileTypeEnum.Group.getValue()为空</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//如果是组类别就不需要填写inputPath</span><br><span class="line">String type = fileInfo.getType();</span><br><span class="line">if (FileTypeEnum.Group.getValue().equals(type))&#123;</span><br><span class="line">    continue;</span><br><span class="line">&#125;</span><br><span class="line">//inputPath: 必填</span><br><span class="line">String inputPath = fileInfo.getInputPath();</span><br><span class="line">if (StrUtil.isBlank(inputPath)) &#123;</span><br><span class="line">    throw new MetaException(&quot;未填写 inputPath&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5.修改MainGenerator.java.ftl</p>
<p>之前遍历只是遍历文件，现在遍历还要判断是否是分组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 核心生成器</span><br><span class="line"> */</span><br><span class="line">public class MainGenerator &#123;</span><br><span class="line"></span><br><span class="line">    public static void doGenerate(DataModel model) throws TemplateException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        //动态文件配置</span><br><span class="line">        //绝对路径</span><br><span class="line">        String inputRootPath = &quot;$&#123;fileConfig.inputRootPath&#125;&quot;;</span><br><span class="line">        String outputRootPath = &quot;$&#123;fileConfig.outputRootPath&#125;&quot;;</span><br><span class="line"></span><br><span class="line">        //相对路径</span><br><span class="line">        String inputPath;</span><br><span class="line">        String outputPath;</span><br><span class="line"></span><br><span class="line">    &lt;#list modelConfig.models as modelInfo&gt;</span><br><span class="line">        $&#123;modelInfo.type&#125; $&#123;modelInfo.fieldName&#125; = model.$&#123;modelInfo.fieldName&#125;;</span><br><span class="line">    &lt;/#list&gt;</span><br><span class="line"></span><br><span class="line">&lt;#list fileConfig.files as fileInfo&gt;</span><br><span class="line">    &lt;#if fileInfo.groupKey??&gt;</span><br><span class="line">    //groupKey = $&#123;fileInfo.groupKey&#125;</span><br><span class="line">    &lt;#if fileInfo.condition??&gt;</span><br><span class="line">    if ($&#123;fileInfo.condition&#125;)&#123;</span><br><span class="line">        &lt;#list fileInfo.files as fileInfo&gt;</span><br><span class="line">            inputPath = new File(inputRootPath,&quot;$&#123;fileInfo.inputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">            outputPath = new File(outputRootPath,&quot;$&#123;fileInfo.outputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">            &lt;#if fileInfo.generateType == &quot;static&quot;&gt;</span><br><span class="line">                StaticGenerator.copyFileByHutool(inputPath,outputPath);</span><br><span class="line">            &lt;#else &gt;</span><br><span class="line">                DynamicGenerator.doGenerator(inputPath,outputPath,model);</span><br><span class="line">            &lt;/#if&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/#list&gt;</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;#else &gt;</span><br><span class="line">        &lt;#list fileInfo.files as fileInfo&gt;</span><br><span class="line">            inputPath = new File(inputRootPath,&quot;$&#123;fileInfo.inputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">            outputPath = new File(outputRootPath,&quot;$&#123;fileInfo.outputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">            &lt;#if fileInfo.generateType == &quot;static&quot;&gt;</span><br><span class="line">                StaticGenerator.copyFileByHutool(inputPath,outputPath);</span><br><span class="line">            &lt;#else &gt;</span><br><span class="line">                DynamicGenerator.doGenerator(inputPath,outputPath,model);</span><br><span class="line">            &lt;/#if&gt;</span><br><span class="line">        &lt;/#list&gt;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">    &lt;#else&gt;</span><br><span class="line">        &lt;#if fileInfo.condition??&gt;</span><br><span class="line">            if ($&#123;fileInfo.condition&#125;)&#123;</span><br><span class="line">            inputPath = new File(inputRootPath,&quot;$&#123;fileInfo.inputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">            outputPath = new File(outputRootPath,&quot;$&#123;fileInfo.outputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">            &lt;#if fileInfo.generateType == &quot;static&quot;&gt;</span><br><span class="line">                StaticGenerator.copyFileByHutool(inputPath,outputPath);</span><br><span class="line">            &lt;#else &gt;</span><br><span class="line">                DynamicGenerator.doGenerator(inputPath,outputPath,model);</span><br><span class="line">            &lt;/#if&gt;</span><br><span class="line">            &#125;</span><br><span class="line">        &lt;#else &gt;</span><br><span class="line">            inputPath = new File(inputRootPath,&quot;$&#123;fileInfo.inputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">            outputPath = new File(outputRootPath,&quot;$&#123;fileInfo.outputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">            &lt;#if fileInfo.generateType == &quot;static&quot;&gt;</span><br><span class="line">                StaticGenerator.copyFileByHutool(inputPath,outputPath);</span><br><span class="line">            &lt;#else &gt;</span><br><span class="line">                DynamicGenerator.doGenerator(inputPath,outputPath,model);</span><br><span class="line">            &lt;/#if&gt;</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">&lt;/#list&gt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑</p>
<p><img   src="/../image/Snipaste_2024-02-22_12-35-41.png"  alt="Snipaste_2024-02-22_12-35-41"></p>
<p>这肯定还是要优化的（可以学到前端组件抽象优化的思维）</p>
<p>通过上述代码发现有一个代码逻辑被反复使用4次，很复杂，如何优化</p>
<p>方法：freemarker提供了定义宏，复用宏变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 与java的定义方法很类似</span><br><span class="line"> *@param generateFile 宏定义文件名（方法名）</span><br><span class="line"> *@para@ indent 表示缩进（参数）</span><br><span class="line"> *@param fileInfo 方法体内用到的参数</span><br><span class="line"> **/</span><br><span class="line"> </span><br><span class="line">&lt;#macro generateFile indent fileInfo &gt;</span><br><span class="line">$&#123;indent&#125;inputPath = new File(inputRootPath,&quot;$&#123;fileInfo.inputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">$&#123;indent&#125;outputPath = new File(outputRootPath,&quot;$&#123;fileInfo.outputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">&lt;#if fileInfo.generateType == &quot;static&quot;&gt;</span><br><span class="line">$&#123;indent&#125;StaticGenerator.copyFileByHutool(inputPath,outputPath);</span><br><span class="line">&lt;#else &gt;</span><br><span class="line">$&#123;indent&#125;DynamicGenerator.doGenerator(inputPath,outputPath,model);</span><br><span class="line">&lt;/#if&gt;</span><br><span class="line">&lt;/#macro&gt;</span><br><span class="line"></span><br><span class="line">方法的实现</span><br><span class="line">&lt;@generateFile indent=&quot;            &quot; fileInfo=fileInfo /&gt;</span><br></pre></td></tr></table></figure>



<h4 id="用同一个参数同时控制代码和文件生成"><a href="#用同一个参数同时控制代码和文件生成" class="headerlink" title="用同一个参数同时控制代码和文件生成"></a>用同一个参数同时控制代码和文件生成</h4><p>其实已经实现了</p>
<p><img   src="/../image/Snipaste_2024-02-22_14-24-50.png"  alt="Snipaste_2024-02-22_14-24-50"></p>
<p><img   src="/../image/Snipaste_2024-02-22_14-25-09.png"  alt="Snipaste_2024-02-22_14-25-09"></p>
<h4 id="定义一组配置去实现功能"><a href="#定义一组配置去实现功能" class="headerlink" title="定义一组配置去实现功能"></a>定义一组配置去实现功能</h4><p>方法：原理其实跟上一个功能类似，就是把作用在同一范围内的模型参数定义成一组</p>
<p>本质就是把一组文件封装成一个对象</p>
<p>1.修改meta.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;groupKey&quot;: &quot;mainTemplate&quot;,</span><br><span class="line">  &quot;groupName&quot;: &quot;核心模板&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;MainTemplate&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;用于生成核心模板文件&quot;,</span><br><span class="line">  &quot;models&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;fieldName&quot;: &quot;author&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;作者注释&quot;,</span><br><span class="line">      &quot;defaultValue&quot;: &quot;yupi&quot;,</span><br><span class="line">      &quot;abbr&quot;: &quot;a&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;fieldName&quot;: &quot;outputText&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;输出信息&quot;,</span><br><span class="line">      &quot;defaultValue&quot;: &quot;sum = &quot;,</span><br><span class="line">      &quot;abbr&quot;: &quot;o&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.修改meta类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@NoArgsConstructor</span><br><span class="line">@Data</span><br><span class="line">public static class ModelsInfo &#123;</span><br><span class="line">    private String fieldName;</span><br><span class="line">    private String type;</span><br><span class="line">    private String description;</span><br><span class="line">    private Object defaultValue;</span><br><span class="line">    private String abbr;</span><br><span class="line">    private String groupKey;</span><br><span class="line">    private String groupName;</span><br><span class="line">    private List&lt;ModelsInfo&gt; models;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.修改校验文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//为group,不校验</span><br><span class="line">String groupKey = modelInfo.getGroupKey();</span><br><span class="line">if (StrUtil.isNotBlank(groupKey))&#123;</span><br><span class="line">    continue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.思考：怎么让用户的输入进行分组？</p>
<p>​	1.先让数据模型的参数分组</p>
<p>​		在生成的代码中新建MainTemplate类，从而分组</p>
<p>​	</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class DataModel &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 是否生成.gitignore文件</span><br><span class="line">     */</span><br><span class="line">    public boolean needGit = true;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 是否生成循环</span><br><span class="line">     */</span><br><span class="line">    public boolean loop = false;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 核心模板</span><br><span class="line">     */</span><br><span class="line">    public MainTemplate mainTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class MainTemplate &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 输出信息</span><br><span class="line">     */</span><br><span class="line">    private String outputText ;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 作者注释</span><br><span class="line">     */</span><br><span class="line">    private boolean author;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.使用picocil的高级特性</p>
<p>​	1.定义一个分组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">static class MainTemplate &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 输出信息</span><br><span class="line">     */</span><br><span class="line">    @Option(names = &#123;&quot;-o&quot;, &quot;--outputText&quot;&#125;, description = &quot;输出信息&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">    private String outputText ;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 作者注释</span><br><span class="line">     */</span><br><span class="line">    @Option(names = &#123;&quot;-a&quot;, &quot;--author&quot;&#125;, description = &quot;作者注释&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">    private boolean author;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	2.控制这个对象是否是分组中的参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//exclusive 严格模式校验，MainTemplate类中的参数都要传 ,heading:表示输入help时会出现的提示</span><br><span class="line">@CommandLine.ArgGroup(exclusive = false,heading = &quot;核心模板%n&quot;)</span><br><span class="line">MainTemplate mainTemplate;</span><br></pre></td></tr></table></figure>



<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@Command(name = &quot;generate&quot;, mixinStandardHelpOptions = true)</span><br><span class="line">@Data</span><br><span class="line">public class TestArgCommandCommand implements Runnable &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Option(names = &#123;&quot;-k&quot;, &quot;--needGit&quot;&#125;, description = &quot;是否生成.gitignore文件&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">    private boolean needGit  = true ;</span><br><span class="line"></span><br><span class="line">    @Option(names = &#123;&quot;-l&quot;, &quot;--loop&quot;&#125;, description = &quot;是否生成循环&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">    private boolean loop  = false ;</span><br><span class="line"></span><br><span class="line">    //exclusive 严格模式校验，MainTemplate类中的参数都要传 ,heading:表示输入help时会出现的提示</span><br><span class="line">    @CommandLine.ArgGroup(exclusive = false,heading = &quot;核心模板%n&quot;)</span><br><span class="line">    MainTemplate mainTemplate;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        System.out.println(needGit);</span><br><span class="line">        System.out.println(mainTemplate);</span><br><span class="line">        System.out.println(loop);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Data</span><br><span class="line">    static class MainTemplate &#123;</span><br><span class="line">        /**</span><br><span class="line">         * 输出信息</span><br><span class="line">         */</span><br><span class="line">        @Option(names = &#123;&quot;-o&quot;, &quot;--outputText&quot;&#125;, description = &quot;输出信息&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">        private String outputText ;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * 作者注释</span><br><span class="line">         */</span><br><span class="line">        @Option(names = &#123;&quot;-a&quot;, &quot;--author&quot;&#125;, description = &quot;作者注释&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">        private boolean author;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        CommandLine commandLine = new CommandLine(TestArgCommandCommand.class);</span><br><span class="line">        args = new String[]&#123;&quot;--help&quot;&#125;;</span><br><span class="line">        commandLine.execute(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果</p>
<p><img   src="/../image/Snipaste_2024-02-22_15-45-18.png"  alt="Snipaste_2024-02-22_15-45-18"></p>
<p>以上方法并没有解决问题，只是让我们的帮助手册和代码好看了一些</p>
<h4 id="定义某个分组是否可选开启"><a href="#定义某个分组是否可选开启" class="headerlink" title="定义某个分组是否可选开启"></a>定义某个分组是否可选开启</h4><p>在meta.json中的models中添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;condition&quot;: &quot;loop&quot;,</span><br></pre></td></tr></table></figure>



<p>编写测试：通过套娃的方式编写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 数据模型</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">public class DataModel &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 是否生成.gitignore文件</span><br><span class="line">     */</span><br><span class="line">    public boolean needGit = true;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 是否生成循环</span><br><span class="line">     */</span><br><span class="line">    public boolean loop = false;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 核心模板</span><br><span class="line">     */</span><br><span class="line">    public MainTemplate mainTemplate = new MainTemplate();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 用于生成核心模板文件</span><br><span class="line">     */</span><br><span class="line">    @Data</span><br><span class="line">    public static class MainTemplate&#123;</span><br><span class="line">       /**</span><br><span class="line">        * 作者</span><br><span class="line">        */</span><br><span class="line">       public String author = &quot;zlz&quot;;</span><br><span class="line"></span><br><span class="line">       /**</span><br><span class="line">        * 输出信息</span><br><span class="line">        */</span><br><span class="line">       public String outputText = &quot;sum =&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">@Command(name = &quot;generate&quot;, description = &quot;生成代码&quot;,mixinStandardHelpOptions = true)</span><br><span class="line">@Data</span><br><span class="line">public class TestGroupCommandCommand implements Runnable &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Option(names = &#123;&quot;-k&quot;, &quot;--needGit&quot;&#125;, description = &quot;是否生成.gitignore文件&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">    private boolean needGit  = true ;</span><br><span class="line"></span><br><span class="line">    @Option(names = &#123;&quot;-l&quot;, &quot;--loop&quot;&#125;, description = &quot;是否生成循环&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">    private boolean loop  = false ;</span><br><span class="line"></span><br><span class="line">    static DataModel.MainTemplate mainTemplate =new DataModel.MainTemplate();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        System.out.println(needGit);</span><br><span class="line">        System.out.println(loop);</span><br><span class="line">        if (true)&#123;</span><br><span class="line">            System.out.println(&quot;输入核心模板配置：&quot;);</span><br><span class="line">            CommandLine commandLine = new CommandLine(MainTemplateCommand.class);</span><br><span class="line">            commandLine.execute(&quot;-a&quot;,&quot;-o&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(mainTemplate);</span><br><span class="line">        //赋值给DataModel</span><br><span class="line">//        DataModel dataModel = new DataModel();</span><br><span class="line">        //DataModel.mainTemplate = MainTemplate;</span><br><span class="line">//        BeanUtil.copyProperties(this, dataModel);</span><br><span class="line">//        MainGenerator.doGenerate(dataModel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Command(name = &quot;mainTemplate&quot;, description = &quot;用于生成核心模板文件&quot;)</span><br><span class="line">    @Data</span><br><span class="line">    public static class MainTemplateCommand implements Runnable&#123;</span><br><span class="line">        /**</span><br><span class="line">         * 输出信息</span><br><span class="line">         */</span><br><span class="line">        @Option(names = &#123;&quot;-o&quot;, &quot;--outputText&quot;&#125;, description = &quot;输出信息&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">        private String outputText ;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * 作者注释</span><br><span class="line">         */</span><br><span class="line">        @Option(names = &#123;&quot;-a&quot;, &quot;--author&quot;&#125;, description = &quot;作者注释&quot;, arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">        private String author;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            //传递给外层参数</span><br><span class="line">            mainTemplate.author = author;</span><br><span class="line">            mainTemplate.outputText = outputText;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        CommandLine commandLine = new CommandLine(TestGroupCommandCommand.class);</span><br><span class="line">        args = new String[]&#123;&quot;-l&quot;,&quot;--needGit&quot;&#125;;</span><br><span class="line">        commandLine.execute(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现效果：</p>
<p><img   src="/../image/Snipaste_2024-02-22_18-51-48.png"  alt="Snipaste_2024-02-22_18-51-48"></p>
<p>回到制作工具</p>
<p>1.修改meta类（在modelInfo中添加变量）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private String condition;</span><br></pre></td></tr></table></figure>

<p>2.修改MetaVaildator的校验</p>
<p>2.修改DataModel.java.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">package $&#123;basePackage&#125;.model;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line"></span><br><span class="line">&lt;#macro generateModel indent modelInfo&gt;</span><br><span class="line">&lt;#if modelInfo.description??&gt;</span><br><span class="line">$&#123;indent&#125;/**</span><br><span class="line">$&#123;indent&#125; * $&#123;modelInfo.description&#125;</span><br><span class="line">$&#123;indent&#125; */</span><br><span class="line">&lt;/#if&gt;</span><br><span class="line">$&#123;indent&#125;public $&#123;modelInfo.type&#125; $&#123;modelInfo.fieldName&#125; &lt;#if modelInfo.defaultValue??&gt; = $&#123;modelInfo.defaultValue?c&#125;&lt;/#if&gt;;</span><br><span class="line">&lt;/#macro&gt;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 数据模型</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">public class DataModel &#123;</span><br><span class="line"></span><br><span class="line">&lt;#list modelConfig.models as modelInfo&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;#--有分组--&gt;</span><br><span class="line">    &lt;#if modelInfo.groupKey??&gt;</span><br><span class="line">    /**</span><br><span class="line">    * $&#123;modelInfo.groupName&#125;</span><br><span class="line">    */</span><br><span class="line">    public $&#123;modelInfo.type&#125; $&#123;modelInfo.groupKey&#125; = new $&#123;modelInfo.type&#125;();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * $&#123;modelInfo.description&#125;</span><br><span class="line">    */</span><br><span class="line">    @Data</span><br><span class="line">    public static class $&#123;modelInfo.type&#125;&#123;</span><br><span class="line">        &lt;#list modelInfo.models as modelInfo&gt;</span><br><span class="line">           &lt;@generateModel indent=&quot;    &quot; modelInfo=modelInfo /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/#list&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &lt;#else &gt;</span><br><span class="line">        &lt;@generateModel indent=&quot;    &quot; modelInfo=modelInfo /&gt;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">&lt;/#list&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.修改MainGenerator.java.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">package $&#123;basePackage&#125;.generator;</span><br><span class="line"></span><br><span class="line">import $&#123;basePackage&#125;.model.DataModel;</span><br><span class="line">import freemarker.template.TemplateException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">&lt;#macro generateFile indent fileInfo &gt;</span><br><span class="line">$&#123;indent&#125;inputPath = new File(inputRootPath,&quot;$&#123;fileInfo.inputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">$&#123;indent&#125;outputPath = new File(outputRootPath,&quot;$&#123;fileInfo.outputPath&#125;&quot;).getAbsolutePath();</span><br><span class="line">&lt;#if fileInfo.generateType == &quot;static&quot;&gt;</span><br><span class="line">$&#123;indent&#125;StaticGenerator.copyFileByHutool(inputPath,outputPath);</span><br><span class="line">&lt;#else &gt;</span><br><span class="line">$&#123;indent&#125;DynamicGenerator.doGenerator(inputPath,outputPath,model);</span><br><span class="line">&lt;/#if&gt;</span><br><span class="line">&lt;/#macro&gt;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 核心生成器</span><br><span class="line"> */</span><br><span class="line">public class MainGenerator &#123;</span><br><span class="line"></span><br><span class="line">    public static void doGenerate(DataModel model) throws TemplateException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        //动态文件配置</span><br><span class="line">        //绝对路径</span><br><span class="line">        String inputRootPath = &quot;$&#123;fileConfig.inputRootPath&#125;&quot;;</span><br><span class="line">        String outputRootPath = &quot;$&#123;fileConfig.outputRootPath&#125;&quot;;</span><br><span class="line"></span><br><span class="line">        //相对路径</span><br><span class="line">        String inputPath;</span><br><span class="line">        String outputPath;</span><br><span class="line"></span><br><span class="line">    &lt;#list modelConfig.models as modelInfo&gt;</span><br><span class="line">        &lt;#--有分组--&gt;</span><br><span class="line">        &lt;#if modelInfo.groupKey??&gt;</span><br><span class="line">        &lt;#list modelInfo.models as subModelInfo&gt;</span><br><span class="line">        $&#123;subModelInfo.type&#125; $&#123;subModelInfo.fieldName&#125; = model.$&#123;modelInfo.groupKey&#125;.$&#123;subModelInfo.fieldName&#125;;</span><br><span class="line">        &lt;/#list&gt;</span><br><span class="line">        &lt;#else &gt;</span><br><span class="line">        $&#123;modelInfo.type&#125; $&#123;modelInfo.fieldName&#125; = model.$&#123;modelInfo.fieldName&#125;;</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">    &lt;/#list&gt;</span><br><span class="line"></span><br><span class="line">&lt;#list fileConfig.files as fileInfo&gt;</span><br><span class="line">    &lt;#if fileInfo.groupKey??&gt;</span><br><span class="line">        //groupKey = $&#123;fileInfo.groupKey&#125;</span><br><span class="line">    &lt;#if fileInfo.condition??&gt;</span><br><span class="line">        if ($&#123;fileInfo.condition&#125;)&#123;</span><br><span class="line">        &lt;#list fileInfo.files as fileInfo&gt;</span><br><span class="line">            &lt;@generateFile indent=&quot;            &quot; fileInfo=fileInfo /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/#list&gt;</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;#else &gt;</span><br><span class="line">    &lt;#list fileInfo.files as fileInfo&gt;</span><br><span class="line">        &lt;@generateFile indent=&quot;         &quot; fileInfo=fileInfo /&gt;</span><br><span class="line">    &lt;/#list&gt;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">    &lt;#else&gt;</span><br><span class="line">    &lt;#if fileInfo.condition??&gt;</span><br><span class="line">    if ($&#123;fileInfo.condition&#125;)&#123;</span><br><span class="line">        &lt;@generateFile indent=&quot;            &quot; fileInfo=fileInfo /&gt;</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;#else &gt;</span><br><span class="line">        &lt;@generateFile indent=&quot;        &quot; fileInfo=fileInfo /&gt;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">&lt;/#list&gt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.修改GenerateCommand.java.ftl（不好改）</p>
<p>​	1.在meta.java中设置中间参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//中间参数：不用再json中写的，而是为了系统方便临时生成的</span><br><span class="line">//该分组下所有参数拼接的字符串，作用在获取metajson信息的时候处理参数</span><br><span class="line">private String allArgsStr;</span><br></pre></td></tr></table></figure>

<p>​	2.在校验信息类下使用中间参数拼成”–author”,”-outputText”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ModelConfig.ModelsInfo&gt; subModelInfoList = modelInfo.getModels();</span><br></pre></td></tr></table></figure>

<p>作用：获取以下这段配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;fieldName&quot;: &quot;author&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;作者注释&quot;,</span><br><span class="line">  &quot;defaultValue&quot;: &quot;yupi&quot;,</span><br><span class="line">  &quot;abbr&quot;: &quot;a&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  &quot;fieldName&quot;: &quot;outputText&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;输出信息&quot;,</span><br><span class="line">  &quot;defaultValue&quot;: &quot;sum = &quot;,</span><br><span class="line">  &quot;abbr&quot;: &quot;o&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//lambda表达式，作用：拼成&quot;--author&quot;,&quot;-outputText&quot;</span><br><span class="line">subModelInfoList.stream().map(subModelInfo-&gt; &#123;</span><br><span class="line">    return String.format(&quot;\&quot;--%s\&quot;&quot;, subModelInfo.getFieldName());</span><br><span class="line">&#125;).collect(Collectors.joining(&quot;, &quot;));</span><br></pre></td></tr></table></figure>

<p>这段逻辑的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//为group,不校验</span><br><span class="line">String groupKey = modelInfo.getGroupKey();</span><br><span class="line">if (StrUtil.isNotBlank(groupKey))&#123;</span><br><span class="line">    //生成中间参数，目标生成&quot;--author&quot;,&quot;-outputText&quot;</span><br><span class="line">    List&lt;ModelConfig.ModelsInfo&gt; subModelInfoList = modelInfo.getModels();</span><br><span class="line">    String allArgsStr = subModelInfoList.stream()</span><br><span class="line">            .map(subModelInfo -&gt; String.format(&quot;\&quot;--%s\&quot;&quot;, subModelInfo.getFieldName())).</span><br><span class="line">            collect(Collectors.joining(&quot;, &quot;));</span><br><span class="line">    modelInfo.setAllArgsStr(allArgsStr);</span><br><span class="line">    continue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>GenerateCommand.java.ftl修改代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">package $&#123;basePackage&#125;.cli.command;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import cn.hutool.core.bean.BeanUtil;</span><br><span class="line">import $&#123;basePackage&#125;.generator.MainGenerator;</span><br><span class="line">import $&#123;basePackage&#125;.model.DataModel;</span><br><span class="line">import lombok.Data;</span><br><span class="line">import picocli.CommandLine;</span><br><span class="line">import picocli.CommandLine.Command;</span><br><span class="line">import picocli.CommandLine.Option;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.Callable;</span><br><span class="line"></span><br><span class="line">&lt;#--生成选项--&gt;</span><br><span class="line">&lt;#macro generateOption indent modelInfo&gt;</span><br><span class="line">$&#123;indent&#125;@Option(names = &#123;&lt;#if modelInfo.abbr??&gt;&quot;-$&#123;modelInfo.abbr&#125;&quot;,&lt;/#if&gt; &quot;--$&#123;modelInfo.fieldName&#125;&quot;&#125;,&lt;#if modelInfo.description??&gt; description = &quot;$&#123;modelInfo.description&#125;&quot;,&lt;/#if&gt; arity = &quot;0..1&quot;,interactive = true,echo = true)</span><br><span class="line">$&#123;indent&#125;private $&#123;modelInfo.type&#125; $&#123;modelInfo.fieldName&#125; &lt;#if modelInfo.defaultValue??&gt; = $&#123;modelInfo.defaultValue?c&#125;&lt;/#if&gt; ;</span><br><span class="line">&lt;/#macro&gt;</span><br><span class="line"></span><br><span class="line">&lt;#--生成run方法的实现内容--&gt;</span><br><span class="line">&lt;#macro generateCommand indent modelInfo&gt;</span><br><span class="line">$&#123;indent&#125;System.out.println(&quot;输入$&#123;modelInfo.groupName&#125;配置：&quot;);</span><br><span class="line">$&#123;indent&#125;CommandLine commandLine = new CommandLine($&#123;modelInfo.type&#125;Command.class);</span><br><span class="line">$&#123;indent&#125;commandLine.execute($&#123;modelInfo.allArgsStr&#125;);</span><br><span class="line">&lt;/#macro&gt;</span><br><span class="line"></span><br><span class="line">@Command(name = &quot;generate&quot;, description = &quot;生成代码&quot;,mixinStandardHelpOptions = true)</span><br><span class="line">@Data</span><br><span class="line">public class GenerateCommand implements Callable &#123;</span><br><span class="line"></span><br><span class="line">&lt;#list modelConfig.models as modelInfo&gt;</span><br><span class="line">    &lt;#-- 有分组--&gt;</span><br><span class="line">    &lt;#if modelInfo.groupKey??&gt;</span><br><span class="line">    /**</span><br><span class="line">     * $&#123;modelInfo.groupName&#125;</span><br><span class="line">     */</span><br><span class="line">    static DataModel.$&#123;modelInfo.type&#125; $&#123;modelInfo.groupKey&#125; =new DataModel.$&#123;modelInfo.type&#125;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Command(name = &quot;$&#123;modelInfo.groupName&#125;&quot;, description = &quot;$&#123;modelInfo.description&#125;&quot;)</span><br><span class="line">    @Data</span><br><span class="line">    public static class $&#123;modelInfo.type&#125;Command implements Runnable&#123;</span><br><span class="line"></span><br><span class="line">        &lt;#list modelInfo.models as subModelInfo&gt;</span><br><span class="line">            &lt;@generateOption indent=&quot;        &quot; modelInfo= subModelInfo /&gt;</span><br><span class="line">        &lt;/#list&gt;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            &lt;#list modelInfo.models as subModelInfo&gt;</span><br><span class="line">            $&#123;modelInfo.groupKey&#125;.$&#123;subModelInfo.fieldName&#125; = $&#123;subModelInfo.fieldName&#125;;</span><br><span class="line">            &lt;/#list&gt;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;#else &gt;</span><br><span class="line">        &lt;@generateOption indent=&quot;    &quot; modelInfo= modelInfo /&gt;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">&lt;/#list &gt;</span><br><span class="line"></span><br><span class="line">&lt;#--    生成调用方法--&gt;</span><br><span class="line">    @Override</span><br><span class="line">    public Integer call() throws Exception &#123;</span><br><span class="line">        &lt;#list modelConfig.models as modelInfo&gt;</span><br><span class="line">        &lt;#if modelInfo.groupKey??&gt;</span><br><span class="line">        &lt;#if modelInfo.condition??&gt;</span><br><span class="line">        if ($&#123;modelInfo.condition&#125;)&#123;</span><br><span class="line">            &lt;@generateCommand indent=&quot;            &quot; modelInfo= modelInfo/&gt;</span><br><span class="line">        &#125;</span><br><span class="line">        &lt;#else&gt;</span><br><span class="line">        &lt;@generateCommand indent=&quot;        &quot; modelInfo= modelInfo/&gt;</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">        &lt;/#list&gt;</span><br><span class="line"></span><br><span class="line">            &lt;#--填充数据模型对象--&gt;</span><br><span class="line">        DataModel dataModel = new DataModel();</span><br><span class="line">        BeanUtil.copyProperties(this, dataModel);</span><br><span class="line">        &lt;#list modelConfig.models as modelInfo&gt;</span><br><span class="line">        &lt;#if modelInfo.groupKey??&gt;</span><br><span class="line">        dataModel.$&#123;modelInfo.groupKey&#125; = $&#123;modelInfo.groupKey&#125;;</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">        &lt;/#list&gt;</span><br><span class="line">        MainGenerator.doGenerate(dataModel);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>发现模板没数据？</p>
<p>原因：因为用户的输入变了，而模板的输入没变</p>
<p>方法：修改模板的参数</p>
<p>这个问题说明：模板和模型参数是强绑定的</p>
<h3 id="模板制作工具"><a href="#模板制作工具" class="headerlink" title="模板制作工具"></a>模板制作工具</h3><h4 id="核心设计"><a href="#核心设计" class="headerlink" title="核心设计"></a>核心设计</h4><p>程序的本质：就是完成原本人工需要的制作</p>
<p>程序能帮我们生成模板文件，生成配置文件</p>
<p><img   src="/../image/Snipaste_2024-02-23_08-42-56.png"  alt="Snipaste_2024-02-23_08-42-56"></p>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p>步骤</p>
<p>1.编写输入流程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//一.输入信息</span><br><span class="line">       //1.项目的基本信息</span><br><span class="line">       //&quot;name&quot;: &quot;acm-template-pro-generator&quot;,</span><br><span class="line">       //  &quot;description&quot;: &quot;ACM 示例模板生成器&quot;,</span><br><span class="line">       String name = &quot;acm-template-generator&quot;;</span><br><span class="line">       String description = &quot;ACM 示例模板生成器&quot;;</span><br><span class="line"></span><br><span class="line">       //2.输入文件信息</span><br><span class="line">       String projectPath = System.getProperty(&quot;user.dir&quot;);</span><br><span class="line">       //要挖坑的项目根目录</span><br><span class="line">       String sourceRootPath = FileUtil.getAbsolutePath(new File(projectPath).getParentFile())</span><br><span class="line">               + File.separator + &quot;code-generator-demo-projects/acm-template&quot;;</span><br><span class="line">       //注意：win系统需要转义：替换\\为/</span><br><span class="line">       sourceRootPath = sourceRootPath.replaceAll(&quot;\\\\&quot;,&quot;/&quot;);</span><br><span class="line"></span><br><span class="line">       //指定具体挖坑的文件（meta.json中的files）</span><br><span class="line">       String fileInputPath = &quot;src/com/yupi/acm/MainTemplate.java&quot;;</span><br><span class="line">       //指定要输出的模板文件</span><br><span class="line">       String fileOutputPath = fileInputPath + &quot;.ftl&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       //3.输入模板参数信息</span><br><span class="line">       Meta.ModelConfig.ModelsInfo modelInfo = new Meta.ModelConfig.ModelsInfo();</span><br><span class="line">       modelInfo.setFieldName(&quot;outputText&quot;);</span><br><span class="line">       modelInfo.setType(&quot;String&quot;);</span><br><span class="line">       modelInfo.setDefaultValue(&quot;sum = &quot;);</span><br></pre></td></tr></table></figure>

<p>2.使用字符串替换生成模板信息和元信息配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//二.使用字符串替换，生成模板文件</span><br><span class="line">String fileInputAbsolutePath = sourceRootPath + File.separator + fileInputPath;</span><br><span class="line">String fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);</span><br><span class="line">String replacement = String.format(&quot;$&#123;%s&#125;&quot;,modelsInfo.getFieldName());</span><br><span class="line">String newFileContent = StrUtil.replace(fileContent,&quot;Sum：&quot;,replacement);</span><br><span class="line"></span><br><span class="line">//输出模板文件</span><br><span class="line">String fileOutPutAbsolutePath = sourceRootPath + File.separator + fileOutputPath;</span><br><span class="line">FileUtil.writeUtf8String(newFileContent, fileOutPutAbsolutePath);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.生成配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//三.生成配置文件</span><br><span class="line">String metaOutputPath = sourceRootPath + File.separator + &quot;meta.json&quot;;</span><br><span class="line"></span><br><span class="line">//1.构造配置参数对象</span><br><span class="line">Meta meta = new Meta();</span><br><span class="line">meta.setName(name);</span><br><span class="line">meta.setDescription(description);</span><br><span class="line"></span><br><span class="line">//利用对象构建文件和模型配置</span><br><span class="line">Meta.FileConfig fileConfig = new Meta.FileConfig();</span><br><span class="line">meta.setFileConfig(fileConfig);</span><br><span class="line">fileConfig.setSourceRootPath(sourceRootPath);</span><br><span class="line">List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">fileConfig.setFiles(fileInfoList);</span><br><span class="line">Meta.FileConfig.FileInfo fileInfo = new Meta.FileConfig.FileInfo();</span><br><span class="line">fileInfo.setInputPath(fileInputPath);</span><br><span class="line">fileInfo.setOutputPath(fileOutputPath);</span><br><span class="line">fileInfo.setType(FileTypeEnum.FILE.getValue());</span><br><span class="line">fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());</span><br><span class="line">fileInfoList.add(fileInfo);</span><br><span class="line"></span><br><span class="line">Meta.ModelConfig modelConfig = new Meta.ModelConfig();</span><br><span class="line">meta.setModelConfig(modelConfig);</span><br><span class="line">List&lt;Meta.ModelConfig.ModelsInfo&gt; modelInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">modelConfig.setModels(modelInfoList);</span><br><span class="line">modelInfoList.add(modelInfo);</span><br><span class="line"></span><br><span class="line">//2.输出元信息文件,toJsonPrettyStr输出格式化好的Json文件</span><br><span class="line">FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(meta), metaOutputPath);</span><br></pre></td></tr></table></figure>



<p>工作空间：为了临时处理一些文件使用的空间（临时的，互相隔离）</p>
<p>1.新建.temp目录</p>
<p>2.修改templateMaker.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">//指定原始项目路径</span><br><span class="line">String projectPath = System.getProperty(&quot;user.dir&quot;);</span><br><span class="line">//要挖坑的项目根目录</span><br><span class="line">String originProjectPath = FileUtil.getAbsolutePath(new File(projectPath).getParentFile())</span><br><span class="line">        + File.separator + &quot;code-generator-demo-projects/acm-template&quot;;</span><br><span class="line">//复制目录</span><br><span class="line">long id = IdUtil.getSnowflakeNextId();</span><br><span class="line">String tempDirPath = projectPath + File.separator + &quot;.temp&quot;;</span><br><span class="line">String templatePath = tempDirPath + File.separator + id;</span><br><span class="line">if (!FileUtil.exist(templatePath))&#123;</span><br><span class="line">    FileUtil.mkdir(templatePath);</span><br><span class="line">&#125;</span><br><span class="line">FileUtil.copy(originProjectPath, templatePath,true);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//一.输入信息</span><br><span class="line">//1.项目的基本信息</span><br><span class="line">//&quot;name&quot;: &quot;acm-template-pro-generator&quot;,</span><br><span class="line">//  &quot;description&quot;: &quot;ACM 示例模板生成器&quot;,</span><br><span class="line">String name = &quot;acm-template-generator&quot;;</span><br><span class="line">String description = &quot;ACM 示例模板生成器&quot;;</span><br><span class="line"></span><br><span class="line">//2.输入文件信息</span><br><span class="line">//要挖坑的项目根目录</span><br><span class="line">String sourceRootPath = templatePath + File.separator + FileUtil.getLastPathEle(Paths.get(originProjectPath)).toString();</span><br><span class="line">//注意：win系统需要转义：替换\\为/</span><br><span class="line">sourceRootPath = sourceRootPath.replaceAll(&quot;\\\\&quot;,&quot;/&quot;);</span><br><span class="line"></span><br><span class="line">//指定具体挖坑的文件（meta.json中的files）</span><br><span class="line">String fileInputPath = &quot;src/com/yupi/acm/MainTemplate.java&quot;;</span><br><span class="line">//指定要输出的模板文件</span><br><span class="line">String fileOutputPath = fileInputPath + &quot;.ftl&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//3.输入模板参数信息</span><br><span class="line">Meta.ModelConfig.ModelsInfo modelInfo = new Meta.ModelConfig.ModelsInfo();</span><br><span class="line">modelInfo.setFieldName(&quot;outputText&quot;);</span><br><span class="line">modelInfo.setType(&quot;String&quot;);</span><br><span class="line">modelInfo.setDefaultValue(&quot;sum = &quot;);</span><br><span class="line"></span><br><span class="line">//二.使用字符串替换，生成模板文件</span><br><span class="line">String fileInputAbsolutePath = sourceRootPath + File.separator + fileInputPath;</span><br><span class="line">String fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);</span><br><span class="line">String replacement = String.format(&quot;$&#123;%s&#125;&quot;,modelInfo.getFieldName());</span><br><span class="line">String newFileContent = StrUtil.replace(fileContent,&quot;Sum: &quot;,replacement);</span><br><span class="line"></span><br><span class="line">//输出模板文件</span><br><span class="line">String fileOutPutAbsolutePath = sourceRootPath + File.separator + fileOutputPath;</span><br><span class="line">FileUtil.writeUtf8String(newFileContent, fileOutPutAbsolutePath);</span><br><span class="line"></span><br><span class="line">//三.生成配置文件</span><br><span class="line">String metaOutputPath = sourceRootPath + File.separator + &quot;meta.json&quot;;</span><br><span class="line"></span><br><span class="line">//1.构造配置参数对象</span><br><span class="line">Meta meta = new Meta();</span><br><span class="line">meta.setName(name);</span><br><span class="line">meta.setDescription(description);</span><br><span class="line"></span><br><span class="line">//利用对象构建文件和模型配置</span><br><span class="line">Meta.FileConfig fileConfig = new Meta.FileConfig();</span><br><span class="line">meta.setFileConfig(fileConfig);</span><br><span class="line">fileConfig.setSourceRootPath(sourceRootPath);</span><br><span class="line">List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">fileConfig.setFiles(fileInfoList);</span><br><span class="line">Meta.FileConfig.FileInfo fileInfo = new Meta.FileConfig.FileInfo();</span><br><span class="line">fileInfo.setInputPath(fileInputPath);</span><br><span class="line">fileInfo.setOutputPath(fileOutputPath);</span><br><span class="line">fileInfo.setType(FileTypeEnum.FILE.getValue());</span><br><span class="line">fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());</span><br><span class="line">fileInfoList.add(fileInfo);</span><br><span class="line"></span><br><span class="line">Meta.ModelConfig modelConfig = new Meta.ModelConfig();</span><br><span class="line">meta.setModelConfig(modelConfig);</span><br><span class="line">List&lt;Meta.ModelConfig.ModelsInfo&gt; modelInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">modelConfig.setModels(modelInfoList);</span><br><span class="line">modelInfoList.add(modelInfo);</span><br><span class="line"></span><br><span class="line">//2.输出元信息文件,toJsonPrettyStr输出格式化好的Json文件</span><br><span class="line">FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(meta), metaOutputPath);</span><br></pre></td></tr></table></figure>





<p>分布制作：追加模板文件的修改，追加配置的生成</p>
<p>挖完一个坑后再执行一次挖第二个坑，之前的坑还要保留</p>
<p>方法：就得让我们的程序有状态</p>
<p>系统，程序，接口请求第二次执行的时候能够保留上一次执行的记忆</p>
<p>实现系统有状态的两个要素</p>
<p>1.系统存储信息</p>
<p>2.唯一标识</p>
<p>对于现在是本地环境，基本上已经实现了</p>
<p>实现：</p>
<p>1.用户id存在</p>
<p>2.实现多次制作</p>
<p>​	1.修改复制目录的逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">long id = IdUtil.getSnowflakeNextId();</span><br><span class="line">String tempDirPath = projectPath + File.separator + &quot;.temp&quot;;</span><br><span class="line">String templatePath = tempDirPath + File.separator + id;</span><br><span class="line">//如果templatePath不存在才复制目录</span><br><span class="line">if (!FileUtil.exist(templatePath))&#123;</span><br><span class="line">    FileUtil.mkdir(templatePath);</span><br><span class="line">    FileUtil.copy(originProjectPath, templatePath,true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	2.判断是否是挖过坑的文件（判断一下同目录下是否有同名的ftl文件即可）</p>
<p>在原本挖过坑的基础上，再去挖坑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String fileContent ;</span><br><span class="line">//如果已有模板文件，表示不是第一次制作，则在原有的模板基础上再挖坑</span><br><span class="line">if (FileUtil.exist(fileOutPutAbsolutePath))&#123;</span><br><span class="line">    //如果不是第一次挖：fileOutPutAbsolutePath表示上次的输出路径</span><br><span class="line">    fileContent = FileUtil.readUtf8String(fileOutPutAbsolutePath);</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    //如果是第一次挖则用的是输入文件</span><br><span class="line">    fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	3.追加配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">//二.使用字符串替换，并得到文件信息</span><br><span class="line">String fileInputAbsolutePath = sourceRootPath + File.separator + fileInputPath;</span><br><span class="line">String fileOutPutAbsolutePath = sourceRootPath + File.separator + fileOutputPath;</span><br><span class="line"></span><br><span class="line">String fileContent ;</span><br><span class="line">//如果已有模板文件，表示不是第一次制作，则在原有的模板基础上再挖坑</span><br><span class="line">if (FileUtil.exist(fileOutPutAbsolutePath))&#123;</span><br><span class="line">    //如果不是第一次挖：fileOutPutAbsolutePath表示上次的输出路径</span><br><span class="line">    fileContent = FileUtil.readUtf8String(fileOutPutAbsolutePath);</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    //如果是第一次挖则用的是输入文件</span><br><span class="line">    fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String replacement = String.format(&quot;$&#123;%s&#125;&quot;,modelInfo.getFieldName());</span><br><span class="line">String newFileContent = StrUtil.replace(fileContent,&quot;Sum: &quot;,replacement);</span><br><span class="line"></span><br><span class="line">//输出模板文件</span><br><span class="line">FileUtil.writeUtf8String(newFileContent, fileOutPutAbsolutePath);</span><br><span class="line"></span><br><span class="line">//文件配置信息</span><br><span class="line">Meta.FileConfig.FileInfo fileInfo = new Meta.FileConfig.FileInfo();</span><br><span class="line">fileInfo.setInputPath(fileInputPath);</span><br><span class="line">fileInfo.setOutputPath(fileOutputPath);</span><br><span class="line">fileInfo.setType(FileTypeEnum.FILE.getValue());</span><br><span class="line">fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());</span><br><span class="line"></span><br><span class="line">//三.生成配置文件</span><br><span class="line">String metaOutputPath = sourceRootPath + File.separator + &quot;meta.json&quot;;</span><br><span class="line"></span><br><span class="line">//已有meta文件不是第一次制作,则在原有的meta基础上进行修改</span><br><span class="line">if (FileUtil.exist(metaOutputPath))&#123;</span><br><span class="line">    //创建meta对象</span><br><span class="line">    Meta oldMeta = JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath),Meta.class);</span><br><span class="line">    //1.追加配置参数</span><br><span class="line">    List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = oldMeta.getFileConfig().getFiles();</span><br><span class="line">    fileInfoList.add(fileInfo);</span><br><span class="line">    </span><br><span class="line">    List&lt;Meta.ModelConfig.ModelsInfo&gt; modelsInfoList = oldMeta.getModelConfig().getModels();</span><br><span class="line">    modelsInfoList.add(modelInfo);</span><br><span class="line"></span><br><span class="line">    //2.生成元信息文件</span><br><span class="line">    FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(oldMeta), metaOutputPath);</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    //1.构造配置参数对象</span><br><span class="line">    Meta meta = new Meta();</span><br><span class="line">    meta.setName(name);</span><br><span class="line">    meta.setDescription(description);</span><br><span class="line"></span><br><span class="line">    //利用对象构建文件配置</span><br><span class="line">    Meta.FileConfig fileConfig = new Meta.FileConfig();</span><br><span class="line">    meta.setFileConfig(fileConfig);</span><br><span class="line">    fileConfig.setSourceRootPath(sourceRootPath);</span><br><span class="line">    List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">    fileConfig.setFiles(fileInfoList);</span><br><span class="line">    </span><br><span class="line">    fileInfoList.add(fileInfo);</span><br><span class="line"></span><br><span class="line">    //利用对象构建模型配置</span><br><span class="line">    Meta.ModelConfig modelConfig = new Meta.ModelConfig();</span><br><span class="line">    meta.setModelConfig(modelConfig);</span><br><span class="line">    List&lt;Meta.ModelConfig.ModelsInfo&gt; modelInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">    modelConfig.setModels(modelInfoList);</span><br><span class="line">    modelInfoList.add(modelInfo);</span><br><span class="line"></span><br><span class="line">    //2.输出元信息文件,toJsonPrettyStr输出格式化好的Json文件</span><br><span class="line">    FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(meta), metaOutputPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>去重</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * 文件去重</span><br><span class="line">     * @param fileInfoList</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private static List&lt;Meta.FileConfig.FileInfo&gt; distinctFiles (List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList)&#123;</span><br><span class="line">        //Meta.FileConfig.FileInfo::getInputPath ：键值  o -&gt; o： FileInfo的每条信息直接返回，不需要对对象进行任何处理，直接作为value</span><br><span class="line">        //(e, r) -&gt; r 表示新值与旧值冲突会选用已经存在的新值</span><br><span class="line">        List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = new ArrayList&lt;&gt;(fileInfoList.stream()</span><br><span class="line">                .collect(</span><br><span class="line">                        Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)</span><br><span class="line">                ).values());</span><br><span class="line">        return newFileInfoList;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 模型去重</span><br><span class="line"> * @param modelInfoList</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">private static List&lt;Meta.ModelConfig.ModelInfo&gt; distinctModels (List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList)&#123;</span><br><span class="line">    //Meta.ModelConfig.ModelInfo::getInputPath ：键值  o -&gt; o： ModelInfo的每条信息直接返回，不需要对对象进行任何处理，直接作为value</span><br><span class="line">    //(e, r) -&gt; r 表示新值与旧值冲突会选用已经存在的新值</span><br><span class="line">    List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = new ArrayList&lt;&gt;(modelInfoList.stream()</span><br><span class="line">            .collect(</span><br><span class="line">                    Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)</span><br><span class="line">            ).values());</span><br><span class="line">    return newModelInfoList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//配置去重</span><br><span class="line">oldMeta.getFileConfig().setFiles(distinctFiles(fileInfoList));</span><br><span class="line">oldMeta.getModelConfig().setModels(distinctModels(modelsInfoList));</span><br></pre></td></tr></table></figure>







<p>修改main方法，将里面的逻辑放到方法中实现，外层只需要把参数放入即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 模板制作工具</span><br><span class="line"> */</span><br><span class="line">public class TemplateMaker &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 制作模板</span><br><span class="line">     *</span><br><span class="line">     * @param newMeta</span><br><span class="line">     * @param originProjectPath</span><br><span class="line">     * @param inputFilePath</span><br><span class="line">     * @param modelInfo</span><br><span class="line">     * @param SearchStr</span><br><span class="line">     * @param id</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private static long makeTemplate(Meta newMeta,String originProjectPath ,String inputFilePath, Meta.ModelConfig.ModelInfo modelInfo,String SearchStr,Long id)&#123;</span><br><span class="line">        //没有id则生成</span><br><span class="line">        if (id == null)&#123;</span><br><span class="line">            id = IdUtil.getSnowflakeNextId();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //业务逻辑...</span><br><span class="line"></span><br><span class="line">        //复制目录</span><br><span class="line">        String projectPath = System.getProperty(&quot;user.dir&quot;);</span><br><span class="line">        String tempDirPath = projectPath + File.separator + &quot;.temp&quot;;</span><br><span class="line">        String templatePath = tempDirPath + File.separator + id;</span><br><span class="line">        if (!FileUtil.exist(templatePath))&#123;</span><br><span class="line">            FileUtil.mkdir(templatePath);</span><br><span class="line">            FileUtil.copy(originProjectPath, templatePath,true);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //一.输入信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //2.输入文件信息</span><br><span class="line">        //要挖坑的项目根目录</span><br><span class="line">        String sourceRootPath = templatePath + File.separator + FileUtil.getLastPathEle(Paths.get(originProjectPath)).toString();</span><br><span class="line">        //注意：win系统需要转义：替换\\为/</span><br><span class="line">        sourceRootPath = sourceRootPath.replaceAll(&quot;\\\\&quot;,&quot;/&quot;);</span><br><span class="line"></span><br><span class="line">        //指定具体挖坑的文件（meta.json中的files）</span><br><span class="line">        //指定要输出的模板文件</span><br><span class="line">        String fileOutputPath = inputFilePath + &quot;.ftl&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //二.使用字符串替换，并得到文件信息</span><br><span class="line">        String fileInputAbsolutePath = sourceRootPath + File.separator + inputFilePath;</span><br><span class="line">        String fileOutPutAbsolutePath = sourceRootPath + File.separator + fileOutputPath;</span><br><span class="line"></span><br><span class="line">        String fileContent ;</span><br><span class="line">        //如果已有模板文件，表示不是第一次制作，则在原有的模板基础上再挖坑</span><br><span class="line">        if (FileUtil.exist(fileOutPutAbsolutePath))&#123;</span><br><span class="line">            //如果不是第一次挖：fileOutPutAbsolutePath表示上次的输出路径</span><br><span class="line">            fileContent = FileUtil.readUtf8String(fileOutPutAbsolutePath);</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            //如果是第一次挖则用的是输入文件</span><br><span class="line">            fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String replacement = String.format(&quot;$&#123;%s&#125;&quot;,modelInfo.getFieldName());</span><br><span class="line">        String newFileContent = StrUtil.replace(fileContent,SearchStr,replacement);</span><br><span class="line"></span><br><span class="line">        //输出模板文件</span><br><span class="line">        FileUtil.writeUtf8String(newFileContent, fileOutPutAbsolutePath);</span><br><span class="line"></span><br><span class="line">        //文件配置信息</span><br><span class="line">        Meta.FileConfig.FileInfo fileInfo = new Meta.FileConfig.FileInfo();</span><br><span class="line">        fileInfo.setInputPath(inputFilePath);</span><br><span class="line">        fileInfo.setOutputPath(fileOutputPath);</span><br><span class="line">        fileInfo.setType(FileTypeEnum.FILE.getValue());</span><br><span class="line">        fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());</span><br><span class="line"></span><br><span class="line">        //三.生成配置文件</span><br><span class="line">        String metaOutputPath = sourceRootPath + File.separator + &quot;meta.json&quot;;</span><br><span class="line"></span><br><span class="line">        //已有meta文件不是第一次制作,则在原有的meta基础上进行修改</span><br><span class="line">        if (FileUtil.exist(metaOutputPath))&#123;</span><br><span class="line">            //创建meta对象</span><br><span class="line">            Meta oldMeta = JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath),Meta.class);</span><br><span class="line">            //1.追加配置参数</span><br><span class="line">            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = oldMeta.getFileConfig().getFiles();</span><br><span class="line">            fileInfoList.add(fileInfo);</span><br><span class="line"></span><br><span class="line">            List&lt;Meta.ModelConfig.ModelInfo&gt; modelsInfoList = oldMeta.getModelConfig().getModels();</span><br><span class="line">            modelsInfoList.add(modelInfo);</span><br><span class="line"></span><br><span class="line">            //配置去重</span><br><span class="line">            oldMeta.getFileConfig().setFiles(distinctFiles(fileInfoList));</span><br><span class="line">            oldMeta.getModelConfig().setModels(distinctModels(modelsInfoList));</span><br><span class="line"></span><br><span class="line">            //2.生成元信息文件</span><br><span class="line">            FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(oldMeta), metaOutputPath);</span><br><span class="line">        &#125;else &#123;</span><br><span class="line"></span><br><span class="line">            //利用对象构建文件配置</span><br><span class="line">            Meta.FileConfig fileConfig = new Meta.FileConfig();</span><br><span class="line">            newMeta.setFileConfig(fileConfig);</span><br><span class="line">            fileConfig.setSourceRootPath(sourceRootPath);</span><br><span class="line">            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">            fileConfig.setFiles(fileInfoList);</span><br><span class="line"></span><br><span class="line">            fileInfoList.add(fileInfo);</span><br><span class="line"></span><br><span class="line">            //利用对象构建模型配置</span><br><span class="line">            Meta.ModelConfig modelConfig = new Meta.ModelConfig();</span><br><span class="line">            newMeta.setModelConfig(modelConfig);</span><br><span class="line">            List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">            modelConfig.setModels(modelInfoList);</span><br><span class="line">            modelInfoList.add(modelInfo);</span><br><span class="line"></span><br><span class="line">            //2.输出元信息文件,toJsonPrettyStr输出格式化好的Json文件</span><br><span class="line">            FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(newMeta), metaOutputPath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //1.项目的基本信息</span><br><span class="line">        Meta meta = new Meta();</span><br><span class="line">        meta.setName(&quot;acm-template-generator&quot;);</span><br><span class="line">        meta.setDescription(&quot;ACM 示例模板生成器&quot;);</span><br><span class="line"></span><br><span class="line">        //指定原始项目路径</span><br><span class="line">        String projectPath = System.getProperty(&quot;user.dir&quot;);</span><br><span class="line">        //要挖坑的项目根目录</span><br><span class="line">        String originProjectPath = FileUtil.getAbsolutePath(new File(projectPath).getParentFile())</span><br><span class="line">                + File.separator + &quot;code-generator-demo-projects/acm-template&quot;;</span><br><span class="line">        String fileInputPath = &quot;src/com/yupi/acm/MainTemplate.java&quot;;</span><br><span class="line"></span><br><span class="line">        //输入模型参数信息</span><br><span class="line">//        Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span><br><span class="line">//        modelInfo.setFieldName(&quot;outputText&quot;);</span><br><span class="line">//        modelInfo.setType(&quot;String&quot;);</span><br><span class="line">//        modelInfo.setDefaultValue(&quot;Sum = &quot;);</span><br><span class="line"></span><br><span class="line">        //输入模型参数信息（第二次）</span><br><span class="line">        Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span><br><span class="line">        modelInfo.setFieldName(&quot;className&quot;);</span><br><span class="line">        modelInfo.setType(&quot;String&quot;);</span><br><span class="line"></span><br><span class="line">        //替换的变量（首次）</span><br><span class="line">//        String searchStr = &quot;Sum: &quot;;</span><br><span class="line"></span><br><span class="line">        String searchStr = &quot;MainTemplate&quot;;</span><br><span class="line"></span><br><span class="line">        TemplateMaker.makeTemplate(meta,originProjectPath,fileInputPath,modelInfo,searchStr,1L);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 文件去重</span><br><span class="line">     * @param fileInfoList</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private static List&lt;Meta.FileConfig.FileInfo&gt; distinctFiles (List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList)&#123;</span><br><span class="line">        //Meta.FileConfig.FileInfo::getInputPath ：键值  o -&gt; o： FileInfo的每条信息直接返回，不需要对对象进行任何处理，直接作为value</span><br><span class="line">        //(e, r) -&gt; r 表示新值与旧值冲突会选用已经存在的新值</span><br><span class="line">        List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = new ArrayList&lt;&gt;(fileInfoList.stream()</span><br><span class="line">                .collect(</span><br><span class="line">                        Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)</span><br><span class="line">                ).values());</span><br><span class="line">        return newFileInfoList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 模型去重</span><br><span class="line">     * @param modelsInfoList</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private static List&lt;Meta.ModelConfig.ModelInfo&gt; distinctModels (List&lt;Meta.ModelConfig.ModelInfo&gt; modelsInfoList)&#123;</span><br><span class="line">        //Meta.ModelConfig.ModelInfo::getInputPath ：键值  o -&gt; o： ModelInfo的每条信息直接返回，不需要对对象进行任何处理，直接作为value</span><br><span class="line">        //(e, r) -&gt; r 表示新值与旧值冲突会选用已经存在的新值</span><br><span class="line">        List&lt;Meta.ModelConfig.ModelInfo&gt; newModelsInfoList = new ArrayList&lt;&gt;(modelsInfoList.stream()</span><br><span class="line">                .collect(</span><br><span class="line">                        Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)</span><br><span class="line">                ).values());</span><br><span class="line">        return newModelsInfoList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="单次执行可以制作多个模板文件"><a href="#单次执行可以制作多个模板文件" class="headerlink" title="单次执行可以制作多个模板文件"></a>单次执行可以制作多个模板文件</h4><p>方法：</p>
<p>1.指定一个目录，把这个目录下的所有文件都挖坑</p>
<p>2.同时输入多个路径</p>
<p>指定一个目录，把这个目录下的所有文件都挖坑</p>
<p>方法：先遍历文件夹内部的所有文件，在原本单个文件填充的方法上增加for循环</p>
<p>把makeTemplate方法中的获取单个文件信息和输入的配置抽出来变成一个方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static Meta.FileConfig.FileInfo makeFileTemplate(Meta.ModelConfig.ModelInfo modelInfo, String SearchStr, String sourceRootPath,File inputFile)</span><br></pre></td></tr></table></figure>

<p>一.为什么传的参数为File</p>
<p>1.首先遍历文件夹时使用的路径是绝对路径，如果传的是相对路径还得拼，索性直接传File对象</p>
<p>2.而meta.json中是用相对路径，所以还需要转换</p>
<p>3.而且外层遍历直接遍历的是File对象</p>
<p>二.为什么少用sourceRootPath</p>
<p>因为以后要到线上环境可能要对这个变量做特殊处理，能少用就少用</p>
<p><strong>1.制作单个模板文件的方法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * 制作模板文件</span><br><span class="line">    *</span><br><span class="line">    * @param modelInfo 模板信息</span><br><span class="line">    * @param SearchStr 搜索关键字</span><br><span class="line">    * @param sourceRootPath 源文件路径</span><br><span class="line">    * @param inputFile 输入的文件</span><br><span class="line">    * @return 文件配置信息</span><br><span class="line">    */</span><br><span class="line">   private static Meta.FileConfig.FileInfo makeFileTemplate(Meta.ModelConfig.ModelInfo modelInfo, String SearchStr, String sourceRootPath,File inputFile) &#123;</span><br><span class="line"></span><br><span class="line">       String fileInputAbsolutePath = inputFile.getAbsolutePath();</span><br><span class="line"></span><br><span class="line">       //注意win系统需要对路径进行转义</span><br><span class="line">       fileInputAbsolutePath = fileInputAbsolutePath.replaceAll(&quot;\\\\&quot;,&quot;/&quot;);</span><br><span class="line"></span><br><span class="line">       //指定具体挖坑的文件（meta.json中的files）</span><br><span class="line">       //去掉绝对路径当中相对路径前面的路径（注意一定要是相对路径）</span><br><span class="line">       String fileInputPath = fileInputAbsolutePath.replace(sourceRootPath+&quot;/&quot;,&quot;&quot;);</span><br><span class="line">       String fileOutputPath = fileInputPath + &quot;.ftl&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       //二.使用字符串替换，并得到文件信息</span><br><span class="line">       String fileOutPutAbsolutePath = fileInputAbsolutePath+&quot;.ftl&quot;;</span><br><span class="line"></span><br><span class="line">       String fileContent ;</span><br><span class="line">       //如果已有模板文件，表示不是第一次制作，则在原有的模板基础上再挖坑</span><br><span class="line">       if (FileUtil.exist(fileOutPutAbsolutePath))&#123;</span><br><span class="line">           //如果不是第一次挖：fileOutPutAbsolutePath表示上次的输出路径</span><br><span class="line">           fileContent = FileUtil.readUtf8String(fileOutPutAbsolutePath);</span><br><span class="line">       &#125;else &#123;</span><br><span class="line">           //如果是第一次挖则用的是输入文件</span><br><span class="line">           fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       String replacement = String.format(&quot;$&#123;%s&#125;&quot;, modelInfo.getFieldName());</span><br><span class="line">       String newFileContent = StrUtil.replace(fileContent, SearchStr,replacement);</span><br><span class="line"></span><br><span class="line">       //输出模板文件</span><br><span class="line">       FileUtil.writeUtf8String(newFileContent, fileOutPutAbsolutePath);</span><br><span class="line"></span><br><span class="line">       //文件配置信息</span><br><span class="line">       Meta.FileConfig.FileInfo fileInfo = new Meta.FileConfig.FileInfo();</span><br><span class="line">       fileInfo.setInputPath(fileInputPath);</span><br><span class="line">       fileInfo.setOutputPath(fileOutputPath);</span><br><span class="line">       fileInfo.setType(FileTypeEnum.FILE.getValue());</span><br><span class="line">       fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());</span><br><span class="line">       return fileInfo;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<p><strong>2.实现遍历目录的方法</strong></p>
<p>把TemplateMaker的方法逻辑从原本的制作单个文件变成制作多个文件逻辑（生成配置的逻辑基本上不变，就是多了遍历逻辑和把所有的文件添加列表里）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * 制作模板</span><br><span class="line">     *</span><br><span class="line">     * @param newMeta</span><br><span class="line">     * @param originProjectPath</span><br><span class="line">     * @param inputFilePath</span><br><span class="line">     * @param modelInfo</span><br><span class="line">     * @param SearchStr</span><br><span class="line">     * @param id</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private static long makeTemplate(Meta newMeta,String originProjectPath ,String inputFilePath, Meta.ModelConfig.ModelInfo modelInfo,String SearchStr,Long id)&#123;</span><br><span class="line">        //没有id则生成</span><br><span class="line">        if (id == null)&#123;</span><br><span class="line">            id = IdUtil.getSnowflakeNextId();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //业务逻辑...</span><br><span class="line"></span><br><span class="line">        //复制目录</span><br><span class="line">        String projectPath = System.getProperty(&quot;user.dir&quot;);</span><br><span class="line">        String tempDirPath = projectPath + File.separator + &quot;.temp&quot;;</span><br><span class="line">        String templatePath = tempDirPath + File.separator + id;</span><br><span class="line">        if (!FileUtil.exist(templatePath))&#123;</span><br><span class="line">            FileUtil.mkdir(templatePath);</span><br><span class="line">            FileUtil.copy(originProjectPath, templatePath,true);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //一.输入信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //2.输入文件信息</span><br><span class="line">        //要挖坑的项目根目录</span><br><span class="line">        File tempFile = new File(templatePath);</span><br><span class="line">        templatePath = tempFile.getAbsolutePath();</span><br><span class="line">        String sourceRootPath = templatePath + File.separator + FileUtil.getLastPathEle(Paths.get(originProjectPath)).toString();</span><br><span class="line">        //注意win系统需要对路径进行转义</span><br><span class="line">        sourceRootPath = sourceRootPath.replaceAll(&quot;\\\\&quot;,&quot;/&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //将外层输入的相对路径修改为绝对路径</span><br><span class="line">        String inputFileAbsolutePath = sourceRootPath + File.separator + inputFilePath;</span><br><span class="line">        List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">        if (FileUtil.isDirectory(inputFileAbsolutePath))&#123;</span><br><span class="line">            //如果是目录则遍历</span><br><span class="line">            //循环遍历指定绝对路径中的子文件</span><br><span class="line">            List&lt;File&gt; fileList = FileUtil.loopFiles(inputFileAbsolutePath);</span><br><span class="line">            //先遍历后处理</span><br><span class="line">            for(File file: fileList)&#123;</span><br><span class="line">                Meta.FileConfig.FileInfo fileInfo = makeFileTemplate(modelInfo, SearchStr, sourceRootPath, file);</span><br><span class="line">                newFileInfoList.add(fileInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            //如果不是目录则直接处理</span><br><span class="line">            Meta.FileConfig.FileInfo fileInfo = makeFileTemplate(modelInfo, SearchStr, sourceRootPath, new File(inputFileAbsolutePath));</span><br><span class="line">            newFileInfoList.add(fileInfo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //三.生成配置文件</span><br><span class="line">        String metaOutputPath = sourceRootPath + File.separator + &quot;meta.json&quot;;</span><br><span class="line"></span><br><span class="line">        //已有meta文件不是第一次制作,则在原有的meta基础上进行修改</span><br><span class="line">        if (FileUtil.exist(metaOutputPath))&#123;</span><br><span class="line">            //创建meta对象</span><br><span class="line">            Meta oldMeta = JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath),Meta.class);</span><br><span class="line">            //1.追加配置参数</span><br><span class="line">            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = oldMeta.getFileConfig().getFiles();</span><br><span class="line">            fileInfoList.addAll(newFileInfoList);</span><br><span class="line"></span><br><span class="line">            List&lt;Meta.ModelConfig.ModelInfo&gt; modelsInfoList = oldMeta.getModelConfig().getModels();</span><br><span class="line">            modelsInfoList.add(modelInfo);</span><br><span class="line"></span><br><span class="line">            //配置去重</span><br><span class="line">            oldMeta.getFileConfig().setFiles(distinctFiles(fileInfoList));</span><br><span class="line">            oldMeta.getModelConfig().setModels(distinctModels(modelsInfoList));</span><br><span class="line"></span><br><span class="line">            //2.生成元信息文件</span><br><span class="line">            FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(oldMeta), metaOutputPath);</span><br><span class="line">        &#125;else &#123;</span><br><span class="line"></span><br><span class="line">            //利用对象构建文件配置</span><br><span class="line">            Meta.FileConfig fileConfig = new Meta.FileConfig();</span><br><span class="line">            newMeta.setFileConfig(fileConfig);</span><br><span class="line">            fileConfig.setSourceRootPath(sourceRootPath);</span><br><span class="line">            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">            fileConfig.setFiles(fileInfoList);</span><br><span class="line"></span><br><span class="line">            fileInfoList.addAll(newFileInfoList);</span><br><span class="line"></span><br><span class="line">            //利用对象构建模型配置</span><br><span class="line">            Meta.ModelConfig modelConfig = new Meta.ModelConfig();</span><br><span class="line">            newMeta.setModelConfig(modelConfig);</span><br><span class="line">            List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">            modelConfig.setModels(modelInfoList);</span><br><span class="line">            modelInfoList.add(modelInfo);</span><br><span class="line"></span><br><span class="line">            //2.输出元信息文件,toJsonPrettyStr输出格式化好的Json文件</span><br><span class="line">            FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(newMeta), metaOutputPath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>用Windows开发的缺点：路径分割符转义很麻烦 &#x2F; -&gt;&gt;&gt; \</p>
<p><strong>发现meta.json的文件很长</strong></p>
<p>如果某个文件没有被替换，是不是就不用替换，也就不需要生成模板，是不是可以以静态模式的方式记录到files中，需要添加逻辑</p>
<p>修改生成的逻辑，如果是没有用到对应的SearchStr则静态生成，不生成模板，如果用到了就动态生成，并且生成模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//和原文件内容一致，没有挖坑，静态生成</span><br><span class="line">if (newFileContent.equals(fileContent))&#123;</span><br><span class="line">    //如果是静态生成的话，输入路径 = 输出路径</span><br><span class="line">    fileInfo.setOutputPath(fileInputPath);</span><br><span class="line">    fileInfo.setGenerateType(FileGenerateTypeEnum.STATIC.getValue());</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());</span><br><span class="line">    //输出模板文件</span><br><span class="line">    FileUtil.writeUtf8String(newFileContent, fileOutPutAbsolutePath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="实现选中多个文件进行指定生成"><a href="#实现选中多个文件进行指定生成" class="headerlink" title="实现选中多个文件进行指定生成"></a>实现选中多个文件进行指定生成</h4><p>已经实现遍历生成，只需要修改方法的参数，让它支持多个文件然后遍历即可</p>
<p>把输入参数String inputFilePath-&gt;List<String> inputFilePathlist</p>
<p>然后修改下遍历逻辑(就增加个for循环)，无论多少层for循环，都把得到的信息放到newFileInfoList</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">for (String inputFilePath : inputFilePathlist) &#123;</span><br><span class="line">    //将外层输入的相对路径修改为绝对路径</span><br><span class="line">    String inputFileAbsolutePath = sourceRootPath + File.separator + inputFilePath;</span><br><span class="line"></span><br><span class="line">    if (FileUtil.isDirectory(inputFileAbsolutePath))&#123;</span><br><span class="line">        //如果是目录则遍历</span><br><span class="line">        //循环遍历指定绝对路径中的子文件</span><br><span class="line">        List&lt;File&gt; fileList = FileUtil.loopFiles(inputFileAbsolutePath);</span><br><span class="line">        //先遍历后处理</span><br><span class="line">        for(File file: fileList)&#123;</span><br><span class="line">            Meta.FileConfig.FileInfo fileInfo = makeFileTemplate(modelInfo, SearchStr, sourceRootPath, file);</span><br><span class="line">            newFileInfoList.add(fileInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        //如果不是目录则直接处理</span><br><span class="line">        Meta.FileConfig.FileInfo fileInfo = makeFileTemplate(modelInfo, SearchStr, sourceRootPath, new File(inputFileAbsolutePath));</span><br><span class="line">        newFileInfoList.add(fileInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：main方法下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">  //1.项目的基本信息</span><br><span class="line">        Meta meta = new Meta();</span><br><span class="line">        meta.setName(&quot;acm-template-generator&quot;);</span><br><span class="line">        meta.setDescription(&quot;ACM 示例模板生成器&quot;);</span><br><span class="line"></span><br><span class="line">        //指定原始项目路径</span><br><span class="line">        String projectPath = System.getProperty(&quot;user.dir&quot;);</span><br><span class="line">        //要挖坑的项目根目录</span><br><span class="line">        String originProjectPath = FileUtil.getAbsolutePath(new File(projectPath).getParentFile())</span><br><span class="line">                + File.separator + &quot;code-generator-demo-projects/springboot-init&quot;;</span><br><span class="line">        String fileInputPath1 = &quot;src/main/java/com/yupi/springbootinit/common&quot;;</span><br><span class="line">        String fileInputPath2 = &quot;src/main/java/com/yupi/springbootinit/controller&quot;;</span><br><span class="line">        List&lt;String&gt; inputFilePathList = Arrays.asList(fileInputPath1,fileInputPath2);</span><br><span class="line"></span><br><span class="line">        //输入模型参数信息</span><br><span class="line">//        Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span><br><span class="line">//        modelInfo.setFieldName(&quot;outputText&quot;);</span><br><span class="line">//        modelInfo.setType(&quot;String&quot;);</span><br><span class="line">//        modelInfo.setDefaultValue(&quot;Sum = &quot;);</span><br><span class="line"></span><br><span class="line">        //输入模型参数信息（第二次）</span><br><span class="line">        Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span><br><span class="line">        modelInfo.setFieldName(&quot;className&quot;);</span><br><span class="line">        modelInfo.setType(&quot;String&quot;);</span><br><span class="line"></span><br><span class="line">        //替换的变量（首次）</span><br><span class="line">//        String searchStr = &quot;Sum: &quot;;</span><br><span class="line"></span><br><span class="line">        String searchStr = &quot;BaseResponse&quot;;</span><br><span class="line"></span><br><span class="line">        long id = TemplateMaker.makeTemplate(meta, originProjectPath, inputFilePathList, modelInfo, searchStr, null);</span><br><span class="line">        System.out.println(id);</span><br></pre></td></tr></table></figure>

<p>现在就实现了使用一次模板去挖多任意目录或者文件下的模板</p>
<h4 id="文件过滤"><a href="#文件过滤" class="headerlink" title="文件过滤"></a>文件过滤</h4><p>问题：如果是分散在不同目录下的文件该如何实现？</p>
<p>虽然可以指定多个目录，但还是得输入多个目录，还得指定多个配置</p>
<p>方法：实现文件过滤（通用：可以应用到多个系统）</p>
<p>分类：</p>
<p>1.过滤范围：名称，文件内容</p>
<p>2.过滤规则：包含，前缀，后缀，正则，相等</p>
<p>给每个文件和目录都指定过滤规则，而不是每一次执行制作指定一个大的过滤规则，而且能指定多条过滤规则（必须同时满足），进一步提高灵活性</p>
<p>步骤</p>
<p>1.构造文件过滤配置类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 文件过滤配置</span><br><span class="line"> */</span><br><span class="line">//@Builder构造实体类方便</span><br><span class="line">@Data</span><br><span class="line">@Builder</span><br><span class="line">public class FileFilterConfig &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 过滤范围</span><br><span class="line">     */</span><br><span class="line">    private String range;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 过滤规则</span><br><span class="line">     */</span><br><span class="line">    private String rule;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 过滤值</span><br><span class="line">     */</span><br><span class="line">    private String value;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2.在与文件过滤类同级目录下建立TemplateMakerFileConfig类（支持多个文件的配置）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 文件过滤配置JSON实体类:控制多个模板文件的配置</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">public class TemplateMakerFileConfig &#123;</span><br><span class="line"></span><br><span class="line">    private List&lt;FileInfoConfig&gt; files;</span><br><span class="line"></span><br><span class="line">    @NoArgsConstructor</span><br><span class="line">    @Data</span><br><span class="line">    public static class FileInfoConfig&#123;</span><br><span class="line">        private String path;</span><br><span class="line"></span><br><span class="line">        private List&lt;FileFilterConfig&gt; fileFilterConfigList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>3.因为定义了多种过滤规则，可以考虑用枚举类定义，因为可能有多处要用到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 文件过滤范围枚举</span><br><span class="line"> */</span><br><span class="line">public enum FileFilterRangeEnum &#123;</span><br><span class="line">    FILE_NAME(&quot;文件名称&quot;,&quot;fileName&quot;),</span><br><span class="line">    FILE_CONTENT(&quot;文件内容&quot;,&quot;fileContent&quot;);</span><br><span class="line"></span><br><span class="line">    private final String text;</span><br><span class="line"></span><br><span class="line">    private final String value;</span><br><span class="line"></span><br><span class="line">    FileFilterRangeEnum(String text, String value)&#123;</span><br><span class="line">        this.text = text;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getText() &#123;</span><br><span class="line">        return text;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getValue() &#123;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static FileFilterRangeEnum getEnumByValue(String value)&#123;</span><br><span class="line"></span><br><span class="line">        if (ObjectUtil.isEmpty(value))&#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        for (FileFilterRangeEnum anEnum : FileFilterRangeEnum.values())&#123;</span><br><span class="line">            if(anEnum.value.equals(value))&#123;</span><br><span class="line">                return anEnum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 文件过滤规则枚举</span><br><span class="line"> */</span><br><span class="line">public enum FileFilterRuleEnum &#123;</span><br><span class="line">    CONTAINS(&quot;包含&quot;,&quot;contains&quot;),</span><br><span class="line">    STARTS_WITH(&quot;前缀匹配&quot;,&quot;startsWith&quot;),</span><br><span class="line">    ENDS_WITH(&quot;后缀匹配&quot;,&quot;endsWith&quot;),</span><br><span class="line">    REGEX(&quot;正则&quot;,&quot;regex&quot;),</span><br><span class="line">    EQUALS(&quot;相等&quot;,&quot;equals&quot;);</span><br><span class="line"></span><br><span class="line">    private final String text;</span><br><span class="line"></span><br><span class="line">    private final String value;</span><br><span class="line"></span><br><span class="line">    FileFilterRuleEnum(String text, String value)&#123;</span><br><span class="line">        this.text = text;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getText() &#123;</span><br><span class="line">        return text;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getValue() &#123;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static FileFilterRuleEnum getEnumByValue(String value)&#123;</span><br><span class="line"></span><br><span class="line">        if (ObjectUtil.isEmpty(value))&#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        for (FileFilterRuleEnum anEnum : FileFilterRuleEnum.values())&#123;</span><br><span class="line">            if(anEnum.value.equals(value))&#123;</span><br><span class="line">                return anEnum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>4.实现单个文件过滤</p>
<p>文件范围有两种情况，文件规则有五种情况，总共有十种，不可能每种都一个个写</p>
<p>无论是哪种过滤，都要去查看某个字符串包含某种内容，是否符合我的规则</p>
<p>可以用一个变量统一两种情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//要过滤的原内容</span><br><span class="line">//提前统一变量</span><br><span class="line">String content = fileName;</span><br><span class="line">switch (fileFilterRangeEnum)&#123;</span><br><span class="line">    </span><br><span class="line">    case FILE_NAME:</span><br><span class="line">        content = fileName;</span><br><span class="line">        break;</span><br><span class="line">    case FILE_CONTENT:</span><br><span class="line">        content = fileContent;</span><br><span class="line">        break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样做下面写逻辑就不用区分是fileName还是fileContent了</p>
<p>单个文件过滤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">public class FileFilter &#123;</span><br><span class="line">    </span><br><span class="line">     /**</span><br><span class="line">     * 单个文件过滤</span><br><span class="line">     *</span><br><span class="line">     * @param fileFilterConfigList 过滤配置</span><br><span class="line">     * @param file 过滤的文件</span><br><span class="line">     * @return 过滤还是不过滤</span><br><span class="line">     */</span><br><span class="line">    public boolean doSingleFileFilter(List&lt;FileFilterConfig&gt; fileFilterConfigList, File file)&#123;</span><br><span class="line">        </span><br><span class="line">        //获取目标文件的名字和内容</span><br><span class="line">        String fileName = file.getName();</span><br><span class="line">        String fileContent = FileUtil.readUtf8String(file);</span><br><span class="line">        </span><br><span class="line">        //所有校验器结束后的结果</span><br><span class="line">        boolean result = true;</span><br><span class="line">        </span><br><span class="line">        //如果没过滤条件直接不过滤,返回true</span><br><span class="line">        if (CollUtil.isEmpty(fileFilterConfigList))&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //遍历所有的配置</span><br><span class="line">        for (FileFilterConfig fileFilterConfig : fileFilterConfigList) &#123;</span><br><span class="line">            String range = fileFilterConfig.getRange();</span><br><span class="line">            String rule = fileFilterConfig.getRule();</span><br><span class="line">            String value = fileFilterConfig.getValue();</span><br><span class="line"></span><br><span class="line">            FileFilterRangeEnum fileFilterRangeEnum = FileFilterRangeEnum.getEnumByValue(range);</span><br><span class="line">            if (fileFilterRangeEnum == null)&#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            //要过滤的原内容</span><br><span class="line">            String content = fileName;</span><br><span class="line">            switch (fileFilterRangeEnum)&#123;</span><br><span class="line"></span><br><span class="line">                case FILE_NAME:</span><br><span class="line">                    content = fileName;</span><br><span class="line">                    break;</span><br><span class="line">                case FILE_CONTENT:</span><br><span class="line">                    content = fileContent;</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            FileFilterRuleEnum fileFilterRuleEnum = FileFilterRuleEnum.getEnumByValue(rule);</span><br><span class="line">            if (fileFilterRuleEnum == null)&#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            switch (fileFilterRuleEnum)&#123;</span><br><span class="line">                case CONTAINS:</span><br><span class="line">                    result = content.contains(value);</span><br><span class="line">                    break;</span><br><span class="line">                case STARTS_WITH:</span><br><span class="line">                    result = content.startsWith(value);</span><br><span class="line">                    break;</span><br><span class="line">                case ENDS_WITH:</span><br><span class="line">                    result = content.endsWith(value);</span><br><span class="line">                    break;</span><br><span class="line">                case REGEX:</span><br><span class="line">                    result = content.matches(value);</span><br><span class="line">                    break;</span><br><span class="line">                case EQUALS:</span><br><span class="line">                    result = content.equals(value);</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">            &#125;</span><br><span class="line">            //有一个不满足就返回</span><br><span class="line">            if (!result)&#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //都满足</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 对某个文件或目录进行过滤，返回文件列表</span><br><span class="line"> *</span><br><span class="line"> * @param filePath</span><br><span class="line"> * @param fileFilterConfigList</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">public static List&lt;File&gt; doFilter(String filePath, List&lt;FileFilterConfig&gt; fileFilterConfigList)&#123;</span><br><span class="line">    //首先根据路径获取所有文件</span><br><span class="line">    List&lt;File&gt; fileList = FileUtil.loopFiles(filePath);</span><br><span class="line">    return fileList.stream()</span><br><span class="line">            .filter(file -&gt; doSingleFileFilter(fileFilterConfigList, file))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>修改makeTemplate的参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; inputFilePathlist</span><br></pre></td></tr></table></figure>

<p>变为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TemplateMakerFileConfig templateMakerFileConfig</span><br></pre></td></tr></table></figure>

<p>这样就可以同时传入文件和过滤器的配置</p>
<p>修改makeTemplate的遍历逻辑：只是把原来的从list中取文件变成从对象当中取而已</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//获取文件配置列表</span><br><span class="line">List&lt;TemplateMakerFileConfig.FileInfoConfig&gt; fileInfoConfigList = templateMakerFileConfig.getFiles();</span><br><span class="line"></span><br><span class="line">//支持遍历输入文件</span><br><span class="line">List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">//遍历文件配置,每个文件都要路径和文件过滤列表</span><br><span class="line">for (TemplateMakerFileConfig.FileInfoConfig fileInfoConfig : fileInfoConfigList) &#123;</span><br><span class="line">    String inputFilePath = fileInfoConfig.getPath();</span><br><span class="line">    //将外层输入的相对路径修改为绝对路径</span><br><span class="line">    String inputFileAbsolutePath = sourceRootPath + File.separator + inputFilePath;</span><br><span class="line"></span><br><span class="line">    if (FileUtil.isDirectory(inputFileAbsolutePath))&#123;</span><br><span class="line">        //如果是目录则遍历</span><br><span class="line">        //循环遍历指定绝对路径中的子文件</span><br><span class="line">        List&lt;File&gt; fileList = FileUtil.loopFiles(inputFileAbsolutePath);</span><br><span class="line">        //先遍历后处理</span><br><span class="line">        for(File file: fileList)&#123;</span><br><span class="line">            Meta.FileConfig.FileInfo fileInfo = makeFileTemplate(modelInfo, SearchStr, sourceRootPath, file);</span><br><span class="line">            newFileInfoList.add(fileInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        //如果不是目录则直接处理</span><br><span class="line">        Meta.FileConfig.FileInfo fileInfo = makeFileTemplate(modelInfo, SearchStr, sourceRootPath, new File(inputFileAbsolutePath));</span><br><span class="line">        newFileInfoList.add(fileInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>变为，因为doFilter方法中有使用直接取得文件的方法，所以无需再进行判断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//获取文件配置列表</span><br><span class="line">List&lt;TemplateMakerFileConfig.FileInfoConfig&gt; fileInfoConfigList = templateMakerFileConfig.getFiles();</span><br><span class="line"></span><br><span class="line">//支持遍历输入文件</span><br><span class="line">List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">//遍历文件配置,每个文件都要路径和文件过滤列表</span><br><span class="line">for (TemplateMakerFileConfig.FileInfoConfig fileInfoConfig : fileInfoConfigList) &#123;</span><br><span class="line">    String inputFilePath = fileInfoConfig.getPath();</span><br><span class="line">    //将外层输入的相对路径修改为绝对路径</span><br><span class="line">    String inputFileAbsolutePath = sourceRootPath + File.separator + inputFilePath;</span><br><span class="line"></span><br><span class="line">    //传入绝对路径,进行过滤</span><br><span class="line">    //得到过滤后的文件列表</span><br><span class="line">    List&lt;File&gt; fileList = FileFilter.doFilter(inputFilePath, fileInfoConfig.getFileFilterConfigList());</span><br><span class="line">    //直接遍历文件去制作模板</span><br><span class="line">    for (File file : fileList) &#123;</span><br><span class="line">        Meta.FileConfig.FileInfo fileInfo = makeFileTemplate(modelInfo, SearchStr, sourceRootPath, file);</span><br><span class="line">        newFileInfoList.add(fileInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"> public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //1.项目的基本信息</span><br><span class="line">        Meta meta = new Meta();</span><br><span class="line">        meta.setName(&quot;acm-template-generator&quot;);</span><br><span class="line">        meta.setDescription(&quot;ACM 示例模板生成器&quot;);</span><br><span class="line"></span><br><span class="line">        //指定原始项目路径</span><br><span class="line">        String projectPath = System.getProperty(&quot;user.dir&quot;);</span><br><span class="line">        //要挖坑的项目根目录</span><br><span class="line">        String originProjectPath = FileUtil.getAbsolutePath(new File(projectPath).getParentFile())</span><br><span class="line">                + File.separator + &quot;code-generator-demo-projects/springboot-init&quot;;</span><br><span class="line">        String fileInputPath1 = &quot;src/main/java/com/yupi/springbootinit/common&quot;;</span><br><span class="line">        String fileInputPath2 = &quot;src/main/java/com/yupi/springbootinit/controller&quot;;</span><br><span class="line">        List&lt;String&gt; inputFilePathList = Arrays.asList(fileInputPath1,fileInputPath2);</span><br><span class="line"></span><br><span class="line">        //输入模型参数信息</span><br><span class="line">//        Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span><br><span class="line">//        modelInfo.setFieldName(&quot;outputText&quot;);</span><br><span class="line">//        modelInfo.setType(&quot;String&quot;);</span><br><span class="line">//        modelInfo.setDefaultValue(&quot;Sum = &quot;);</span><br><span class="line"></span><br><span class="line">        //输入模型参数信息（第二次）</span><br><span class="line">        Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span><br><span class="line">        modelInfo.setFieldName(&quot;className&quot;);</span><br><span class="line">        modelInfo.setType(&quot;String&quot;);</span><br><span class="line"></span><br><span class="line">        //替换的变量（首次）</span><br><span class="line">//        String searchStr = &quot;Sum: &quot;;</span><br><span class="line"></span><br><span class="line">        String searchStr = &quot;BaseResponse&quot;;</span><br><span class="line"></span><br><span class="line">        //文件过滤配置</span><br><span class="line">        TemplateMakerFileConfig.FileInfoConfig fileInfoConfig1 = new TemplateMakerFileConfig.FileInfoConfig();</span><br><span class="line">        //传入文件1的路径</span><br><span class="line">        fileInfoConfig1.setPath(fileInputPath1);</span><br><span class="line">        List&lt;FileFilterConfig&gt; fileFilterConfigList = new ArrayList&lt;&gt;();</span><br><span class="line">        //构造过滤规则,这种写法的前提是在该类上加@Builder注解</span><br><span class="line">        //过滤包含Base文件名的文件</span><br><span class="line">        FileFilterConfig fileFilterConfig = FileFilterConfig.builder()</span><br><span class="line">                .range(FileFilterRangeEnum.FILE_NAME.getValue())</span><br><span class="line">                .rule(FileFilterRuleEnum.CONTAINS.getValue())</span><br><span class="line">                .value(&quot;Base&quot;)</span><br><span class="line">                .build();</span><br><span class="line">        fileFilterConfigList.add(fileFilterConfig);</span><br><span class="line">        fileInfoConfig1.setFileFilterConfigList(fileFilterConfigList);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        TemplateMakerFileConfig.FileInfoConfig fileInfoConfig2 = new TemplateMakerFileConfig.FileInfoConfig();</span><br><span class="line">        fileInfoConfig2.setPath(fileInputPath2);</span><br><span class="line"></span><br><span class="line">        List&lt;TemplateMakerFileConfig.FileInfoConfig&gt; fileInfoConfigList = Arrays.asList(fileInfoConfig1,fileInfoConfig2);</span><br><span class="line">        </span><br><span class="line">        TemplateMakerFileConfig templateMakerFileConfig = new TemplateMakerFileConfig();</span><br><span class="line">        templateMakerFileConfig.setFiles(fileInfoConfigList);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        long id = TemplateMaker.makeTemplate(meta, originProjectPath, templateMakerFileConfig, modelInfo, searchStr, null);</span><br><span class="line">        System.out.println(id);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<h4 id="文件分组"><a href="#文件分组" class="headerlink" title="文件分组"></a>文件分组</h4><p>meta.JSON文件本身就支持分组</p>
<p>对哪些文件进行分组？</p>
<p>策略</p>
<p>1.把每次制作的对象分成一个组</p>
<p>2.每个单元文件分成不同的组</p>
<p>1.在TemplateMakerFileConfig类下加FileGroupConfig类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class TemplateMakerFileConfig &#123;</span><br><span class="line"></span><br><span class="line">    private List&lt;FileInfoConfig&gt; files;</span><br><span class="line"></span><br><span class="line">    private FileGroupConfig fileGroupConfig;</span><br><span class="line"></span><br><span class="line">    @NoArgsConstructor</span><br><span class="line">    @Data</span><br><span class="line">    public static class FileInfoConfig&#123;</span><br><span class="line">        private String path;</span><br><span class="line"></span><br><span class="line">        private List&lt;FileFilterConfig&gt; fileFilterConfigList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Data</span><br><span class="line">    public static class FileGroupConfig&#123;</span><br><span class="line"></span><br><span class="line">        private String condition;</span><br><span class="line">        private String groupKey;</span><br><span class="line">        private String groupName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.在makeTemplate下加这个逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//分组配置</span><br><span class="line">//如果是文件组</span><br><span class="line">TemplateMakerFileConfig.FileGroupConfig fileGroupConfig = templateMakerFileConfig.getFileGroupConfig();</span><br><span class="line">if (fileGroupConfig != null)&#123;</span><br><span class="line">    String condition = fileGroupConfig.getCondition();</span><br><span class="line">    String groupKey = fileGroupConfig.getGroupKey();</span><br><span class="line">    String groupName = fileGroupConfig.getGroupName();</span><br><span class="line"></span><br><span class="line">    Meta.FileConfig.FileInfo goupFileInfo = new Meta.FileConfig.FileInfo();</span><br><span class="line">    goupFileInfo.setCondition(condition);</span><br><span class="line">    goupFileInfo.setGroupKey(groupKey);</span><br><span class="line">    goupFileInfo.setGroupName(groupName);</span><br><span class="line">    //把外层文件全放到一个分组内，相当于把多层文件放在了一个包下</span><br><span class="line">    goupFileInfo.setFiles(newFileInfoList);</span><br><span class="line">    newFileInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">    newFileInfoList.add(goupFileInfo);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：在main下加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//分组配置</span><br><span class="line">TemplateMakerFileConfig.FileGroupConfig fileGroupConfig = new TemplateMakerFileConfig.FileGroupConfig();</span><br><span class="line">fileGroupConfig.setCondition(&quot;outputText&quot;);</span><br><span class="line">fileGroupConfig.setGroupKey(&quot;test&quot;);</span><br><span class="line">fileGroupConfig.setGroupName(&quot;测试分组&quot;);</span><br><span class="line">templateMakerFileConfig.setFileGroupConfig(fileGroupConfig);</span><br></pre></td></tr></table></figure>



<p>此时，去重校验就无法起作用，因为去重校验是根据输入文件去指定的，但是分组的文件是没有输入路径的，那么该如何实现？</p>
<p>方法：可以考虑用组名和输入路径拼接（在层数较多时可以考虑使用）</p>
<p>但这里还是使用遍历（重写文件去重）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 文件去重</span><br><span class="line"> * @param fileInfoList</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">private static List&lt;Meta.FileConfig.FileInfo&gt; distinctFiles (List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList)&#123;</span><br><span class="line"></span><br><span class="line">    //用了分治思想（一刀切）</span><br><span class="line">    //1.将所有的文件配置（fileInfo）分为有分组和无分组</span><br><span class="line">    //先处理有分组的文件 filter返回值为true 就保留这个文件</span><br><span class="line">    //&#123;&quot;groupKey&quot;: &quot;a&quot;,files:[1,2]&#125;,&#123;&quot;groupKey&quot;: &quot;a&quot;,files:[2,3]&#125;,&#123;&quot;groupKey&quot;: &quot;b&quot;,files:[4,5]&#125;</span><br><span class="line">    //&#123;&quot;groupKey&quot;: &quot;a&quot;,files:[[1,2][2,3]]&#125;,&#123;&quot;groupKey&quot;: &quot;b&quot;,files:[[4,5]]&#125;</span><br><span class="line">    //以组为单位划分</span><br><span class="line">    Map&lt;String, List&lt;Meta.FileConfig.FileInfo&gt;&gt; groupKeyFileInfoListMap = fileInfoList.stream()</span><br><span class="line">            .filter(fileInfo -&gt; StrUtil.isNotBlank(fileInfo.getGroupKey()))</span><br><span class="line">            .collect(</span><br><span class="line">                    Collectors.groupingBy(Meta.FileConfig.FileInfo::getGroupKey)</span><br><span class="line">            );</span><br><span class="line">    </span><br><span class="line">    //新建合并后的对象Map</span><br><span class="line">    Map&lt;String, Meta.FileConfig.FileInfo&gt; groupKeyMergedFileInfo = new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    //2.对于有分组的文件配置，如果有相同的文件分组，同分组内的文件进行合并（merge），不同分组可同时保留</span><br><span class="line">    //同组内配置合并</span><br><span class="line">    //&#123;&quot;groupKey&quot;: &quot;a&quot;,files:[[1,2][2,3]]&#125; -&gt; &#123;&quot;groupKey&quot;: &quot;a&quot;,files:[[1,2,3]]&#125;</span><br><span class="line">    for (Map.Entry&lt;String, List&lt;Meta.FileConfig.FileInfo&gt;&gt; entry : groupKeyFileInfoListMap.entrySet()) &#123;</span><br><span class="line">        //&#123;&quot;groupKey&quot;: &quot;a&quot;,files:[[1,2][2,3]]&#125;</span><br><span class="line">        List&lt;Meta.FileConfig.FileInfo&gt; tempFileInfoList = entry.getValue();</span><br><span class="line">        //&#123;&quot;groupKey&quot;: &quot;a&quot;,files:[[1,2,2,3]]&#125; 将对象打平 flatMap：允许你将一个对象转化成多个对象（这里相当于把一个数组变成多个文件）  Map：是一个对象变成多个对象</span><br><span class="line">        List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = new ArrayList&lt;&gt;(tempFileInfoList.stream()</span><br><span class="line">                .flatMap(fileInfo -&gt; fileInfo.getFiles().stream())</span><br><span class="line">                //[1,2,3]</span><br><span class="line">                .collect(</span><br><span class="line">                        Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)</span><br><span class="line">                ).values());</span><br><span class="line">        </span><br><span class="line">        //使用新的group配置去覆盖旧的配置，根据我们之前的规则：先添加老的，再添加新的，所以新的文件一定在最后</span><br><span class="line">        Meta.FileConfig.FileInfo newFileInfo = CollUtil.getLast(tempFileInfoList);</span><br><span class="line">        //把刚合并后新的文件放到一个文件对象中（组）</span><br><span class="line">        newFileInfo.setFiles(newFileInfoList);</span><br><span class="line">        //获取这个组对象的groupKey</span><br><span class="line">        String groupKey = entry.getKey();</span><br><span class="line">        //放入合并后的对象Map</span><br><span class="line">        groupKeyMergedFileInfo.put(groupKey,newFileInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //3.创建新的文件配置列表（结果列表），先将合并后的分组添加到结果列表</span><br><span class="line">    ArrayList&lt;Meta.FileConfig.FileInfo&gt; resultList = new ArrayList&lt;&gt;(groupKeyMergedFileInfo.values());</span><br><span class="line"></span><br><span class="line">    //4.再将无分组的文件配置列表添加到结果列表(GroupKey为空)</span><br><span class="line">    //Meta.FileConfig.FileInfo::getInputPath ：键值  o -&gt; o： FileInfo的每条信息直接返回，不需要对对象进行任何处理，直接作为value</span><br><span class="line">    //(e, r) -&gt; r 表示新值与旧值冲突会选用已经存在的新值</span><br><span class="line">    resultList.addAll( new ArrayList&lt;&gt;(fileInfoList.stream()</span><br><span class="line">            .filter(fileInfo -&gt; StrUtil.isBlank(fileInfo.getGroupKey()))</span><br><span class="line">            .collect(</span><br><span class="line">                    Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)</span><br><span class="line">            ).values()));</span><br><span class="line">    return resultList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tips：toMap和groupingBy在企业中非常常用，尤其做大数据开发</p>
<p>这种方法本质上就是先无脑的添加文件，最后再一把去重，就把逻辑隔离开了，就不用前面挖坑的时候去思考重复怎么加，不重复怎么加的问题，是分组怎么处理，不是分组的时候怎么处理，跟之前的文件过滤逻辑上是一样的</p>
<h4 id="模型分组"><a href="#模型分组" class="headerlink" title="模型分组"></a>模型分组</h4><p>1.先将模型进行封装（变量a 对应变量 a）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 模型过滤配置JSON实体类:控制多个模板文件的配置</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">public class TemplateMakerModelConfig &#123;</span><br><span class="line"></span><br><span class="line">    private List&lt;ModelInfoConfig&gt; models;</span><br><span class="line"></span><br><span class="line">    private ModelGroupConfig modelGroupConfig;</span><br><span class="line"></span><br><span class="line">    @NoArgsConstructor</span><br><span class="line">    @Data</span><br><span class="line">    public static class ModelInfoConfig&#123;</span><br><span class="line">        private String fieldName;</span><br><span class="line">        private String type;</span><br><span class="line">        private String description;</span><br><span class="line">        private Object defaultValue;</span><br><span class="line">        private String abbr;</span><br><span class="line">        private List&lt;Meta.ModelConfig.ModelInfo&gt; models;</span><br><span class="line"></span><br><span class="line">        //用于替换哪些文本</span><br><span class="line">        private String replaceText;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Data</span><br><span class="line">    public static class ModelGroupConfig&#123;</span><br><span class="line"></span><br><span class="line">        private String condition;</span><br><span class="line">        private String groupKey;</span><br><span class="line">        private String groupName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.修改model的去重方法（将file的去重方法复制并改名即可）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * 模型去重</span><br><span class="line">     * @param modelsInfoList</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private static List&lt;Meta.ModelConfig.ModelInfo&gt; distinctModels (List&lt;Meta.ModelConfig.ModelInfo&gt; modelsInfoList)&#123;</span><br><span class="line">        //用了分治思想（一刀切）</span><br><span class="line">        //1.将所有的模型配置（modelInfo）分为有分组和无分组</span><br><span class="line">        //先处理有分组的模型 filter返回值为true 就保留这个模型</span><br><span class="line">        //&#123;&quot;groupKey&quot;: &quot;a&quot;,models:[1,2]&#125;,&#123;&quot;groupKey&quot;: &quot;a&quot;,models:[2,3]&#125;,&#123;&quot;groupKey&quot;: &quot;b&quot;,models:[4,5]&#125;</span><br><span class="line">        //&#123;&quot;groupKey&quot;: &quot;a&quot;,models:[[1,2][2,3]]&#125;,&#123;&quot;groupKey&quot;: &quot;b&quot;,models:[[4,5]]&#125;</span><br><span class="line">        //以组为单位划分</span><br><span class="line">        Map&lt;String, List&lt;Meta.ModelConfig.ModelInfo&gt;&gt; groupKeyModelInfoListMap = modelInfoList.stream()</span><br><span class="line">                .filter(modelInfo -&gt; StrUtil.isNotBlank(modelInfo.getGroupKey()))</span><br><span class="line">                .collect(</span><br><span class="line">                        Collectors.groupingBy(Meta.ModelConfig.ModelInfo::getGroupKey)</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //新建合并后的对象Map</span><br><span class="line">        Map&lt;String, Meta.ModelConfig.ModelInfo&gt; groupKeyMergedModelInfo = new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //2.对于有分组的模型配置，如果有相同的模型分组，同分组内的模型进行合并（merge），不同分组可同时保留</span><br><span class="line">        //同组内配置合并</span><br><span class="line">        //&#123;&quot;groupKey&quot;: &quot;a&quot;,models:[[1,2][2,3]]&#125; -&gt; &#123;&quot;groupKey&quot;: &quot;a&quot;,models:[[1,2,3]]&#125;</span><br><span class="line">        for (Map.Entry&lt;String, List&lt;Meta.ModelConfig.ModelInfo&gt;&gt; entry : groupKeyModelInfoListMap.entrySet()) &#123;</span><br><span class="line">            //&#123;&quot;groupKey&quot;: &quot;a&quot;,models:[[1,2][2,3]]&#125;</span><br><span class="line">            List&lt;Meta.ModelConfig.ModelInfo&gt; tempModelInfoList = entry.getValue();</span><br><span class="line">            //&#123;&quot;groupKey&quot;: &quot;a&quot;,models:[[1,2,2,3]]&#125; 将对象打平 flatMap：允许你将一个对象转化成多个对象（这里相当于把一个数组变成多个模型）  Map：是一个对象变成多个对象</span><br><span class="line">            List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = new ArrayList&lt;&gt;(tempModelInfoList.stream()</span><br><span class="line">                    .flatMap(modelInfo -&gt; modelInfo.getModels().stream())</span><br><span class="line">                    //[1,2,3]</span><br><span class="line">                    .collect(</span><br><span class="line">                            Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)</span><br><span class="line">                    ).values());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            //使用新的group配置去覆盖旧的配置，根据我们之前的规则：先添加老的，再添加新的，所以新的模型一定在最后</span><br><span class="line">            Meta.ModelConfig.ModelInfo newModelInfo = CollUtil.getLast(tempModelInfoList);</span><br><span class="line">            //把刚合并后新的模型放到一个模型对象中（组）</span><br><span class="line">            newModelInfo.setModels(newModelInfoList);</span><br><span class="line">            //获取这个组对象的groupKey</span><br><span class="line">            String groupKey = entry.getKey();</span><br><span class="line">            //放入合并后的对象Map</span><br><span class="line">            groupKeyMergedModelInfo.put(groupKey,newModelInfo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //3.创建新的模型配置列表（结果列表），先将合并后的分组添加到结果列表</span><br><span class="line">        ArrayList&lt;Meta.ModelConfig.ModelInfo&gt; resultList = new ArrayList&lt;&gt;(groupKeyMergedModelInfo.values());</span><br><span class="line"></span><br><span class="line">        //4.再将无分组的模型配置列表添加到结果列表(GroupKey为空)</span><br><span class="line">        //Meta.ModelConfig.ModelInfo::getInputPath ：键值  o -&gt; o： ModelInfo的每条信息直接返回，不需要对对象进行任何处理，直接作为value</span><br><span class="line">        //(e, r) -&gt; r 表示新值与旧值冲突会选用已经存在的新值</span><br><span class="line">        resultList.addAll( new ArrayList&lt;&gt;(modelsInfoList.stream()</span><br><span class="line">                .filter(modelInfo -&gt; StrUtil.isBlank(modelInfo.getGroupKey()))</span><br><span class="line">                .collect(</span><br><span class="line">                        Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)</span><br><span class="line">                ).values()));</span><br><span class="line">        return resultList;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>3.修改makeTemplate中的model逻辑（跟File文件的逻辑一样）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">//处理模型信息</span><br><span class="line">List&lt;TemplateMakerModelConfig.ModelInfoConfig&gt; models = templateMakerModelConfig.getModels();</span><br><span class="line">//转化为配置文件接收的modelInfo对象</span><br><span class="line">List&lt;Meta.ModelConfig.ModelInfo&gt; inputModelInfoList = models.stream()</span><br><span class="line">        .map(modelInfoConfig -&gt; &#123;</span><br><span class="line">            Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span><br><span class="line">            BeanUtil.copyProperties(modelInfoConfig, modelInfo);</span><br><span class="line">            return modelInfo;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">//本次新增的模型列表</span><br><span class="line">List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">//如果是模型组</span><br><span class="line">TemplateMakerModelConfig.ModelGroupConfig modelGroupConfig = templateMakerModelConfig.getModelGroupConfig();</span><br><span class="line">if (modelGroupConfig != null)&#123;</span><br><span class="line">    //加外层的分组</span><br><span class="line">    String condition = modelGroupConfig.getCondition();</span><br><span class="line">    String groupKey = modelGroupConfig.getGroupKey();</span><br><span class="line">    String groupName = modelGroupConfig.getGroupName();</span><br><span class="line"></span><br><span class="line">    Meta.ModelConfig.ModelInfo goupModelInfo = new Meta.ModelConfig.ModelInfo();</span><br><span class="line">    goupModelInfo.setCondition(condition);</span><br><span class="line">    goupModelInfo.setGroupKey(groupKey);</span><br><span class="line">    goupModelInfo.setGroupName(groupName);</span><br><span class="line">    //把外层模型全放到一个分组内，相当于把多层文件放在了一个包下</span><br><span class="line">    goupModelInfo.setModels(inputModelInfoList);</span><br><span class="line">    newModelInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">    newModelInfoList.add(goupModelInfo);</span><br><span class="line"></span><br><span class="line">&#125;else &#123;</span><br><span class="line">    //不分组，添加所有的模型信息到列表</span><br><span class="line">    newModelInfoList.addAll(inputModelInfoList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//把所有的信息对象添加到list中</span><br><span class="line">modelsInfoList.addAll(newModelInfoList);</span><br></pre></td></tr></table></figure>



<p>修改制作单个文件的方法的逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">String fileContent ;</span><br><span class="line">//如果已有模板文件，表示不是第一次制作，则在原有的模板基础上再挖坑</span><br><span class="line">if (FileUtil.exist(fileOutPutAbsolutePath))&#123;</span><br><span class="line">    //如果不是第一次挖：fileOutPutAbsolutePath表示上次的输出路径</span><br><span class="line">    fileContent = FileUtil.readUtf8String(fileOutPutAbsolutePath);</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    //如果是第一次挖则用的是输入文件</span><br><span class="line">    fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//支持多个模型：对于同一个文件内容，遍历模型进行多轮替换</span><br><span class="line">ModelGroupConfig modelGroupConfig = templateMakerModelConfig.getModelGroupConfig();</span><br><span class="line"></span><br><span class="line">//newFileContent记录最新替换的内容</span><br><span class="line">String newFileContent = fileContent;</span><br><span class="line">String replacement;</span><br><span class="line">for (TemplateMakerModelConfig.ModelInfoConfig modelInfoConfig : templateMakerModelConfig.getModels()) &#123;</span><br><span class="line">    String fieldName = modelInfoConfig.getFieldName();</span><br><span class="line">    //模型配置</span><br><span class="line">    if (modelGroupConfig == null)&#123;</span><br><span class="line">        //不是分组,跟原来的替换规则一样 直接取filedName</span><br><span class="line">        replacement= String.format(&quot;$&#123;%s&#125;&quot;, fieldName);</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        //如果是分组才能获取到GroupKey</span><br><span class="line">        String groupKey = modelGroupConfig.getGroupKey();</span><br><span class="line">        //如果是分组，则需要先加groupKey.filedName</span><br><span class="line">        replacement = String.format(&quot;$&#123;%s.%s&#125;&quot;, groupKey,fieldName);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    //第二次替换，把上一次的替换作为输入，括号中的newFileContent：为上一次结果（递归）</span><br><span class="line">    newFileContent = StrUtil.replace(newFileContent,modelInfoConfig.getReplaceText(), replacement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>制作模板文件的方法支持多个模型参数（如：一次性设置把mysql在application.yml中的配置）</p>
<p>测试：在main方法中添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// 数据库-模型参数配置</span><br><span class="line">TemplateMakerModelConfig templateMakerModelConfig = new TemplateMakerModelConfig();</span><br><span class="line"></span><br><span class="line">// - 数据库-模型组配置</span><br><span class="line">TemplateMakerModelConfig.ModelGroupConfig modelGroupConfig = new TemplateMakerModelConfig.ModelGroupConfig();</span><br><span class="line">modelGroupConfig.setGroupKey(&quot;mysql&quot;);</span><br><span class="line">modelGroupConfig.setGroupName(&quot;数据库配置&quot;);</span><br><span class="line">templateMakerModelConfig.setModelGroupConfig(modelGroupConfig);</span><br><span class="line"></span><br><span class="line">// - 数据库-模型配置</span><br><span class="line">TemplateMakerModelConfig.ModelInfoConfig modelInfoConfig1 = new TemplateMakerModelConfig.ModelInfoConfig();</span><br><span class="line">modelInfoConfig1.setFieldName(&quot;url&quot;);</span><br><span class="line">modelInfoConfig1.setType(&quot;String&quot;);</span><br><span class="line">modelInfoConfig1.setDefaultValue(&quot;jdbc:mysql://localhost:3306/my_db&quot;);</span><br><span class="line">modelInfoConfig1.setReplaceText(&quot;jdbc:mysql://localhost:3306/my_db&quot;);</span><br><span class="line"></span><br><span class="line">TemplateMakerModelConfig.ModelInfoConfig modelInfoConfig2 = new TemplateMakerModelConfig.ModelInfoConfig();</span><br><span class="line">modelInfoConfig2.setFieldName(&quot;username&quot;);</span><br><span class="line">modelInfoConfig2.setType(&quot;String&quot;);</span><br><span class="line">modelInfoConfig2.setDefaultValue(&quot;root&quot;);</span><br><span class="line">modelInfoConfig2.setReplaceText(&quot;root&quot;);</span><br><span class="line"></span><br><span class="line">List&lt;TemplateMakerModelConfig.ModelInfoConfig&gt; modelInfoConfigList = Arrays.asList(modelInfoConfig1, modelInfoConfig2);</span><br><span class="line">templateMakerModelConfig.setModels(modelInfoConfigList);</span><br></pre></td></tr></table></figure>



<h4 id="修复bug"><a href="#修复bug" class="headerlink" title="修复bug"></a>修复bug</h4><p>修改上期重复执行生成的meta.json中文件类型不一致</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//文件配置信息</span><br><span class="line">Meta.FileConfig.FileInfo fileInfo = new Meta.FileConfig.FileInfo();</span><br><span class="line">fileInfo.setInputPath(fileInputPath);</span><br><span class="line">fileInfo.setType(FileTypeEnum.FILE.getValue());</span><br><span class="line">//文件默认是动态</span><br><span class="line">fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());</span><br><span class="line"></span><br><span class="line">//是否更改了文件内容</span><br><span class="line">boolean contentEquals = newFileContent.equals(fileContent);</span><br><span class="line">//和原文件内容一致，没有挖坑，静态生成</span><br><span class="line">if (!hasTemplateFile)&#123;</span><br><span class="line">    if (contentEquals)&#123;</span><br><span class="line">        //之前不存在文件，并且这次与之前一致，才是静态生成</span><br><span class="line">        //如果是静态生成的话，输入路径 = 输出路径</span><br><span class="line">        fileInfo.setOutputPath(fileInputPath);</span><br><span class="line">        fileInfo.setGenerateType(FileGenerateTypeEnum.STATIC.getValue());</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        //之前不存在文件，并且这次与之前不一致，动态生成</span><br><span class="line">        //输出模板文件</span><br><span class="line">        FileUtil.writeUtf8String(newFileContent, fileOutPutAbsolutePath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else if (!contentEquals)&#123;</span><br><span class="line">    //如果之前有模板文件，并且增加了新坑，则生成/更新模板文件</span><br><span class="line">    FileUtil.writeUtf8String(newFileContent, fileOutPutAbsolutePath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>还有个bug：多次执行会重复生成目标文件的ftl，并且写入meta.json中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> //传入绝对路径,进行过滤</span><br><span class="line">    //得到过滤后的文件列表</span><br><span class="line">    List&lt;File&gt; fileList = FileFilter.doFilter(inputFilePath, fileInfoConfig.getFileFilterConfigList());</span><br><span class="line">    //不处理已经生成的ftl模板文件</span><br><span class="line">    fileList = fileList.stream()</span><br><span class="line">            .filter(file -&gt; !file.getAbsolutePath().endsWith(&quot;.ftl&quot;))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    //直接遍历文件去制作模板</span><br><span class="line">    for (File file : fileList) &#123;</span><br><span class="line">        Meta.FileConfig.FileInfo fileInfo = makeFileTemplate(templateMakerModelConfig, sourceRootPath, file);</span><br><span class="line">        newFileInfoList.add(fileInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>bug：现在做的是生成模板的生成器，得到的meta.JSON文件的输入路径和输出路径与代码生成器的输入路径和输出路径相反</p>
<p>如何修改代码？</p>
<p>在TemplateMaker文件的MakeFileTemplate方法下</p>
<p>调换修改输入配置信息代码和输出配置信息代码的逻辑</p>
<p>原本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fileInfo.setInputPath(fileInputPath);</span><br><span class="line">fileInfo.setOutputPath(fileOutputPath);</span><br></pre></td></tr></table></figure>

<p>变为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fileInfo.setInputPath(fileOutputPath);</span><br><span class="line">fileInfo.setOutputPath(fileInputPath);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fileInfo.setInputPath(fileInputPath);</span><br></pre></td></tr></table></figure>



<p>还要修改去重逻辑，之前是根据输入路径去重，现在要根据输出路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)</span><br></pre></td></tr></table></figure>

<p>变为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Collectors.toMap(Meta.FileConfig.FileInfo::getOutputPath, o -&gt; o, (e, r) -&gt; r)</span><br></pre></td></tr></table></figure>



<p>第四个bug：如果指定的生成模板文件的目录为根目录，就会发现，它连生成的meta.JSON文件都生成了对应的ftl模板（这显然不是我们想要的）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//三.生成配置文件(在.temp工作空间的根目录生成)</span><br><span class="line">String metaOutputPath = templatePath + File.separator + &quot;meta.json&quot;;</span><br></pre></td></tr></table></figure>





<p>tips：在本地临时处理文件，在不确定的情况下用一个文件夹把所有的代码套起来</p>
<h4 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h4><p>易用性优化</p>
<p>思路:把所有的配置参数封装成一个对象，让用户输入一些JSON配置来转换对象，给对象赋值，直接交给对象去处理</p>
<p>1.创建TemplateMakerConfig，把makeTemplate的所有的输入参数封装起来</p>
<p>2.不要去直接修改目标封装的方法，因为要把所有的引用到的参数进行修改很麻烦，直接使用方法重载即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 制作模板</span><br><span class="line"> * @param templateMakerConfig</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">public static long makeTemplate(TemplateMakerConfig templateMakerConfig)&#123;</span><br><span class="line"> Long id = templateMakerConfig.getId();</span><br><span class="line"> Meta meta = templateMakerConfig.getMeta();</span><br><span class="line"> String originProjectPath = templateMakerConfig.getOriginProjectPath();</span><br><span class="line"> TemplateMakerModelConfig templateMakerModelConfig = templateMakerConfig.getTemplateMakerModelConfig();</span><br><span class="line"> TemplateMakerFileConfig templateMakerFileConfig = templateMakerConfig.getTemplateMakerFileConfig();</span><br><span class="line"> </span><br><span class="line"> return makeTemplate(meta,originProjectPath,templateMakerFileConfig,templateMakerModelConfig,id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="实现springboot项目模板具有的功能"><a href="#实现springboot项目模板具有的功能" class="headerlink" title="实现springboot项目模板具有的功能"></a>实现springboot项目模板具有的功能</h4><h5 id="一-生成springboot项目代码生成器的配置信息"><a href="#一-生成springboot项目代码生成器的配置信息" class="headerlink" title="一.生成springboot项目代码生成器的配置信息"></a>一.生成springboot项目代码生成器的配置信息</h5><p>因为要对输入文件进行校验，为了代码的圈复杂度低，需要抽方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 生成多个文件</span><br><span class="line"> * @param templateMakerFileConfig</span><br><span class="line"> * @param templateMakerModelConfig</span><br><span class="line"> * @param sourceRootPath</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">private static List&lt;Meta.FileConfig.FileInfo&gt; makeFileTemplates(TemplateMakerFileConfig templateMakerFileConfig, TemplateMakerModelConfig templateMakerModelConfig, String sourceRootPath) &#123;</span><br><span class="line"></span><br><span class="line">    //二.生成文件模板</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">    //非空校验</span><br><span class="line">    if (templateMakerFileConfig == null)&#123;</span><br><span class="line">        return newFileInfoList;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;FileInfoConfig&gt; fileInfoConfigList = templateMakerFileConfig.getFiles();</span><br><span class="line">    if (CollUtil.isEmpty(fileInfoConfigList))&#123;</span><br><span class="line">        return newFileInfoList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //支持遍历输入文件</span><br><span class="line">    //遍历文件配置,每个文件都要路径和文件过滤列表</span><br><span class="line">    for (TemplateMakerFileConfig.FileInfoConfig fileInfoConfig : fileInfoConfigList) &#123;</span><br><span class="line">        String inputFilePath = fileInfoConfig.getPath();</span><br><span class="line">        //将外层输入的相对路径修改为绝对路径</span><br><span class="line">        if (!inputFilePath.startsWith(sourceRootPath))&#123;</span><br><span class="line">            inputFilePath = sourceRootPath + File.separator + inputFilePath;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //传入绝对路径,进行过滤</span><br><span class="line">        //得到过滤后的文件列表</span><br><span class="line">        List&lt;File&gt; fileList = FileFilter.doFilter(inputFilePath, fileInfoConfig.getFileFilterConfigList());</span><br><span class="line">        //不处理已经生成的ftl模板文件</span><br><span class="line">        fileList = fileList.stream()</span><br><span class="line">                .filter(file -&gt; !file.getAbsolutePath().endsWith(&quot;.ftl&quot;))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        //直接遍历文件去制作模板</span><br><span class="line">        for (File file : fileList) &#123;</span><br><span class="line">            Meta.FileConfig.FileInfo fileInfo = makeFileTemplate(templateMakerModelConfig, sourceRootPath, file);</span><br><span class="line">            newFileInfoList.add(fileInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //分组配置</span><br><span class="line">    //如果是文件组</span><br><span class="line">    TemplateMakerFileConfig.FileGroupConfig fileGroupConfig = templateMakerFileConfig.getFileGroupConfig();</span><br><span class="line">    if (fileGroupConfig != null)&#123;</span><br><span class="line">        String condition = fileGroupConfig.getCondition();</span><br><span class="line">        String groupKey = fileGroupConfig.getGroupKey();</span><br><span class="line">        String groupName = fileGroupConfig.getGroupName();</span><br><span class="line"></span><br><span class="line">        Meta.FileConfig.FileInfo goupFileInfo = new Meta.FileConfig.FileInfo();</span><br><span class="line">        goupFileInfo.setCondition(condition);</span><br><span class="line">        goupFileInfo.setGroupKey(groupKey);</span><br><span class="line">        goupFileInfo.setGroupName(groupName);</span><br><span class="line">        //把外层文件全放到一个分组内，相当于把多层文件放在了一个包下</span><br><span class="line">        goupFileInfo.setFiles(newFileInfoList);</span><br><span class="line">        newFileInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">        newFileInfoList.add(goupFileInfo);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    return newFileInfoList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.判断输入的模型是否为空</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 获取模型配置</span><br><span class="line"> *</span><br><span class="line"> * @param templateMakerModelConfig</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">private static List&lt;Meta.ModelConfig.ModelInfo&gt; getModelInfoList(TemplateMakerModelConfig templateMakerModelConfig) &#123;</span><br><span class="line"></span><br><span class="line">    //本次新增的模型列表</span><br><span class="line">    List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //非空校验</span><br><span class="line">    if (templateMakerModelConfig == null)&#123;</span><br><span class="line">        return newModelInfoList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //处理模型信息</span><br><span class="line">    List&lt;TemplateMakerModelConfig.ModelInfoConfig&gt; models = templateMakerModelConfig.getModels();</span><br><span class="line">    //模型的非空校验</span><br><span class="line">    if (CollUtil.isEmpty(models))&#123;</span><br><span class="line">        return newModelInfoList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //转化为配置文件接收的modelInfo对象</span><br><span class="line">    List&lt;Meta.ModelConfig.ModelInfo&gt; inputModelInfoList = models.stream()</span><br><span class="line">            .map(modelInfoConfig -&gt; &#123;</span><br><span class="line">                Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span><br><span class="line">                BeanUtil.copyProperties(modelInfoConfig, modelInfo);</span><br><span class="line">                return modelInfo;</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //如果是模型组</span><br><span class="line">    ModelGroupConfig modelGroupConfig = templateMakerModelConfig.getModelGroupConfig();</span><br><span class="line">    if (modelGroupConfig != null)&#123;</span><br><span class="line">        //加外层的分组</span><br><span class="line">        String condition = modelGroupConfig.getCondition();</span><br><span class="line">        String groupKey = modelGroupConfig.getGroupKey();</span><br><span class="line">        String groupName = modelGroupConfig.getGroupName();</span><br><span class="line"></span><br><span class="line">        Meta.ModelConfig.ModelInfo goupModelInfo = new Meta.ModelConfig.ModelInfo();</span><br><span class="line">        goupModelInfo.setCondition(condition);</span><br><span class="line">        goupModelInfo.setGroupKey(groupKey);</span><br><span class="line">        goupModelInfo.setGroupName(groupName);</span><br><span class="line">        //把外层模型全放到一个分组内，相当于把多层文件放在了一个包下</span><br><span class="line">        goupModelInfo.setModels(inputModelInfoList);</span><br><span class="line">        newModelInfoList = new ArrayList&lt;&gt;();</span><br><span class="line">        newModelInfoList.add(goupModelInfo);</span><br><span class="line"></span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        //不分组，添加所有的模型信息到列表</span><br><span class="line">        newModelInfoList.addAll(inputModelInfoList);</span><br><span class="line">    &#125;</span><br><span class="line">    return newModelInfoList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="二-替换生成的代码包名"><a href="#二-替换生成的代码包名" class="headerlink" title="二.替换生成的代码包名"></a>二.替换生成的代码包名</h5><p>允许用户传入basePackage模型参数，对Spring Boot模板项目代码中所有出现包名的地方进行替换</p>
<p>1.实现根据id获取id下的第一个路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//实现根据id获取id下的第一个路径 loopFiles（文件（路径，层数，文件过滤））</span><br><span class="line">String sourceRootPath = FileUtil.loopFiles(new File(templatePath,1,null))</span><br><span class="line">        .stream()</span><br><span class="line">        .filter(File::isDirectory)</span><br><span class="line">        .findFirst()</span><br><span class="line">        .orElseThrow(RuntimeException::new)</span><br><span class="line">        .getAbsolutePath();</span><br></pre></td></tr></table></figure>

<p>templateMaker1.JSON</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: 1,</span><br><span class="line">  &quot;fileConfig&quot;: &#123;</span><br><span class="line">    &quot;files&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;path&quot;: &quot;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;modelConfig&quot;: &#123;</span><br><span class="line">    &quot;models&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;basePackage&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;基础包名&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: &quot;com.yupi&quot;,</span><br><span class="line">        &quot;replaceText&quot;: &quot;com.yupi&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">congfigStr = ResourceUtil.readUtf8Str(rootPath+&quot;templateMaker1.json&quot;);</span><br><span class="line">templateMakerConfig = JSONUtil.toBean(congfigStr, TemplateMakerConfig.class);</span><br><span class="line">TemplateMaker.makeTemplate(templateMakerConfig);</span><br></pre></td></tr></table></figure>

<p>todo：如何修改文件名？</p>
<p>思路：在模板配置文件中，sourceRootPath的名称改成动态的</p>
<h5 id="三-根据用户输入的参数控制是否生成帖子相关功能"><a href="#三-根据用户输入的参数控制是否生成帖子相关功能" class="headerlink" title="三.根据用户输入的参数控制是否生成帖子相关功能"></a>三.根据用户输入的参数控制是否生成帖子相关功能</h5><p>复制yupi的JSON，发现没有效果，可能是JSON当中的命名出问题了</p>
<p>修改即可</p>
<p>templateMaker2.JSON</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: 1,</span><br><span class="line">  &quot;fileConfig&quot;: &#123;</span><br><span class="line">    &quot;fileGroupConfig&quot;: &#123;</span><br><span class="line">      &quot;groupKey&quot;: &quot;post&quot;,</span><br><span class="line">      &quot;groupName&quot;: &quot;帖子文件组&quot;,</span><br><span class="line">      &quot;condition&quot;: &quot;needPost&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;files&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;path&quot;: &quot;src/main&quot;,</span><br><span class="line">        &quot;fileFilterConfigList&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;range&quot;: &quot;fileName&quot;,</span><br><span class="line">            &quot;rule&quot;: &quot;contains&quot;,</span><br><span class="line">            &quot;value&quot;: &quot;Post&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;modelConfig&quot;: &#123;</span><br><span class="line">    &quot;models&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;needPost&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;boolean&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;是否开启帖子功能&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有个bug：第一次遍历生成所有文件的ftl，第二次分组生成某些文件的ftl，但此时没有覆盖</p>
<p>上一期还有一个输入参数没有设置：输出规则</p>
<p>1.编写输出配置类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class TemplateMakerOutputConfig &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 从未分组的文件中移除组内的同名文件</span><br><span class="line">     */</span><br><span class="line">    private boolean removeGroupFilesFromRoot = true;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.在总配置中添加该类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//默认值为true</span><br><span class="line">private TemplateMakerOutputConfig outputConfig = new TemplateMakerOutputConfig();</span><br></pre></td></tr></table></figure>





<p>思考：如何从一个外层列表中删除内层列表已有的文件</p>
<p>1..创建工具类TemplateMakerUtils</p>
<p>去重方法：根据outputPath去重</p>
<p>专门写一个新类来写这个需求</p>
<p>为什么？因为这个逻辑是根据用户新增的逻辑去配置的，不要去改老的逻辑，而且其他程序员可以复用这个去重工具</p>
<p><strong>先做设计后写代码</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 模板制作工具类</span><br><span class="line"> */</span><br><span class="line">public class TemplateMakerUtils &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 从未分组的文件中移除组内的同名文件</span><br><span class="line">     * @param fileInfoList</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static List&lt;Meta.FileConfig.FileInfo&gt; removeGroupFilesFromRoot(List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList)&#123;</span><br><span class="line"></span><br><span class="line">        //先获取到所有分组</span><br><span class="line">        //根据是否有groupKey来判断它是否是分组</span><br><span class="line">        List&lt;Meta.FileConfig.FileInfo&gt; groupFileInfoList = fileInfoList.stream()</span><br><span class="line">                .filter(fileInfo -&gt; StrUtil.isNotBlank(fileInfo.getGroupKey()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        //获取所有分组内的文件列表</span><br><span class="line">        //分组1：3个文件 分组2：3个文件 拼起来总共6个文件</span><br><span class="line">        List&lt;Meta.FileConfig.FileInfo&gt; goupInnerFileInfoList = groupFileInfoList.stream()</span><br><span class="line">                .flatMap(fileInfo -&gt; fileInfo.getFiles().stream())</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //获取所有分组内文件的输入路径来去重</span><br><span class="line">        //把得到的所有文件放入集合中，因为集合方便去重</span><br><span class="line">        Set&lt;String&gt; fileInputPathSet = goupInnerFileInfoList.stream()</span><br><span class="line">                .map(Meta.FileConfig.FileInfo::getInputPath)</span><br><span class="line">                .collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">        //移除所有在集合内的外层文件</span><br><span class="line">        //如果不在集合才保留</span><br><span class="line">        // 分组是没有输入路径的，所以一定为空，那么它一定不再集合内，一定是true，也就是说如果不包含在集合中的文件那么这个文件一定在分组中</span><br><span class="line">        return fileInfoList.stream()</span><br><span class="line">                .filter(fileInfo -&gt; !fileInputPathSet.contains(fileInfo.getInputPath()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改makeTemplate方法的参数，新增输出配置</p>
<p>取出所有的输出文件后，对输出文件去重</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 拿到list表后，进行额外的去重</span><br><span class="line">if (templateMakerOutputConfig != null)&#123;</span><br><span class="line">    //文件外层和分组去重</span><br><span class="line">    if (templateMakerOutputConfig.isRemoveGroupFilesFromRoot())&#123;</span><br><span class="line">        //先获取所有的文件</span><br><span class="line">        List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = newMeta.getFileConfig().getFiles();</span><br><span class="line">        //将所有的文件去重后得到的结果再设置回去</span><br><span class="line">        newMeta.getFileConfig().setFiles(TemplateMakerUtils.removeGroupFilesFromRoot(fileInfoList));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再在封装参数的方法中添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TemplateMakerOutputConfig outputConfig = templateMakerConfig.getOutputConfig();</span><br></pre></td></tr></table></figure>





<h5 id="四-控制是否开启跨域"><a href="#四-控制是否开启跨域" class="headerlink" title="四.控制是否开启跨域"></a>四.控制是否开启跨域</h5><p>忘记做单个文件是否生成的配置</p>
<p>1.TemplateMakerFileConfig的FileInfoConfig中添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private String condition;</span><br></pre></td></tr></table></figure>

<p>2.方法修改参数新加TemplateMakerFileConfig.FileInfoConfig fileInfoConfig</p>
<p>3.并且调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fileInfo.setCondition(fileInfoConfig.getCondition());</span><br></pre></td></tr></table></figure>

<p>4.测试</p>
<p>json文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: 1,</span><br><span class="line">  &quot;fileConfig&quot;: &#123;</span><br><span class="line">    &quot;files&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;path&quot;: &quot;src/main/java/com/yupi/springbootinit/config/CorsConfig.java&quot;,</span><br><span class="line">        &quot;condition&quot;: &quot;needCors&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;modelConfig&quot;: &#123;</span><br><span class="line">    &quot;models&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;needCors&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;boolean&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;是否开启跨域功能&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试方法中添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">congfigStr = ResourceUtil.readUtf8Str(rootPath+&quot;templateMaker3.json&quot;);</span><br><span class="line">templateMakerConfig = JSONUtil.toBean(congfigStr, TemplateMakerConfig.class);</span><br><span class="line">TemplateMaker.makeTemplate(templateMakerConfig);</span><br></pre></td></tr></table></figure>





<h5 id="五-自定义Knife4jConfig接口文档配置"><a href="#五-自定义Knife4jConfig接口文档配置" class="headerlink" title="五.自定义Knife4jConfig接口文档配置"></a>五.自定义Knife4jConfig接口文档配置</h5><p>新增模型类的字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">private String type;</span><br><span class="line">private String description;</span><br></pre></td></tr></table></figure>

<p>修改TemplateMaker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//优化：使用工具类复制变量,当使用的的对象的字段超过5个可以考虑使用复制变量的工具</span><br><span class="line">Meta.ModelConfig.ModelInfo goupModelInfo = new Meta.ModelConfig.ModelInfo();</span><br><span class="line">BeanUtil.copyProperties(modelGroupConfig,goupModelInfo);</span><br></pre></td></tr></table></figure>



<p>需要新建两个JSON文件，其中一个用来控制文件是否生成，另一个用来进行参数替换</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: 1,</span><br><span class="line">  &quot;fileConfig&quot;: &#123;</span><br><span class="line">    &quot;files&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;path&quot;: &quot;src/main/java/com/yupi/springbootinit/config/Knife4jConfig.java&quot;,</span><br><span class="line">        &quot;condition&quot;: &quot;needDocs&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;modelConfig&quot;: &#123;</span><br><span class="line">    &quot;models&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;needDocs&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;boolean&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;是否开启接口文档功能&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: 1,</span><br><span class="line">  &quot;fileConfig&quot;: &#123;</span><br><span class="line">    &quot;files&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;path&quot;: &quot;src/main/java/com/yupi/springbootinit/config/Knife4jConfig.java&quot;,</span><br><span class="line">        &quot;condition&quot;: &quot;needDocs&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;modelConfig&quot;: &#123;</span><br><span class="line">    &quot;modelGroupConfig&quot;: &#123;</span><br><span class="line">      &quot;groupKey&quot;: &quot;docsConfig&quot;,</span><br><span class="line">      &quot;groupName&quot;: &quot;接口文档配置&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;DocsConfig&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;用于生成接口文档配置&quot;,</span><br><span class="line">      &quot;condition&quot;: &quot;needDocs&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;models&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;title&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;接口文档标题&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: &quot;接口文档&quot;,</span><br><span class="line">        &quot;replaceText&quot;: &quot;接口文档&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;description&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;接口文档描述&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: &quot;springboot-init&quot;,</span><br><span class="line">        &quot;replaceText&quot;: &quot;springboot-init&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;version&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;接口文档版本&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: &quot;1.0&quot;,</span><br><span class="line">        &quot;replaceText&quot;: &quot;1.0&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="六-自定义MySQL配置信息"><a href="#六-自定义MySQL配置信息" class="headerlink" title="六.自定义MySQL配置信息"></a>六.自定义MySQL配置信息</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: 1,</span><br><span class="line">  &quot;fileConfig&quot;: &#123;</span><br><span class="line">    &quot;files&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;path&quot;: &quot;src/main/resources/application.yml&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;modelConfig&quot;: &#123;</span><br><span class="line">    &quot;modelGroupConfig&quot;: &#123;</span><br><span class="line">      &quot;groupKey&quot;: &quot;mysqlConfig&quot;,</span><br><span class="line">      &quot;groupName&quot;: &quot;MySQL数据库配置&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;MysqlConfig&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;用于生成MySQL数据库配置&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;models&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;url&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;地址&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: &quot;jdbc:mysql://localhost:3306/my_db&quot;,</span><br><span class="line">        &quot;replaceText&quot;: &quot;jdbc:mysql://localhost:3306/my_db&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;username&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;用户名&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: &quot;root&quot;,</span><br><span class="line">        &quot;replaceText&quot;: &quot;root&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;password&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;密码&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: &quot;123456&quot;,</span><br><span class="line">        &quot;replaceText&quot;: &quot;123456&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="七-控制是否开启Redis"><a href="#七-控制是否开启Redis" class="headerlink" title="七.控制是否开启Redis"></a>七.控制是否开启Redis</h5><p>直接使用freemarker的语法来写，比用一个参数控制一段配置代码生成效率更快</p>
<p>1.先找到哪些文件用了redis</p>
<p>application.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;#if needRedis&gt;</span><br><span class="line">#  redis:</span><br><span class="line">#    database: 1</span><br><span class="line">#    host: localhost</span><br><span class="line">#    port: 6379</span><br><span class="line">#    timeout: 5000</span><br><span class="line">#    password: $&#123;mysqlConfig.password&#125;</span><br><span class="line">&lt;/#if&gt;</span><br></pre></td></tr></table></figure>

<p>MainApplication.java.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication&lt;#if !needRedis&gt;(exclude = &#123;RedisAutoConfiguration.class&#125;)&lt;/#if&gt;</span><br></pre></td></tr></table></figure>

<p>pom.xml.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- redis --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.session&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-session-data-redis&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;/#if&gt;</span><br></pre></td></tr></table></figure>



<h5 id="八-控制是否开启Elasticsearch"><a href="#八-控制是否开启Elasticsearch" class="headerlink" title="八.控制是否开启Elasticsearch"></a>八.控制是否开启Elasticsearch</h5><p>1.哪些地方用到了es</p>
<p>postController</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;#if needEs&gt;</span><br><span class="line">/**</span><br><span class="line"> * 分页搜索（从 ES 查询）</span><br><span class="line"> *</span><br><span class="line"> * @param postQueryRequest</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@PostMapping(&quot;/search/page&quot;)</span><br><span class="line">public BaseResponse&lt;Page&lt;Post&gt;&gt; searchPostByPage(@RequestBody PostQueryRequest postQueryRequest) &#123;</span><br><span class="line">    long size = postQueryRequest.getPageSize();</span><br><span class="line">    // 限制爬虫</span><br><span class="line">    ThrowUtils.throwIf(size &gt; 20, ErrorCode.PARAMS_ERROR);</span><br><span class="line">    Page&lt;Post&gt; postPage = postService.searchFromEs(postQueryRequest);</span><br><span class="line">    return ResultUtils.success(postPage);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/#if&gt;</span><br></pre></td></tr></table></figure>

<p>PostServiceImpl.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">&lt;#if needEs&gt;    </span><br><span class="line">@Override</span><br><span class="line">public Page&lt;Post&gt; searchFromEs(PostQueryRequest postQueryRequest) &#123;</span><br><span class="line">    Long id = postQueryRequest.getId();</span><br><span class="line">    Long notId = postQueryRequest.getNotId();</span><br><span class="line">    String searchText = postQueryRequest.getSearchText();</span><br><span class="line">    String title = postQueryRequest.getTitle();</span><br><span class="line">    String content = postQueryRequest.getContent();</span><br><span class="line">    List&lt;String&gt; tagList = postQueryRequest.getTags();</span><br><span class="line">    List&lt;String&gt; orTagList = postQueryRequest.getOrTags();</span><br><span class="line">    Long userId = postQueryRequest.getUserId();</span><br><span class="line">    // es 起始页为 0</span><br><span class="line">    long current = postQueryRequest.getCurrent() - 1;</span><br><span class="line">    long pageSize = postQueryRequest.getPageSize();</span><br><span class="line">    BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">    // 过滤</span><br><span class="line">    boolQueryBuilder.filter(QueryBuilders.termQuery(&quot;isDelete&quot;, 0));</span><br><span class="line">    if (id != null) &#123;</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(&quot;id&quot;, id));</span><br><span class="line">    &#125;</span><br><span class="line">    if (notId != null) &#123;</span><br><span class="line">        boolQueryBuilder.mustNot(QueryBuilders.termQuery(&quot;id&quot;, notId));</span><br><span class="line">    &#125;</span><br><span class="line">    if (userId != null) &#123;</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(&quot;userId&quot;, userId));</span><br><span class="line">    &#125;</span><br><span class="line">    // 必须包含所有标签</span><br><span class="line">    if (CollectionUtil.isNotEmpty(tagList)) &#123;</span><br><span class="line">        for (String tag : tagList) &#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(&quot;tags&quot;, tag));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 包含任何一个标签即可</span><br><span class="line">    if (CollectionUtil.isNotEmpty(orTagList)) &#123;</span><br><span class="line">        BoolQueryBuilder orTagBoolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">        for (String tag : orTagList) &#123;</span><br><span class="line">            orTagBoolQueryBuilder.should(QueryBuilders.termQuery(&quot;tags&quot;, tag));</span><br><span class="line">        &#125;</span><br><span class="line">        orTagBoolQueryBuilder.minimumShouldMatch(1);</span><br><span class="line">        boolQueryBuilder.filter(orTagBoolQueryBuilder);</span><br><span class="line">    &#125;</span><br><span class="line">    // 按关键词检索</span><br><span class="line">    if (StringUtils.isNotBlank(searchText)) &#123;</span><br><span class="line">        boolQueryBuilder.should(QueryBuilders.matchQuery(&quot;title&quot;, searchText));</span><br><span class="line">        boolQueryBuilder.should(QueryBuilders.matchQuery(&quot;description&quot;, searchText));</span><br><span class="line">        boolQueryBuilder.should(QueryBuilders.matchQuery(&quot;content&quot;, searchText));</span><br><span class="line">        boolQueryBuilder.minimumShouldMatch(1);</span><br><span class="line">    &#125;</span><br><span class="line">    // 按标题检索</span><br><span class="line">    if (StringUtils.isNotBlank(title)) &#123;</span><br><span class="line">        boolQueryBuilder.should(QueryBuilders.matchQuery(&quot;title&quot;, title));</span><br><span class="line">        boolQueryBuilder.minimumShouldMatch(1);</span><br><span class="line">    &#125;</span><br><span class="line">    // 按内容检索</span><br><span class="line">    if (StringUtils.isNotBlank(content)) &#123;</span><br><span class="line">        boolQueryBuilder.should(QueryBuilders.matchQuery(&quot;content&quot;, content));</span><br><span class="line">        boolQueryBuilder.minimumShouldMatch(1);</span><br><span class="line">    &#125;</span><br><span class="line">    // 分页</span><br><span class="line">    PageRequest pageRequest = PageRequest.of((int) current, (int) pageSize);</span><br><span class="line">    // 构造查询</span><br><span class="line">    NativeSearchQuery searchQuery = new NativeSearchQueryBuilder().withQuery(boolQueryBuilder)</span><br><span class="line">            .withPageable(pageRequest).build();</span><br><span class="line">    SearchHits&lt;PostEsDTO&gt; searchHits = elasticsearchRestTemplate.search(searchQuery, PostEsDTO.class);</span><br><span class="line">    Page&lt;Post&gt; page = new Page&lt;&gt;();</span><br><span class="line">    page.setTotal(searchHits.getTotalHits());</span><br><span class="line">    List&lt;Post&gt; resourceList = new ArrayList&lt;&gt;();</span><br><span class="line">    // 查出结果后，从 db 获取最新动态数据（比如点赞数）</span><br><span class="line">    if (searchHits.hasSearchHits()) &#123;</span><br><span class="line">        List&lt;SearchHit&lt;PostEsDTO&gt;&gt; searchHitList = searchHits.getSearchHits();</span><br><span class="line">        List&lt;Long&gt; postIdList = searchHitList.stream().map(searchHit -&gt; searchHit.getContent().getId())</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        List&lt;Post&gt; postList = baseMapper.selectBatchIds(postIdList);</span><br><span class="line">        if (postList != null) &#123;</span><br><span class="line">            Map&lt;Long, List&lt;Post&gt;&gt; idPostMap = postList.stream().collect(Collectors.groupingBy(Post::getId));</span><br><span class="line">            postIdList.forEach(postId -&gt; &#123;</span><br><span class="line">                if (idPostMap.containsKey(postId)) &#123;</span><br><span class="line">                    resourceList.add(idPostMap.get(postId).get(0));</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // 从 es 清空 db 已物理删除的数据</span><br><span class="line">                    String delete = elasticsearchRestTemplate.delete(String.valueOf(postId), PostEsDTO.class);</span><br><span class="line">                    log.info(&quot;delete post &#123;&#125;&quot;, delete);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    page.setRecords(resourceList);</span><br><span class="line">    return page;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/#if&gt;</span><br></pre></td></tr></table></figure>

<p>PostService.java.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;#if needEs&gt; </span><br><span class="line">/**</span><br><span class="line"> * 从 ES 查询</span><br><span class="line"> *</span><br><span class="line"> * @param postQueryRequest</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">Page&lt;Post&gt; searchFromEs(PostQueryRequest postQueryRequest);</span><br><span class="line">&lt;/#if&gt;</span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;#if needEs&gt;</span><br><span class="line"># Elasticsearch 配置</span><br><span class="line"># todo 需替换配置，然后取消注释</span><br><span class="line">#  elasticsearch:</span><br><span class="line">#    uris: http://localhost:9200</span><br><span class="line">#    username: $&#123;mysqlConfig.username&#125;</span><br><span class="line">#    password: $&#123;mysqlConfig.password&#125;</span><br><span class="line">&lt;/#if&gt;</span><br></pre></td></tr></table></figure>

<p>写JSON配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: 1,</span><br><span class="line">  &quot;fileConfig&quot;: &#123;</span><br><span class="line">    &quot;files&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;path&quot;: &quot;src/main/java/com/yupi/springbootinit/model/dto/post/PostEsDTO.java&quot;,</span><br><span class="line">        &quot;condition&quot;: &quot;needPost &amp;&amp; needEs&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;modelConfig&quot;: &#123;</span><br><span class="line">    &quot;models&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;fieldName&quot;: &quot;needEs&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;boolean&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;是否开启ES功能&quot;,</span><br><span class="line">        &quot;defaultValue&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<p>发现有bug，这个bug用工具不好做，那就自己修改，将以下内容从帖子组移到外面即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;inputPath&quot;: &quot;src/main/java/com/yupi/springbootinit/model/dto/post/PostEsDTO.java.ftl&quot;,</span><br><span class="line">    &quot;outputPath&quot;: &quot;src/main/java/com/yupi/springbootinit/model/dto/post/PostEsDTO.java&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;file&quot;,</span><br><span class="line">    &quot;generateType&quot;: &quot;dynamic&quot;,</span><br><span class="line">    &quot;condition&quot;: &quot;needPost &amp;&amp; needEs&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>



<p>这样springboot-init的模板就制作完成</p>
<p>自动制作模板的工具放在template 下</p>
<p>流程：先用模板生成工具生成ftl文件和meta.json，在利用程序执行并替换ftl文件</p>
<p>bug：mybatis和freeMark起冲突</p>
<p>解决方法：手动修改mapper.xml.ftl文件</p>
<p>&lt;#noparse &gt;不解析这个字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where updateTime &gt;= &lt;#noparse &gt;#&#123;minUpdateTime&#125;&lt;/#noparse &gt;</span><br></pre></td></tr></table></figure>







<h2 id="4-代码生成器线上化"><a href="#4-代码生成器线上化" class="headerlink" title="4.代码生成器线上化"></a>4.代码生成器线上化</h2><h3 id="数据库表设计"><a href="#数据库表设计" class="headerlink" title="数据库表设计"></a>数据库表设计</h3><p>1.一定要结合业务，以实际的业务需求为主</p>
<p>2.多去参考同类业务的库表设计，可以在Github上搜下</p>
<p>什么情况下用JSON并且用Text类型存JSON的好处？</p>
<p>情况：字段比较多，嵌套层级比较复杂，并且后面不确定是否需要增加新的字段的情况下用JSON，且数据量不大的情况下</p>
<p>好处：在业务层面读取数据再转化成代码会更灵活，让整个数据表不容易变更</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-- 用户表</span><br><span class="line">create table if not exists user</span><br><span class="line">(</span><br><span class="line">    id           bigint auto_increment comment &#x27;id&#x27; primary key,</span><br><span class="line">    userAccount  varchar(256)                           not null comment &#x27;账号&#x27;,</span><br><span class="line">    userPassword varchar(512)                           not null comment &#x27;密码&#x27;,</span><br><span class="line">    userName     varchar(256)                           null comment &#x27;用户昵称&#x27;,</span><br><span class="line">    userAvatar   varchar(1024)                          null comment &#x27;用户头像&#x27;,</span><br><span class="line">    userProfile  varchar(512)                           null comment &#x27;用户简介&#x27;,</span><br><span class="line">    userRole     varchar(256) default &#x27;user&#x27;            not null comment &#x27;用户角色：user/admin/ban&#x27;,</span><br><span class="line">    createTime   datetime     default CURRENT_TIMESTAMP not null comment &#x27;创建时间&#x27;,</span><br><span class="line">    updateTime   datetime     default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment &#x27;更新时间&#x27;,</span><br><span class="line">    isDelete     tinyint      default 0                 not null comment &#x27;是否删除&#x27;,</span><br><span class="line">    index idx_userAccount (userAccount)</span><br><span class="line">) comment &#x27;用户&#x27; collate = utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">-- 代码生成器表</span><br><span class="line">create table if not exists generator</span><br><span class="line">(</span><br><span class="line">    id          bigint auto_increment comment &#x27;id&#x27; primary key,</span><br><span class="line">    name        varchar(128)                       null comment &#x27;名称&#x27;,</span><br><span class="line">    description text                               null comment &#x27;描述&#x27;,</span><br><span class="line">    basePackage varchar(128)                       null comment &#x27;基础包&#x27;,</span><br><span class="line">    version     varchar(128)                       null comment &#x27;版本&#x27;,</span><br><span class="line">    author      varchar(128)                       null comment &#x27;作者&#x27;,</span><br><span class="line">    tags        varchar(1024)                      null comment &#x27;标签列表（json 数组）&#x27;,</span><br><span class="line">    picture     varchar(256)                       null comment &#x27;图片&#x27;,</span><br><span class="line">    fileConfig  text                               null comment &#x27;文件配置（json字符串）&#x27;,</span><br><span class="line">    modelConfig text                               null comment &#x27;模型配置（json字符串）&#x27;,</span><br><span class="line">    distPath    text                               null comment &#x27;代码生成器产物路径&#x27;,</span><br><span class="line">    status      int      default 0                 not null comment &#x27;状态&#x27;,</span><br><span class="line">    userId      bigint                             not null comment &#x27;创建用户 id&#x27;,</span><br><span class="line">    createTime  datetime default CURRENT_TIMESTAMP not null comment &#x27;创建时间&#x27;,</span><br><span class="line">    updateTime  datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment &#x27;更新时间&#x27;,</span><br><span class="line">    isDelete    tinyint  default 0                 not null comment &#x27;是否删除&#x27;,</span><br><span class="line">    index idx_userId (userId)</span><br><span class="line">    ) comment &#x27;代码生成器&#x27; collate = utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>



<p>先删除前端后端初始化模板当中的.git文件</p>
<p>rm -rf .git</p>
<h3 id="后端初始化"><a href="#后端初始化" class="headerlink" title="后端初始化"></a>后端初始化</h3><p>删除多余文件：</p>
<p>dto下的generator是与前端进行交互的，Generator里面不是所有字段都要用，要进行划分</p>
<p>给该增删改查的对象类代码</p>
<p>generator包下dto中与前端交互的类</p>
<p>generatorVO类要多一个创建人的信息，用于后端给前端返回数据时标识创建人信息</p>
<p>修改实体类和实体封装类代码</p>
<h3 id="前端初始化"><a href="#前端初始化" class="headerlink" title="前端初始化"></a>前端初始化</h3><p>技巧：看网页控制台确定是前端出问题还是后端出问题</p>
<p>bug：后端接收的是对象，而前端传的字符串会报错</p>
<p>解决办法：在前端输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fields.fileConfig = JSON.parse((fields.fileConfig || &#x27;&#123;&#125;&#x27;) as string);</span><br><span class="line">fields.modelConfig = JSON.parse((fields.modelConfig || &#x27;&#123;&#125;&#x27;) as string);</span><br></pre></td></tr></table></figure>



<p>bug：后端返回给前端的是JSON字符串，不能直接返回，返回时先进行转化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">initialValues: &#123;</span><br><span class="line">  ...oldData,</span><br><span class="line">  tags: JSON.parse(oldData.tags||&#x27;[]&#x27;),</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>



<p>但是页面放大和缩小发现表格表头太挤</p>
<p>解决方法：修改页面的标签（在generator&#x2F;index.tsx）为div</p>
<p>在前端页面写标题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;Typography.Title level=&#123;4&#125; style=&#123;&#123;marginBottom:16&#125;&#125;&gt;生成器管理&lt;/Typography.Title&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>前端主页设计</p>
<p>1.先定义数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 1.先获取数据</span><br><span class="line"> * 默认分页参数</span><br><span class="line"> */</span><br><span class="line">const DEFAULT_PAGE_PARAMS:PageRequest = &#123;</span><br><span class="line">  current: 1,</span><br><span class="line">  pageSize: 4,</span><br><span class="line">  sortField: &#x27;createTime&#x27;,</span><br><span class="line">  sortOrder: &#x27;descend&#x27;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.从后端获取数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">//2.从后端获取数据</span><br><span class="line">//指定搜索的条件</span><br><span class="line">const [loading,setLoding] = useState&lt;boolean&gt;(true);</span><br><span class="line">const [dataList,setDataList]=useState&lt;API.GeneratorVO[]&gt;([]);</span><br><span class="line">const [total,setTotal]=useState&lt;number&gt;(0);</span><br><span class="line"></span><br><span class="line">//搜索条件，定义成对象是防止初始变量发生污染</span><br><span class="line">const [searchParam,setSearchParam] = useState&lt;API.GeneratorQueryRequest&gt;(</span><br><span class="line">  &#123;</span><br><span class="line">    ...DEFAULT_PAGE_PARAMS</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 搜索数据：发送请求，后端再返回</span><br><span class="line"> */</span><br><span class="line">//await只能在async修饰的方法中使用</span><br><span class="line">const doSearch = async () =&gt;&#123;</span><br><span class="line">  setLoding(true);</span><br><span class="line">  try&#123;</span><br><span class="line">    const res=await listGeneratorVoByPage(searchParam);</span><br><span class="line">    //如果res.data存在则是records 否则是[]</span><br><span class="line">    setDataList(res.data?.records ?? []);</span><br><span class="line">    //total在后端定义的是long类型 而前端total返回的是字符串</span><br><span class="line">    //原因：前端long类型是比后端long类型低的，如果后端传一个特别大的数，后端可能丢失精度，所以用string类型代替</span><br><span class="line">    setTotal(Number(res.data?.total) ?? 0)</span><br><span class="line"></span><br><span class="line">  &#125;catch (error:any)&#123;</span><br><span class="line">    message.error(&quot;获取数据失败&quot;+error.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//当searchParam发生变化时就会触发方法的执行</span><br><span class="line">useEffect(()=&gt;&#123;</span><br><span class="line">  doSearch();</span><br><span class="line">&#125;,[searchParam])</span><br></pre></td></tr></table></figure>

<p>3.设计页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">//3.设计页面，先不设计事件</span><br><span class="line">return&lt;PageContainer&gt;</span><br><span class="line">  &lt;Input.Search</span><br><span class="line">    placeholder=&quot;搜索生成器&quot;</span><br><span class="line">    allowClear</span><br><span class="line">    enterButton=&quot;搜索&quot;</span><br><span class="line">    size=&quot;large&quot;</span><br><span class="line">    onSearch=&#123;()=&gt;&#123;</span><br><span class="line"></span><br><span class="line">    &#125;&#125;</span><br><span class="line">  /&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;Tabs</span><br><span class="line">    defaultActiveKey=&quot;newest&quot;</span><br><span class="line">    items = &#123;[</span><br><span class="line">      &#123;</span><br><span class="line">        key: &#x27;newest&#x27;,</span><br><span class="line">        label: &#x27;最新&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        //伙伴匹配系统讲过推荐</span><br><span class="line">        key: &#x27;recommend&#x27;,</span><br><span class="line">        label: &#x27;推荐&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      ]&#125;</span><br><span class="line">    onChange=&#123;()=&gt;&#123;</span><br><span class="line"></span><br><span class="line">    &#125;&#125; /&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;QueryFilter</span><br><span class="line">    submitter=&#123;false&#125;</span><br><span class="line">    span=&#123;24&#125;</span><br><span class="line">    labelWidth=&quot;auto&quot;</span><br><span class="line">    split</span><br><span class="line">    onChange=&#123;()=&gt;&#123;</span><br><span class="line"></span><br><span class="line">    &#125;&#125;</span><br><span class="line">  &gt;</span><br><span class="line"></span><br><span class="line">    &lt;ProFormSelect label=&quot;标签&quot; name=&quot;tags&quot; mode=&quot;tags&quot;/&gt;</span><br><span class="line">    &lt;ProFormText label=&quot;名称&quot; name=&quot;name&quot;  /&gt;</span><br><span class="line">    &lt;ProFormText label=&quot;描述&quot;  name=&quot;description&quot;  /&gt;</span><br><span class="line">  &lt;/QueryFilter&gt;</span><br></pre></td></tr></table></figure>



<p>国内无法下载ant-design</p>
<p>可以使用国内备份：</p>
<p>git clone <a class="link"   target="_blank" rel="noopener" href="https://gitee.com/ant-design/ant-design-pro" >https://gitee.com/ant-design/ant-design-pro<i class="fas fa-external-link-alt"></i></a> –depth&#x3D;1 安装目录</p>
<p>git clone <a class="link"   target="_blank" rel="noopener" href="https://gitee.com/ant-design/ant-design-pro" >https://gitee.com/ant-design/ant-design-pro<i class="fas fa-external-link-alt"></i></a> –depth&#x3D;1 –branch all-blocks myapp</p>
<p>主页代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line">import &#123; listGeneratorVoByPage &#125; from &#x27;@/services/backend/generatorController&#x27;;</span><br><span class="line">import &#123; PageContainer, ProFormSelect, ProFormText, QueryFilter &#125; from &#x27;@ant-design/pro-components&#x27;;</span><br><span class="line">import &#123;Avatar, Card, List, message, Space, Tabs, Tag&#125; from &#x27;antd&#x27;;</span><br><span class="line">import &#123; Typography &#125; from &#x27;antd/lib&#x27;;</span><br><span class="line">import Input from &#x27;antd/lib/input&#x27;;</span><br><span class="line">import moment from &#x27;moment&#x27;;</span><br><span class="line">import React, &#123;useEffect, useRef, useState&#125; from &#x27;react&#x27;;</span><br><span class="line">import &#123;UserOutline&#125; from &quot;antd-mobile-icons&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 1.先获取数据</span><br><span class="line"> * 默认分页参数</span><br><span class="line"> */</span><br><span class="line">const DEFAULT_PAGE_PARAMS: PageRequest = &#123;</span><br><span class="line">  current: 1,</span><br><span class="line">  pageSize: 4,</span><br><span class="line">  sortField: &#x27;createTime&#x27;,</span><br><span class="line">  sortOrder: &#x27;descend&#x27;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const IndexPage: React.FC = () =&gt; &#123;</span><br><span class="line">  //2.从后端获取数据</span><br><span class="line">  //指定搜索的条件</span><br><span class="line">  const [loading, setLoading] = useState&lt;boolean&gt;(true);</span><br><span class="line">  const [dataList, setDataList] = useState&lt;API.GeneratorVO[]&gt;([]);</span><br><span class="line">  const [total, setTotal] = useState&lt;number&gt;(0);</span><br><span class="line"></span><br><span class="line">  //搜索条件，定义成对象是防止初始变量发生污染</span><br><span class="line">  const [searchParam, setSearchParam] = useState&lt;API.GeneratorQueryRequest&gt;(&#123;</span><br><span class="line">    ...DEFAULT_PAGE_PARAMS,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  const searchRef=useRef();</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * 搜索数据：发送请求，后端再返回</span><br><span class="line">   */</span><br><span class="line">    //await只能在async修饰的方法中使用</span><br><span class="line">    //查询前loading为true，查询后loading为false</span><br><span class="line">  const doSearch = async () =&gt; &#123;</span><br><span class="line">    setLoading(true);</span><br><span class="line">    try &#123;</span><br><span class="line">      const res = await listGeneratorVoByPage(searchParam);</span><br><span class="line">      //如果res.data存在则是records 否则是[]</span><br><span class="line">      setDataList(res.data?.records ?? []);</span><br><span class="line">      //total在后端定义的是long类型 而前端total返回的是字符串</span><br><span class="line">      //原因：前端long类型是比后端long类型低的，如果后端传一个特别大的数，后端可能丢失精度，所以用string类型代替</span><br><span class="line">      setTotal(Number(res.data?.total) ?? 0);</span><br><span class="line">    &#125; catch (error: any) &#123;</span><br><span class="line">      message.error(&#x27;获取数据失败&#x27; + error.message);</span><br><span class="line">    &#125;</span><br><span class="line">    setLoading(false);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  //当searchParam发生变化时就会触发方法的执行</span><br><span class="line">  useEffect(() =&gt; &#123;</span><br><span class="line">    doSearch();</span><br><span class="line">  &#125;, [searchParam]);</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * 标签列表</span><br><span class="line">   * @param tags</span><br><span class="line">   */</span><br><span class="line">  const tagListView = (tags?: string[])=&gt;&#123;</span><br><span class="line">    if (!tags)&#123;</span><br><span class="line">      return &lt;&gt;&lt;/&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return(</span><br><span class="line">        tags.map((tag)=&gt;(</span><br><span class="line">          &lt;Tag key=&#123;tag&#125;&gt;</span><br><span class="line">            &#123;tag&#125;</span><br><span class="line">          &lt;/Tag&gt;</span><br><span class="line">        ))</span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  //3.设计页面，先不设计事件</span><br><span class="line">  return (</span><br><span class="line">    &lt;PageContainer&gt;</span><br><span class="line">      &lt;Input.Search</span><br><span class="line">        ref=&#123;searchRef as any&#125;</span><br><span class="line">        placeholder=&quot;搜索生成器&quot;</span><br><span class="line">        allowClear</span><br><span class="line">        enterButton=&quot;搜索&quot;</span><br><span class="line">        size=&quot;large&quot;</span><br><span class="line">        onChange=&#123;(e)=&gt;&#123;</span><br><span class="line">            searchParam.searchText =e.target.value;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">        onSearch=&#123;(value:string) =&gt; &#123;</span><br><span class="line">          setSearchParam(&#123;</span><br><span class="line">            ...DEFAULT_PAGE_PARAMS,</span><br><span class="line">            searchText:value,</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;Tabs</span><br><span class="line">        defaultActiveKey=&quot;newest&quot;</span><br><span class="line">        items=&#123;[</span><br><span class="line">          &#123;</span><br><span class="line">            key: &#x27;newest&#x27;,</span><br><span class="line">            label: &#x27;最新&#x27;,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            //伙伴匹配系统讲过推荐</span><br><span class="line">            key: &#x27;recommend&#x27;,</span><br><span class="line">            label: &#x27;推荐&#x27;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ]&#125;</span><br><span class="line">        onChange=&#123;() =&gt; &#123;&#125;&#125;</span><br><span class="line">      /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;QueryFilter</span><br><span class="line">        span=&#123;12&#125;</span><br><span class="line">        labelWidth=&quot;auto&quot;</span><br><span class="line">        labelAlign=&quot;left&quot;</span><br><span class="line">        style=&#123;&#123; padding: &#x27;16px 0&#x27; &#125;&#125;</span><br><span class="line">        onFinish=&#123;async (values:API.GeneratorQueryRequest) =&gt; &#123;</span><br><span class="line">          setSearchParam(&#123;</span><br><span class="line">            ...DEFAULT_PAGE_PARAMS,</span><br><span class="line">            ...values,</span><br><span class="line">            searchText: searchParam.searchText,</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;ProFormSelect label=&quot;标签&quot; name=&quot;tags&quot; mode=&quot;tags&quot; /&gt;</span><br><span class="line">        &lt;ProFormText label=&quot;名称&quot; name=&quot;name&quot; /&gt;</span><br><span class="line">        &lt;ProFormText label=&quot;描述&quot; name=&quot;description&quot; /&gt;</span><br><span class="line">      &lt;/QueryFilter&gt;</span><br><span class="line"></span><br><span class="line">      &lt;List&lt;API.GeneratorVO&gt;</span><br><span class="line">        rowKey=&quot;id&quot;</span><br><span class="line">        loading=&#123;loading&#125;</span><br><span class="line">        grid=&#123;&#123;</span><br><span class="line">          gutter: 16,</span><br><span class="line">          xs: 1,</span><br><span class="line">          sm: 2,</span><br><span class="line">          md: 3,</span><br><span class="line">          lg: 3,</span><br><span class="line">          xl: 4,</span><br><span class="line">          xxl: 4,</span><br><span class="line">        &#125;&#125;</span><br><span class="line">        dataSource=&#123;dataList&#125;</span><br><span class="line">        pagination=&#123;&#123;</span><br><span class="line">          current: searchParam.current,</span><br><span class="line">          pageSize: searchParam.pageSize,</span><br><span class="line">          total,</span><br><span class="line">          onChange(current,pageSize)&#123;</span><br><span class="line">            setSearchParam(&#123;</span><br><span class="line">              ...searchParam,</span><br><span class="line">              current,</span><br><span class="line">              pageSize,</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">        renderItem=&#123;(data) =&gt; (</span><br><span class="line">          &lt;List.Item&gt;</span><br><span class="line">            &lt;Card hoverable cover=&#123;&lt;image alt=&#123;data.name&#125; src=&#123;data.picture&#125; /&gt;&#125;&gt;</span><br><span class="line">              &lt;Card.Meta</span><br><span class="line">                title=&#123;&lt;a&gt;&#123;data.name&#125;&lt;/a&gt;&#125;</span><br><span class="line">                description=&#123;</span><br><span class="line">                  &lt;Typography.Paragraph ellipsis=&#123;&#123; rows: 2 &#125;&#125;&gt;</span><br><span class="line">                    &#123;data.description&#125;</span><br><span class="line">                  &lt;/Typography.Paragraph&gt;</span><br><span class="line">                &#125;</span><br><span class="line">              /&gt;</span><br><span class="line">              &#123;tagListView(data.tags)&#125;</span><br><span class="line">              &lt;div&gt;</span><br><span class="line">                &lt;span&gt;&#123;moment(data.createTime).fromNow()&#125;&lt;/span&gt;</span><br><span class="line">                &lt;div&gt;</span><br><span class="line">                  &lt;Avatar size=&quot;large&quot; src=&#123;data.user?.userAvatar ?? &lt;UserOutline/&gt;&#125; /&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">            &lt;/Card&gt;</span><br><span class="line">          &lt;/List.Item&gt;</span><br><span class="line">        )&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/PageContainer&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export default IndexPage;</span><br></pre></td></tr></table></figure>



<h3 id="1-让用户可以上传代码生成器和代码生成器的详情页面，用户可以查看和下载代码生成器"><a href="#1-让用户可以上传代码生成器和代码生成器的详情页面，用户可以查看和下载代码生成器" class="headerlink" title="1.让用户可以上传代码生成器和代码生成器的详情页面，用户可以查看和下载代码生成器"></a>1.让用户可以上传代码生成器和代码生成器的详情页面，用户可以查看和下载代码生成器</h3><p>什么情况下存储到服务器上</p>
<p>如果是临时文件就存储到服务器上，控制好文件用完就删掉，不要导致资源的泄露</p>
<p>什么情况下用对象存储</p>
<p>需要持久化保存文件，并且允许用户下载，这种情况下就要用这种工具</p>
<h4 id="对象存储"><a href="#对象存储" class="headerlink" title="对象存储"></a>对象存储</h4><p>存储海量文件的分布式存储服务</p>
<p>使用腾讯云cos对象存储</p>
<p>私有读写：无论上传文件，写文件，还是下载文件都需要输入密钥</p>
<p>公有读私有写：允许用户读文件，只要知道地址就可以访问，但修改文件就需要密钥</p>
<p>公有读写：用户可以随便读写</p>
<p>直接下一步创建完成</p>
<h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h4><p>manager包下存的代码都是通用能力的代码</p>
<p>cos对象存储提供了两种下载方式</p>
<p>1.流</p>
<p>场景：返回给前端</p>
<p>2.直接把对象写入到本地文件中</p>
<p>场景：服务器需要处理文件，不用给用户和前端的情况下</p>
<p>前端调用后端的接口基本上就要考虑异步async</p>
<p>后端传给前端的图片使用的方式是流</p>
<p>如何把流转换成图片？</p>
<p>使用 file-saver 库，可以下载后端返回的 blob 内容为文件。</p>
<p>npm install file-saver<br>npm i –save-dev @types&#x2F;file-saver</p>
<p>如果能够扩展的同时不修改代码？</p>
<p>使用继承的特性，在继承父类的同时，通过调用父类的方法去修改，从而不需要修改原流程</p>
<p>例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class ZipGenerator extends GenerateTemplate &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected String buildDist(String outputPath, String sourceCopyDestPath, String jarPath, String shellOutputFilePath) &#123;</span><br><span class="line">        String distPath = super.buildDist(outputPath, sourceCopyDestPath, jarPath, shellOutputFilePath);</span><br><span class="line">        return super.buildDist(distPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上方式就是扩展</p>
<h4 id="编写通用的文件上传组件"><a href="#编写通用的文件上传组件" class="headerlink" title="编写通用的文件上传组件"></a>编写通用的文件上传组件</h4><p>1.上传压缩包</p>
<p>文件上传</p>
<p>2.上传代码生成器的图片</p>
<p>图片上传</p>
<p>代码实现（写两类上传组件）</p>
<p>文件上传组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">import &#123; COS_HOST &#125; from &#x27;@/constants&#x27;;</span><br><span class="line">import &#123;</span><br><span class="line">  testDownLoadFileUsingGet,</span><br><span class="line">  testUploadFileUsingPost,</span><br><span class="line">  uploadFileUsingPost</span><br><span class="line">&#125; from &#x27;@/services/backend/fileController&#x27;;</span><br><span class="line">import &#123; InboxOutlined &#125; from &#x27;@ant-design/icons&#x27;;</span><br><span class="line">import &#123;Button, Card, Divider, Flex, message, Upload, UploadFile, UploadProps&#125; from &#x27;antd&#x27;;</span><br><span class="line">import React, &#123; useState &#125; from &#x27;react&#x27;;</span><br><span class="line">import &#123;saveAs&#125; from &quot;file-saver&quot;;</span><br><span class="line"></span><br><span class="line">const &#123; Dragger &#125; = Upload;</span><br><span class="line"></span><br><span class="line">//让父级改变子组件的值</span><br><span class="line">interface Props&#123;</span><br><span class="line">  biz: string,</span><br><span class="line">  onChange?: (fileList: UploadFile[])=&gt; void;</span><br><span class="line">  value?: UploadFile[];</span><br><span class="line">  description?: string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 文件上传组件</span><br><span class="line"> * @constructor</span><br><span class="line"> */</span><br><span class="line">const FileUploader: React.FC&lt;Props&gt; = (props) =&gt; &#123;</span><br><span class="line">  const &#123;biz,value,description,onChange&#125; = props;</span><br><span class="line">  const [loading,setloading] = useState&lt;boolean&gt;(false);</span><br><span class="line"></span><br><span class="line">  const uploadProps: UploadProps = &#123;</span><br><span class="line">    name: &#x27;file&#x27;,</span><br><span class="line">    //是否允许上传多个文件</span><br><span class="line">    multiple: false,</span><br><span class="line">    //用组件最多上传的次数</span><br><span class="line">    maxCount: 1,</span><br><span class="line">    //展示文件列表的方式</span><br><span class="line">    listType: &quot;text&quot;,</span><br><span class="line">    //外层接收fileList，并作为参数</span><br><span class="line">    fileList: value,</span><br><span class="line">    //如果loading为true就禁用</span><br><span class="line">    disabled: loading,</span><br><span class="line">    //接收外层的onChange传入的参数，调用外层的属性onChange 把子组件的fileList传给外层的onChange</span><br><span class="line">    onChange(&#123; fileList&#125; ) &#123;</span><br><span class="line">      onChange?.(fileList);</span><br><span class="line">    &#125;,</span><br><span class="line">    customRequest: async (fileObj: any) =&gt; &#123;</span><br><span class="line">      setloading(true);</span><br><span class="line">      try &#123;</span><br><span class="line">        const res = await uploadFileUsingPost(</span><br><span class="line">          &#123;</span><br><span class="line">            biz,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;&#125;,</span><br><span class="line">          fileObj.file,</span><br><span class="line">        );</span><br><span class="line">        //onSuccess告诉组件什么时候成功展示</span><br><span class="line">        fileObj.onSuccess(res.data);</span><br><span class="line">      &#125; catch (e: any) &#123;</span><br><span class="line">        message.error(&#x27;上传失败，&#x27; + e.message);</span><br><span class="line">        fileObj.onError(e);</span><br><span class="line">      &#125;</span><br><span class="line">      setloading(false);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;Dragger &#123;...uploadProps&#125;&gt;</span><br><span class="line">      &lt;p className=&quot;ant-upload-drag-icon&quot;&gt;</span><br><span class="line">        &lt;InboxOutlined /&gt;</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">      &lt;p className=&quot;ant-upload-text&quot;&gt;点击或拖拽文件上传&lt;/p&gt;</span><br><span class="line">      &lt;p className=&quot;ant-upload-hint&quot;&gt;&#123;description&#125;&lt;/p&gt;</span><br><span class="line">    &lt;/Dragger&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export default FileUploader;</span><br></pre></td></tr></table></figure>

<p>图片上传组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">import &#123; COS_HOST &#125; from &#x27;@/constants&#x27;;</span><br><span class="line">import &#123;</span><br><span class="line">  testDownLoadFileUsingGet,</span><br><span class="line">  testUploadFileUsingPost,</span><br><span class="line">  uploadFileUsingPost</span><br><span class="line">&#125; from &#x27;@/services/backend/fileController&#x27;;</span><br><span class="line">import &#123;InboxOutlined, LoadingOutlined, PlusOutlined&#125; from &#x27;@ant-design/icons&#x27;;</span><br><span class="line">import &#123;Button, Card, Divider, Flex, message, Upload, UploadFile, UploadProps&#125; from &#x27;antd&#x27;;</span><br><span class="line">import React, &#123; useState &#125; from &#x27;react&#x27;;</span><br><span class="line">import &#123;saveAs&#125; from &quot;file-saver&quot;;</span><br><span class="line">import * as url from &quot;url&quot;;</span><br><span class="line"></span><br><span class="line">const &#123; Dragger &#125; = Upload;</span><br><span class="line"></span><br><span class="line">//让父级改变子组件的值</span><br><span class="line">interface Props&#123;</span><br><span class="line">  biz: string,</span><br><span class="line">  onChange?: (url: string)=&gt; void;</span><br><span class="line">  value?: string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 图片上传组件</span><br><span class="line"> * @constructor</span><br><span class="line"> */</span><br><span class="line">const PictureUploader: React.FC&lt;Props&gt; = (props) =&gt; &#123;</span><br><span class="line">  const &#123;biz,value,onChange&#125; = props;</span><br><span class="line">  const [loading,setloading] = useState&lt;boolean&gt;(false);</span><br><span class="line"></span><br><span class="line">  const uploadProps: UploadProps = &#123;</span><br><span class="line">    name: &#x27;file&#x27;,</span><br><span class="line">    //是否允许上传多个文件</span><br><span class="line">    multiple: false,</span><br><span class="line">    //用组件最多上传的次数</span><br><span class="line">    maxCount: 1,</span><br><span class="line">    //展示文件列表的方式</span><br><span class="line">    listType: &quot;picture-card&quot;,</span><br><span class="line">    //如果loading为true就禁用</span><br><span class="line">    disabled: loading,</span><br><span class="line">    //隐藏文件上传列表</span><br><span class="line">    showUploadList:false,</span><br><span class="line">    customRequest: async (fileObj: any) =&gt; &#123;</span><br><span class="line">      setloading(true);</span><br><span class="line">      try &#123;</span><br><span class="line">        const res = await uploadFileUsingPost(</span><br><span class="line">          &#123;</span><br><span class="line">            biz,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;&#125;,</span><br><span class="line">          fileObj.file,</span><br><span class="line">        );</span><br><span class="line">        //拼接完整图片路径</span><br><span class="line">        const fullPath = COS_HOST + res.data;</span><br><span class="line">        //第二种改变onChange的方式</span><br><span class="line">        onChange?.(fullPath ?? &#x27;&#x27;);</span><br><span class="line">        //onSuccess告诉组件什么时候成功展示</span><br><span class="line">        fileObj.onSuccess(res.data);</span><br><span class="line">      &#125; catch (e: any) &#123;</span><br><span class="line">        message.error(&#x27;上传失败，&#x27; + e.message);</span><br><span class="line">        fileObj.onError(e);</span><br><span class="line">      &#125;</span><br><span class="line">      setloading(false);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * 上传按钮</span><br><span class="line">   */</span><br><span class="line">  const uploadButton = (</span><br><span class="line">    &lt;button style=&#123;&#123; border: 0, background: &#x27;none&#x27; &#125;&#125; type=&quot;button&quot;&gt;</span><br><span class="line">      &#123;loading? &lt;LoadingOutlined/&gt; : &lt;PlusOutlined /&gt;&#125;</span><br><span class="line">      &lt;div style=&#123;&#123; marginTop: 8 &#125;&#125;&gt;上传&lt;/div&gt;</span><br><span class="line">    &lt;/button&gt;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;Upload &#123;...uploadProps&#125;&gt;</span><br><span class="line">      &#123;value ? &lt;img src=&#123;value&#125; alt=&quot;picture&quot; style=&#123;&#123;width: &#x27;100%&#x27;&#125;&#125; /&gt;: uploadButton&#125;</span><br><span class="line">    &lt;/Upload&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export default PictureUploader;</span><br></pre></td></tr></table></figure>

<p><strong>添加代码生成器</strong></p>
<p>todo：分布表单保存用户已填的数据</p>
<h4 id="开发详情页"><a href="#开发详情页" class="headerlink" title="开发详情页"></a>开发详情页</h4><p>1.根据id获取带用户信息的接口</p>
<p>2.根据id下载代码生成器的接口</p>
<p>后端不需要拼接完整路径，对象存储的下载就是靠相对路径</p>
<p>前端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//返回值是从方法传递过来的，所以需要&#123;&#125;</span><br><span class="line">const &#123;id&#125; = useParams();</span><br><span class="line">//返回值是自己定义的所以用[]</span><br><span class="line">const [loading, setloading]=useState&lt;boolean&gt;(true);</span><br></pre></td></tr></table></figure>



<p>如果在一个页面中的组件逻辑代码很复杂并且只在这个页面中使用，可以考虑在该页面的根目录下新建一个components</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;Tabs</span><br><span class="line">  size=&quot;large&quot;</span><br><span class="line">  defaultActiveKey=&#123;&#x27;FileConfig&#x27;&#125;</span><br><span class="line">  onChange=&#123;() =&gt; &#123;&#125;&#125;</span><br><span class="line">  items=&#123;[</span><br><span class="line">    &#123;</span><br><span class="line">      key: &#x27;fileConfig&#x27;,</span><br><span class="line">      label: &#x27;文件配置&#x27;,</span><br><span class="line">      children: &lt;FileConfig data=&#123;data&#125; /&gt;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      key: &#x27;modelConfig&#x27;,</span><br><span class="line">      label: &#x27;模型配置&#x27;,</span><br><span class="line">      children: &lt;ModelConfig data=&#123;data&#125; /&gt;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      key: &#x27;userInfo&#x27;,</span><br><span class="line">      label: &#x27;作者信息&#x27;,</span><br><span class="line">      children: &lt;AuthorInfo data=&#123;data&#125; /&gt;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ]&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>





<p>也可以这样在页面进行展示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Card.Meta title=&#123;user.userName&#125; description=&#123;user.userProfile&#125; avatar=&#123;</span><br><span class="line">  &lt;Avatar size=&#123;64&#125; src=&#123;user.userAvatar&#125;/&gt;</span><br><span class="line">&#125;/&gt;</span><br></pre></td></tr></table></figure>

<p>也可以直接在标签中写</p>
<p>如果要调用后端接口就用await和async</p>
<p>对象存储配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 对象存储</span><br><span class="line"># todo 需替换配置</span><br><span class="line">cos:</span><br><span class="line">  client:</span><br><span class="line">    accessKey: xxxxxx</span><br><span class="line">    secretKey: xxxxxx</span><br><span class="line">    region: xxxxx</span><br><span class="line">    bucket: xxxxxx</span><br></pre></td></tr></table></figure>







<h4 id="分组表单"><a href="#分组表单" class="headerlink" title="分组表单"></a>分组表单</h4><p>问题：当你一用表单就发现数据已经输入，但是没有分组的数据（例如分组的名称）</p>
<p>原因：当你使用表单时直接把第一个打开的表单里的值放到分组表单的Json位置，此后如果要输入分组表单值就不会该表</p>
<p>解决方法：降级处理，可以从老的数据里取值，防止修改时识别分组错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">interface Props &#123;</span><br><span class="line">  formRef: any;</span><br><span class="line">  oldData: any;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default (props: Props) =&gt; &#123;</span><br><span class="line">  const &#123; formRef ,oldData&#125; = props;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//注意要获取groupKey</span><br><span class="line">const modelConfig = formRef?.current?.getFieldsValue()?.modelConfig ?? oldData?.modelConfig;</span><br><span class="line">const groupKey = modelConfig.models?.[field.name]?.groupKey;</span><br></pre></td></tr></table></figure>



<h3 id="2-让用户能够在线使用代码生成器"><a href="#2-让用户能够在线使用代码生成器" class="headerlink" title="2.让用户能够在线使用代码生成器"></a>2.让用户能够在线使用代码生成器</h3><p>让用户能够在线使用代码生成器，在表单页面输入数据模型的值，就能直接下载生成的代码</p>
<h3 id="3-代码生成器在线制作功能"><a href="#3-代码生成器在线制作功能" class="headerlink" title="3.代码生成器在线制作功能"></a>3.代码生成器在线制作功能</h3><h4 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h4><p>1.将maker改为可以调用的接口</p>
<p>企业开发原则：不去改动代码，只需添加新的代码</p>
<p>问题：maker打成jar包后，模版制作工具就无法获得resource的文件的绝对路径（虚拟路径）</p>
<p>解决：freemaker提供了相对路径去查找</p>
<p>用相对路径去输入路径（不是通过File，而是通过类加载器）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 使用相对路径生成文件</span><br><span class="line"> *</span><br><span class="line"> * @param relativeInputPath 模板文件相对输入路径</span><br><span class="line"> * @param outputPath 输出路径</span><br><span class="line"> * @param model 数据模型</span><br><span class="line"> * @throws IOException</span><br><span class="line"> * @throws TemplateException</span><br><span class="line"> */</span><br><span class="line">public static void doGenerator(String relativeInputPath, String outputPath, Object model)throws IOException, TemplateException&#123;</span><br><span class="line">    //new出Configeration对象，参数为Freemarker版本号</span><br><span class="line">    Configuration configuration = new Configuration(Configuration.VERSION_2_3_32);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //获取模板文件所属包和名称</span><br><span class="line">    int lastSplitIndex = relativeInputPath.lastIndexOf(&quot;/&quot;);</span><br><span class="line">    //基础包路径：templates/java/model/</span><br><span class="line">    String basePackagePath = relativeInputPath.substring(0,lastSplitIndex);</span><br><span class="line">    //模板路径：DataModel.java.ftl</span><br><span class="line">    String templateName = relativeInputPath.substring(lastSplitIndex + 1);</span><br><span class="line"></span><br><span class="line">    //通过类加载器读取模板</span><br><span class="line">    //DynamicFileGenerator.class 相当于项目的根路径</span><br><span class="line">    ClassTemplateLoader templateLoader = new ClassTemplateLoader(DynamicFileGenerator.class,basePackagePath);</span><br><span class="line">    configuration.setTemplateLoader(templateLoader);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //设置模板文件的字符集</span><br><span class="line">    configuration.setDefaultEncoding(&quot;UTF-8&quot;);</span><br><span class="line"></span><br><span class="line">    //解决本地化敏感 例如2,023-&gt;2023</span><br><span class="line">    configuration.setNumberFormat(&quot;0.######&quot;);</span><br><span class="line"></span><br><span class="line">    //获取模板名称，创建模板对象，加载指定模板</span><br><span class="line">    Template template = configuration.getTemplate(templateName);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //如果文件目录不存在则创建目录</span><br><span class="line">    if (!FileUtil.exist(outputPath))&#123;</span><br><span class="line">        FileUtil.touch(outputPath);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>修改GenerateTemplate.java的代码逻辑</p>
<p>修改之前获取resource的绝对路径的代码变为空</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//读取 resources目录</span><br><span class="line">String inputResourcePath = &quot;&quot;;</span><br></pre></td></tr></table></figure>



<p>定义规范：</p>
<p>1.让用户上传压缩包，服务器也是根据压缩包下载</p>
<p>2.用户上传压缩包时，压缩包的子文件就是我们所需的文件，而不能再多一层</p>
<p>原因：因为meta.JSON文件里都是用相对路径</p>
<p>bug:注意，基本信息设置要全英文，不然不能打jar包</p>
<h3 id="4-优化"><a href="#4-优化" class="headerlink" title="4.优化"></a>4.优化</h3><h4 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h4><h5 id="下载性能优化"><a href="#下载性能优化" class="headerlink" title="下载性能优化"></a>下载性能优化</h5><p>下载：从远处服务器拉取文件</p>
<p>耗时最大：从对象存储下载文件</p>
<p>如果是大厂提供的服务，可以去看官方文档，里面有优化建议（搜最佳实践）</p>
<p>优化方式：</p>
<p><strong>1.用流式传输</strong></p>
<p>应用场景：</p>
<p>1.数据需要实时处理</p>
<p>2.服务器内存只有2G，而文件大小是4G时</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">try(OutputStream out = response.getOutputStream()) &#123;</span><br><span class="line">                 byte[] buffer = new byte[4096];</span><br><span class="line">                 int bytesRead = 0;</span><br><span class="line"></span><br><span class="line">                 while ((cosObjectInput.read(buffer) )!= -1)&#123;</span><br><span class="line">                     out.write(buffer,0,bytesRead);</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">            &#125;catch (Exception e)&#123;</span><br><span class="line">                //处理异常</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.自己制作缓存</strong></p>
<p>场景：读多写少，而且数据更新频率低（结合自己的业务场景：用户是需要使用生成器多还是编辑生成器多）</p>
<p>要素：</p>
<p>1.缓存哪些内容（不建议都缓存，缓存热点数据）</p>
<p>2.缓存如何淘汰</p>
<p>3.缓存key如何设计</p>
<p>4.如何保证缓存的一致性</p>
<h6 id="1-优化下载接口"><a href="#1-优化下载接口" class="headerlink" title="1.优化下载接口"></a>1.优化下载接口</h6><p>方法：在本地开辟缓存，缓存的key是文件所在的路径</p>
<p>注意：对于文件操作，如果第一次写入后就不要自己用代码强行写入缓存，还不如用某种规则，或者定时任务去扫描，扫描数据库中所有精华的生成器</p>
<p>写入操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 缓存代码生成器请求(只有管理员可以操作)</span><br><span class="line"> *</span><br><span class="line"> * @param generatorCacheRequest</span><br><span class="line"> * @param request  接收用户请求，判断用户是否登录</span><br><span class="line"> * @param response 提供下载的流，给下载提供信息</span><br><span class="line"> */</span><br><span class="line">@PostMapping(&quot;/cache&quot;)</span><br><span class="line">@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)</span><br><span class="line">public void cacheGenerator(@RequestBody GeneratorCacheRequest generatorCacheRequest, HttpServletRequest request, HttpServletResponse response) throws IOException &#123;</span><br><span class="line">    if (generatorCacheRequest==null || generatorCacheRequest.getId() &lt;= 0) &#123;</span><br><span class="line">        throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    long id = generatorCacheRequest.getId();</span><br><span class="line"></span><br><span class="line">    Generator generator = generatorService.getById(id);</span><br><span class="line">    if (generator == null) &#123;</span><br><span class="line">        throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    String distPath = generator.getDistPath();</span><br><span class="line">    if (StrUtil.isBlank(distPath)) &#123;</span><br><span class="line">        throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, &quot;产物包不存在&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String zipFilePath = getCacheFilePath(id,distPath);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        cosManager.download(distPath, zipFilePath);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new BusinessException(ErrorCode.SYSTEM_ERROR, &quot;生成器下载失败&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 获取缓存文件路径</span><br><span class="line"> *</span><br><span class="line"> * @param id cache目录下的id</span><br><span class="line"> * @param distPath 文件路径</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">public String getCacheFilePath(long id,String distPath)&#123;</span><br><span class="line">    //2.创建独立的工作空间，下载压缩包到本地</span><br><span class="line">    String projectPath = System.getProperty(&quot;user.dir&quot;);</span><br><span class="line">    //定义用户制作后上传的id</span><br><span class="line">    String tempDirPath = String.format(&quot;%s/.temp/cache/%s&quot;, projectPath, id);</span><br><span class="line">    String zipFilePath = tempDirPath + &quot;/&quot;+distPath;</span><br><span class="line">    return zipFilePath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>读操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//设置响应头(流式响应)</span><br><span class="line">response.setContentType(&quot;application/octet-stream;charSet=UTF-8&quot;);</span><br><span class="line">response.setHeader(&quot;Content-Disposition&quot;, &quot;attachment; filename&quot; + filePath);</span><br><span class="line"></span><br><span class="line">//指定缓存路径</span><br><span class="line">String zipFilePath = getCacheFilePath(id,filePath);</span><br><span class="line">//判断缓存是否存在</span><br><span class="line">if (FileUtil.exist(zipFilePath))&#123;</span><br><span class="line">    //写入响应</span><br><span class="line">    Files.copy(Paths.get(zipFilePath), response.getOutputStream());</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">COSObjectInputStream cosObjectInput = null;</span><br><span class="line">try &#123;</span><br><span class="line">    COSObject cosObject = cosManager.getObject(filePath);</span><br><span class="line">    cosObjectInput = cosObject.getObjectContent();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //处理下载到的流</span><br><span class="line">    byte[] bytes = IOUtils.toByteArray(cosObjectInput);</span><br><span class="line"></span><br><span class="line">    //写入响应</span><br><span class="line">    response.getOutputStream().write(bytes);</span><br><span class="line">    response.getOutputStream().flush();</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">    log.error(&quot;file upload error, filepath = &quot; + filePath, e);</span><br><span class="line">    throw new BusinessException(ErrorCode.SYSTEM_ERROR, &quot;下载失败&quot;);</span><br><span class="line">&#125; finally &#123;</span><br><span class="line">    if (cosObjectInput != null) &#123;</span><br><span class="line">        cosObjectInput.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>场景：官网下载安装包</p>
<p>优点：</p>
<p>1.省流量费用</p>
<p>2.自动取缓存（热key发现系统）：统计用户点了多少次下载，如果有一天下载次数超过了1000或者10000，就让系统自动缓存</p>
<p>推荐看：<a class="link"   target="_blank" rel="noopener" href="https://gitee.com/jd-platform-opensource/hotkey" >https://gitee.com/jd-platform-opensource/hotkey<i class="fas fa-external-link-alt"></i></a></p>
<h6 id="2-优化代码使用接口"><a href="#2-优化代码使用接口" class="headerlink" title="2.优化代码使用接口"></a>2.优化代码使用接口</h6><p>​	1.分析</p>
<p>检查接口部分代码耗时的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">StopWatch stopWatch = new StopWatch();</span><br><span class="line">stopWatch.start();</span><br><span class="line">测试代码</span><br><span class="line">stopWatch.stop();</span><br><span class="line">System.out.println(&quot;下载耗时:&quot;+stopWatch.getTotalTimeMillis());</span><br></pre></td></tr></table></figure>





<p>下载耗时:1134<br>解压耗时:44<br>写入JSON文件耗时:3<br>命令执行结束，退出码：0<br>执行脚本耗时:798<br>写入JSON文件耗时:7</p>
<p>很明显下载和执行脚本非常耗时</p>
<p>解压耗时:44<br>写入JSON文件耗时:3</p>
<p>方法</p>
<p>1.解决耗时，只能换个API</p>
<p>2.不解压，提前解压好，放到服务器上</p>
<p>下载耗时，可以用如上的下载文件去优化（本地有生成器直接可以从本地取，使用的过程中提前把生成器下载好）</p>
<p>不一定优化：</p>
<p>执行脚本的耗时不好优化，因为执行脚本操作调用的是之前开发好的脚本，就要去改生成器maker的项目，成本比较大（可以使用多线程并发生成文件）</p>
<p>扩展点：如果多个接口有相同的功能模块，可以把缓存复用</p>
<h6 id="3-优化制作代码接口"><a href="#3-优化制作代码接口" class="headerlink" title="3.优化制作代码接口"></a>3.优化制作代码接口</h6><p>优化下载耗时</p>
<p>优化制作代码（成本高，需求小）</p>
<p>思考之前讲过的思考优化的步骤，从前端到后端</p>
<h4 id="查询性能优化"><a href="#查询性能优化" class="headerlink" title="查询性能优化"></a>查询性能优化</h4><p>1.数据需要高频访问</p>
<p>2.系统数据量大，查询比较慢</p>
<p>3.实时性要求高</p>
<p>方法：</p>
<p>1.精简数据:后端返回给前端的数值少一点，用不到的数据不需要给前端</p>
<p>怎么优化：如果一个页面都没用到后端传输过来的数据，那就不要传</p>
<p>例如：展示页面只是用来展示生成器，但是却没有用到后端传输的配置代码</p>
<p>新写一个接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 快速分页获取列表（封装类）</span><br><span class="line"> *</span><br><span class="line"> * @param generatorQueryRequest</span><br><span class="line"> * @param request</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@PostMapping(&quot;/list/page/vo/fast&quot;)</span><br><span class="line">public BaseResponse&lt;Page&lt;GeneratorVO&gt;&gt; listGeneratorVOByPageFast(@RequestBody GeneratorQueryRequest generatorQueryRequest,</span><br><span class="line">                                                             HttpServletRequest request) &#123;</span><br><span class="line">    long current = generatorQueryRequest.getCurrent();</span><br><span class="line">    long size = generatorQueryRequest.getPageSize();</span><br><span class="line">    // 限制爬虫</span><br><span class="line">    ThrowUtils.throwIf(size &gt; 20, ErrorCode.PARAMS_ERROR);</span><br><span class="line">    Page&lt;Generator&gt; generatorPage = generatorService.page(new Page&lt;&gt;(current, size),</span><br><span class="line">            generatorService.getQueryWrapper(generatorQueryRequest));</span><br><span class="line">    </span><br><span class="line">    Page&lt;GeneratorVO&gt; generatorVOPage = generatorService.getGeneratorVOPage(generatorPage, request);</span><br><span class="line">    generatorVOPage.getRecords().stream().forEach(generatorVO -&gt; &#123;</span><br><span class="line">        generatorVO.setFileConfig(null);</span><br><span class="line">        generatorVO.setModelConfig(null);</span><br><span class="line">    &#125;);</span><br><span class="line">    return ResultUtils.success(generatorVOPage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没换接口之前</p>
<p><img   src="/../image/Snipaste_2024-03-02_19-51-35.png"  alt="Snipaste_2024-03-02_19-51-35"></p>
<p><img   src="/../image/Snipaste_2024-03-02_19-48-52.png"  alt="Snipaste_2024-03-02_19-48-52"></p>
<p>压力测试：10000条数据</p>
<p>1.精简字段+优化SQL语句</p>
<p>关键：能不能做这个优化（看公司）</p>
<p>精简字段</p>
<p>例如：在进行SQL语句查询的时候，只查询该前端页面需要字段，删除多余字段（对着页面修改SQL语句）</p>
<p>优化SQL语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QueryWrapper&lt;Generator&gt; queryWrapper = generatorService.getQueryWrapper(generatorQueryRequest);</span><br><span class="line">queryWrapper.select(&quot;id&quot;,&quot;name&quot;,&quot;description&quot;,&quot;tags&quot;,&quot;picture&quot;,&quot;status&quot;,&quot;userId&quot;,&quot;createTime&quot;,&quot;updateTime&quot;);</span><br><span class="line">Page&lt;Generator&gt; generatorPage = generatorService.page(new Page&lt;&gt;(current, size), queryWrapper);</span><br></pre></td></tr></table></figure>



<p>数据库慢查询：查询时间超过100毫秒或者1s就是慢查询</p>
<p>性能指标：</p>
<p>1.qps：一秒钟处理多少请求</p>
<p>2.响应时长</p>
<p>在进行分页查表时，会先进行查询总数的操作，这一步也是很浪费时间的</p>
<p><img   src="/../image/Snipaste_2024-03-02_20-51-21.png"  alt="Snipaste_2024-03-02_20-51-21"></p>
<p>2.减少查询次数</p>
<p>3.增加索引</p>
<h5 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h5><p>即使没有真实的请求，也要模拟大量的请求来验证系统的性能到底多少</p>
<p>使用工具：jmeter</p>
<p>步骤</p>
<p>1.确定测试条件（环境或者电脑的配置）</p>
<p>2.每次请求的是同一个接口，要传递相同的参数</p>
<p>3.先测试正常情况，只要出现异常就要重新测试，争取所有用户都能正常响应的qps</p>
<p>注意：不要在线上压测</p>
<p>jmeter使用步骤</p>
<p><img   src="/../image/Snipaste_2024-03-02_21-06-58.png"  alt="Snipaste_2024-03-02_21-06-58"></p>
<p><img   src="/../image/Snipaste_2024-03-02_21-07-05.png"  alt="Snipaste_2024-03-02_21-07-05"></p>
<p><img   src="/../image/Snipaste_2024-03-02_21-09-31.png"  alt="Snipaste_2024-03-02_21-09-31"></p>
<p><img   src="/../image/Snipaste_2024-03-02_21-17-28.png"  alt="Snipaste_2024-03-02_21-17-28"></p>
<p><img   src="/../image/Snipaste_2024-03-02_21-24-46.png"  alt="Snipaste_2024-03-02_21-15-35"></p>
<p><img   src="/../image/Snipaste_2024-03-02_21-17-15.png"  alt="Snipaste_2024-03-02_21-17-15"></p>
<p><img   src="/../image/Snipaste_2024-03-02_21-18-57.png"  alt="Snipaste_2024-03-02_21-18-57"></p>
<p><img   src="/../image/Snipaste_2024-03-02_21-18-35.png"  alt="Snipaste_2024-03-02_21-18-35"></p>
<p><img   src="/../image/Snipaste_2024-03-02_21-20-38.png"  alt="Snipaste_2024-03-02_21-20-38"></p>
<p>记得转义</p>
<p><img   src="/../image/Snipaste_2024-03-02_21-21-48.png"  alt="Snipaste_2024-03-02_21-21-48"></p>
<p><img   src="/../image/Snipaste_2024-03-02_21-22-56.png"  alt="Snipaste_2024-03-02_21-22-56"></p>
<p><img   src="/../image/Snipaste_2024-03-02_21-28-20.png"  alt="Snipaste_2024-03-02_21-28-20"></p>
<p><img   src="/../image/Snipaste_2024-03-02_21-28-33.png"  alt="Snipaste_2024-03-02_21-28-33"></p>
<p>下图标出字段非常重要（压力测试的目标）</p>
<p>吞吐量：单位时间内处理请求的能力</p>
<p>qps：每秒平均查询量</p>
<p>tps：每秒平均处理事务（很复杂的操作）的能力</p>
<p><img   src="/../image/Snipaste_2024-03-02_21-29-53.png"  alt="Snipaste_2024-03-02_21-29-53"></p>
<p>提升查询性能的方式：缓存</p>
<p>使用Redis</p>
<p>理由：页面变更频率不大，两小时清理一下缓存，主页访问的用户数多（数据电商不适合用缓存）</p>
<p>设计步骤</p>
<p>1.缓存的内容</p>
<p>2.缓存的key（缓存key的规则：业务前缀-接口标识-数据分类-请求参数）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 获取分页缓存key</span><br><span class="line"> *</span><br><span class="line"> * @param generatorQueryRequest</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">private static  String getPageCacheKey(GeneratorQueryRequest generatorQueryRequest)&#123;</span><br><span class="line">    //把对象转换成Json字符串</span><br><span class="line">    String jsonStr = JSONUtil.toJsonStr(generatorQueryRequest);</span><br><span class="line">    //请求参数编码</span><br><span class="line">    String base64 = Base64Encoder.encode(jsonStr);</span><br><span class="line">    String key = &quot;generator:page:&quot;+ base64;</span><br><span class="line">    return  key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.缓存的数据</p>
<p>思考：缓存数据库还是一条数据，或者缓存查询的结果</p>
<p>缓存方式</p>
<p>1.缓存数据库查询的结果（更新频率低）</p>
<p>问题：假如按页去缓存，但是如果一页的数据更新了，那是不是所有的缓存都得更新</p>
<p>2.缓存数据库中每个id对应的数据，拿id去批量查询（页面需要更新）</p>
<p>例如：</p>
<p>1.author</p>
<p>缓存的对象</p>
<p>1.数据库（如果接口复杂，则选择数据库缓存）</p>
<p>2.接口（接口很简单，比如就是查询的情况下，缓存的对象可以是接口）</p>
<p>在接口中应用缓存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 快速分页获取列表（封装类）</span><br><span class="line"> *</span><br><span class="line"> * @param generatorQueryRequest</span><br><span class="line"> * @param request</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@PostMapping(&quot;/list/page/vo/fast&quot;)</span><br><span class="line">public BaseResponse&lt;Page&lt;GeneratorVO&gt;&gt; listGeneratorVOByPageFast(@RequestBody GeneratorQueryRequest generatorQueryRequest,</span><br><span class="line">                                                             HttpServletRequest request) &#123;</span><br><span class="line">    long current = generatorQueryRequest.getCurrent();</span><br><span class="line">    long size = generatorQueryRequest.getPageSize();</span><br><span class="line"></span><br><span class="line">    //从redis缓存中的查询过程</span><br><span class="line">    //优先从缓存读取</span><br><span class="line">    String cacheKey = getPageCacheKey(generatorQueryRequest);</span><br><span class="line">    //获取字符串类型的参数对象</span><br><span class="line">    ValueOperations&lt;String, String&gt; valueOperations = stringRedisTemplate.opsForValue();</span><br><span class="line">    //取值，看看redis有没有缓存</span><br><span class="line">    String cacheValue = valueOperations.get(cacheKey);</span><br><span class="line">    if (StrUtil.isNotBlank(cacheValue))&#123;</span><br><span class="line">        //把缓存数据从JSON字符串变为对象类型</span><br><span class="line">        Page&lt;GeneratorVO&gt; generatorVOPage = JSONUtil.toBean(cacheValue, new TypeReference&lt;Page&lt;GeneratorVO&gt;&gt;() &#123;</span><br><span class="line">        &#125;, false);</span><br><span class="line">        return ResultUtils.success(generatorVOPage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //如果没有缓存，则执行从数据库查询</span><br><span class="line"></span><br><span class="line">    // 限制爬虫</span><br><span class="line">    ThrowUtils.throwIf(size &gt; 20, ErrorCode.PARAMS_ERROR);</span><br><span class="line">    QueryWrapper&lt;Generator&gt; queryWrapper = generatorService.getQueryWrapper(generatorQueryRequest);</span><br><span class="line">    queryWrapper.select(&quot;id&quot;,&quot;name&quot;,&quot;description&quot;,&quot;tags&quot;,&quot;picture&quot;,&quot;status&quot;,&quot;userId&quot;,&quot;createTime&quot;,&quot;updateTime&quot;);</span><br><span class="line">    Page&lt;Generator&gt; generatorPage = generatorService.page(new Page&lt;&gt;(current, size), queryWrapper);</span><br><span class="line"></span><br><span class="line">    Page&lt;GeneratorVO&gt; generatorVOPage = generatorService.getGeneratorVOPage(generatorPage, request);</span><br><span class="line">    generatorVOPage.getRecords().stream().forEach(generatorVO -&gt; &#123;</span><br><span class="line">        generatorVO.setFileConfig(null);</span><br><span class="line">        generatorVO.setModelConfig(null);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    //写入缓存</span><br><span class="line">    //注意：一定要设置过期时间</span><br><span class="line">    valueOperations.set(cacheKey,JSONUtil.toJsonStr(generatorVOPage),100, TimeUnit.MINUTES);</span><br><span class="line">    return ResultUtils.success(generatorVOPage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>压力测试结果</p>
<p><img   src="/../image/Snipaste_2024-03-03_20-29-40.png"  alt="Snipaste_2024-03-03_20-29-40"></p>
<p>注意：在简历上写性能优化时要具体到某个字段，比如吞吐量，qps值等</p>
<p>再进一步优化</p>
<p>还有比分布式缓存更快的东西吗？</p>
<p>本地缓存</p>
<p>Caffeine：<a class="link"   target="_blank" rel="noopener" href="https://github.com/ben-manes/caffeine/wiki/Population-zh-CN" >https://github.com/ben-manes/caffeine/wiki/Population-zh-CN<i class="fas fa-external-link-alt"></i></a></p>
<p>思考本地缓存的缺点？</p>
<p>如果是线上项目要用本地缓存也不是直接用，而是要搭配redis做多级缓存</p>
<p>优点：快，不经过网络传输</p>
<p>缺点：多个服务器共享缓存，一个服务器存了缓存但是重启了后者被攻击挂了或者一上来就一大推数据直接把数据库击穿，那么这个服务器的缓存会被清理掉</p>
<h5 id="多级缓存的设计"><a href="#多级缓存的设计" class="headerlink" title="多级缓存的设计"></a>多级缓存的设计</h5><p>复用redis分布式缓存的持久化能力，服务挂了还能找到之前的缓存，不会让整个系统挂掉，能共享缓存，还可以使用本地缓存高性能的特点</p>
<p>二级缓存：本地+redis缓存</p>
<p>1.安装依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.github.ben-manes.caffeine&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;caffeine&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.1.8&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>2.实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 多级缓存</span><br><span class="line"> *</span><br><span class="line"> * @author &lt;a href=&quot;https://github.com/liyupi&quot;&gt;程序员鱼皮&lt;/a&gt;</span><br><span class="line"> * @from &lt;a href=&quot;https://yupi.icu&quot;&gt;编程导航知识星球&lt;/a&gt;</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class CacheManager &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 构建本地缓存</span><br><span class="line">     */</span><br><span class="line">    Cache&lt;String, String&gt; localCache = Caffeine.newBuilder()</span><br><span class="line">            .expireAfterWrite(100, TimeUnit.MINUTES)</span><br><span class="line">            .maximumSize(10_000)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 更新缓存</span><br><span class="line">     *</span><br><span class="line">     * @param key</span><br><span class="line">     * @param value</span><br><span class="line">     */</span><br><span class="line">    public void put(String key, String value) &#123;</span><br><span class="line">        // 添加或者更新一个缓存元素</span><br><span class="line">        localCache.put(key, value);</span><br><span class="line">        //写入缓存</span><br><span class="line">        //注意：一定要设置过期时间</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, value, 100, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 写入缓存</span><br><span class="line">     *</span><br><span class="line">     * @param key</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public String get(String key) &#123;</span><br><span class="line"></span><br><span class="line">        // 先从本地缓存查</span><br><span class="line">        String value = localCache.getIfPresent(key);</span><br><span class="line">        if (value != null) &#123;</span><br><span class="line">            return value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //本地缓存未命中，尝试从分布式缓存中查询</span><br><span class="line">        value = stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        if (value != null) &#123;</span><br><span class="line">            //将redis缓存写入到本地缓存</span><br><span class="line">            localCache.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 删除缓存</span><br><span class="line">     *</span><br><span class="line">     * @param key</span><br><span class="line">     */</span><br><span class="line">    public void deletes(String key) &#123;</span><br><span class="line">        // 移除一个缓存元素</span><br><span class="line">        localCache.invalidate(key);</span><br><span class="line">        stringRedisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>使用本地缓存</p>
<p><img   src="/../image/Snipaste_2024-03-03_21-39-42.png"  alt="Snipaste_2024-03-03_21-39-42"></p>
<p>压测结果</p>
<p><img   src="/../image/Snipaste_2024-03-03_21-41-51.png"  alt="Snipaste_2024-03-03_21-41-51"></p>
<p>进一步提高qps</p>
<p>刚刚优化的是接口的I&#x2F;O操作</p>
<p>但是还有另外一个优化的场景：计算优化（CPU资源）</p>
<p>怎么优化？</p>
<h5 id="计算优化"><a href="#计算优化" class="headerlink" title="计算优化"></a>计算优化</h5><p>1.删除多余的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">generatorVOPage.getRecords().stream().forEach(generatorVO -&gt; &#123;</span><br><span class="line">    generatorVO.setFileConfig(null);</span><br><span class="line">    generatorVO.setModelConfig(null);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>2.JSON字符串处理也是非常消耗CPU的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (StrUtil.isNotBlank(cacheValue))&#123;</span><br><span class="line">    //把缓存数据从JSON字符串变为对象类型</span><br><span class="line">    Page&lt;GeneratorVO&gt; generatorVOPage = JSONUtil.toBean(cacheValue, new TypeReference&lt;Page&lt;GeneratorVO&gt;&gt;() &#123;</span><br><span class="line">    &#125;, false);</span><br><span class="line">    return ResultUtils.success(generatorVOPage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤</p>
<p>1.meta对象支持序列化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class Meta implements Serializable &#123;</span><br></pre></td></tr></table></figure>

<p>2.修改CacheManager方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 多级缓存</span><br><span class="line"> *</span><br><span class="line"> * @author &lt;a href=&quot;https://github.com/liyupi&quot;&gt;程序员鱼皮&lt;/a&gt;</span><br><span class="line"> * @from &lt;a href=&quot;https://yupi.icu&quot;&gt;编程导航知识星球&lt;/a&gt;</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class CacheManager &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private RedisTemplate&lt;String,Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 构建本地缓存</span><br><span class="line">     */</span><br><span class="line">    Cache&lt;String, Object&gt; localCache = Caffeine.newBuilder()</span><br><span class="line">            .expireAfterWrite(100, TimeUnit.MINUTES)</span><br><span class="line">            .maximumSize(10_000)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 更新缓存</span><br><span class="line">     *</span><br><span class="line">     * @param key</span><br><span class="line">     * @param value</span><br><span class="line">     */</span><br><span class="line">    public void put(String key, Object value) &#123;</span><br><span class="line">        // 添加或者更新一个缓存元素</span><br><span class="line">        localCache.put(key, value);</span><br><span class="line">        //写入缓存</span><br><span class="line">        //注意：一定要设置过期时间</span><br><span class="line">        redisTemplate.opsForValue().set(key, value, 100, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 写入缓存</span><br><span class="line">     *</span><br><span class="line">     * @param key</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public Object get(String key) &#123;</span><br><span class="line"></span><br><span class="line">        // 先从本地缓存查</span><br><span class="line">        Object value = localCache.getIfPresent(key);</span><br><span class="line">        if (value != null) &#123;</span><br><span class="line">            return value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //本地缓存未命中，尝试从分布式缓存中查询</span><br><span class="line">        value = redisTemplate.opsForValue().get(key);</span><br><span class="line">        if (value != null) &#123;</span><br><span class="line">            //将redis缓存写入到本地缓存</span><br><span class="line">            localCache.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 删除缓存</span><br><span class="line">     *</span><br><span class="line">     * @param key</span><br><span class="line">     */</span><br><span class="line">    public void deletes(String key) &#123;</span><br><span class="line">        // 移除一个缓存元素</span><br><span class="line">        localCache.invalidate(key);</span><br><span class="line">        redisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.修改调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (cacheValue != null) &#123;</span><br><span class="line">    //把缓存数据从JSON字符串变为对象类型</span><br><span class="line">    Page&lt;GeneratorVO&gt; generatorVOPage = JSONUtil.toBean(cacheValue, new TypeReference&lt;Page&lt;GeneratorVO&gt;&gt;() &#123;</span><br><span class="line">    &#125;, false);</span><br><span class="line">    return ResultUtils.success(generatorVOPage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Object cacheValue = cacheManager.get(cacheKey);</span><br><span class="line">if (cacheValue != null) &#123;</span><br><span class="line">    //把缓存数据从JSON字符串变为对象类型</span><br><span class="line">    return ResultUtils.success((Page&lt;GeneratorVO&gt;)cacheValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bug：C:\Users\Administrator\.m2\repository\com\yupi\code-generator-maker\1.0-SNAPSHOT\code-generator-maker-1.0-SNAPSHOT.jar.1723797420990314750.tmp -&gt; C:\Users\Administrator\.m2\repository\com\yupi\code-generator-maker\1.0-SNAPSHOT\code-generator-maker-1.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure>

<p>解决方法：删掉后端的依赖中的版本号，改为1.0</p>
<p>问题：redis生成的key乱码了，而且看不到值</p>
<p>原因：之前是因为键和值都是String类型，redis改成了自己定义的对象类型，用的是String序列化工具，而现在使用的JDK序列化，而不是字符串序列化（此时的键值是对象信息）</p>
<p>解决方法：也可以在写入缓存的方法中设置字符串序列化，但是又会浪费性能，此时的情况下是性能最好的，但是就失去了可读性</p>
<p>测试结果：</p>
<p><img   src="/../image/Snipaste_2024-03-03_22-22-32.png"  alt="Snipaste_2024-03-03_22-22-32"></p>
<p>压测（优化了750倍）</p>
<p><img   src="/../image/Snipaste_2024-03-03_22-25-27.png"  alt="Snipaste_2024-03-03_22-25-27"></p>
<p>还能优化</p>
<p>如何知道是否能优化</p>
<p>方法：验证极限</p>
<p>1.请求层优化（注释）：AOP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//    @Around(&quot;execution(* com.yupi.web.controller.*.*(..))&quot;)</span><br></pre></td></tr></table></figure>

<p>2.修改Tomcat的配置（增加并发线程数：增加用户等待的场所）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tomcat:</span><br><span class="line">	//最大连接数</span><br><span class="line">  max-connections: 100000</span><br><span class="line">  //工作人员数量</span><br><span class="line">  threads:</span><br><span class="line">    max: 100000</span><br><span class="line">    //额外等待场所</span><br><span class="line">    accept-count: 1000</span><br></pre></td></tr></table></figure>

<p><img   src="/../image/Snipaste_2024-03-03_22-39-06.png"  alt="Snipaste_2024-03-03_22-39-06"></p>
<p>测试极限的方法：写一个接口，只返回ok（Tomcat空接口方式）</p>
<h5 id="vertX"><a href="#vertX" class="headerlink" title="vertX"></a>vertX</h5><p>反应式编程的思想：</p>
<p>1.引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/io.vertx/vertx-core --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.vertx&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;vertx-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.5.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>2.测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 可以看成一个服务器，设置一个vertical，相当于提供一个服务器，当做一个小的Tomcat</span><br><span class="line"> */</span><br><span class="line">public class MainVerticle extends AbstractVerticle &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void start() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        // 服务器创建服务</span><br><span class="line">        vertx.createHttpServer()</span><br><span class="line">                // 处理请求</span><br><span class="line">                .requestHandler(reg-&gt;&#123;</span><br><span class="line">                    reg.response().putHeader(&quot;Content-Type&quot;,&quot;application/json&quot;)</span><br><span class="line">                            .end(&quot;ok&quot;);</span><br><span class="line">                &#125;)</span><br><span class="line">                // Start listening</span><br><span class="line">                .listen(8888)</span><br><span class="line">                // Print the port</span><br><span class="line">                .onSuccess(server -&gt;</span><br><span class="line">                        System.out.println(</span><br><span class="line">                                &quot;HTTP server started on port &quot; + server.actualPort()</span><br><span class="line">                        )</span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Vertx vertx = Vertx.vertx();</span><br><span class="line">        Verticle mainVerticl = new MainVerticle();</span><br><span class="line">        vertx.deployVerticle(mainVerticl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>vertx上限高</p>
<p>为什么verx快</p>
<p>1.链式调用：</p>
<p>2.异步非阻塞：</p>
<p>3.反应式编程</p>
<p>4.事件总线</p>
<p><strong>异步非阻塞</strong> </p>
<p>异步：通知机制</p>
<p>非阻塞：线程不必等待，能干别的事（轮询：定期检查）</p>
<p>同步&#x2F;异步：更关注消息通信机制</p>
<p>阻塞&#x2F;非阻塞:线程在等结果的过程中能不能干别的事情</p>
<p>NIO（非阻塞I&#x2F;O）：Java提供的API</p>
<p><strong>反应式编程</strong></p>
<p>执行了stream后自动执行后面的方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList().stream().map().findFirst()</span><br></pre></td></tr></table></figure>

<p>经常用于数据流和事件处理</p>
<h4 id="存储优化"><a href="#存储优化" class="headerlink" title="存储优化"></a>存储优化</h4><p>对象存储：</p>
<p>比较适合存储用户头像，用户上传的文件等比较零散的文件，不需要特别明确层级关系的文件</p>
<p>对象存储的结构：key-&gt;value</p>
<p>比如: &#x2F;aaa&#x2F;aaa&#x3D;&gt; 文件a</p>
<p>而第三方存储对此进行了优化，把没有层级关系的key给组织到层级关系下</p>
<p>秒传原理：</p>
<p>用户1上传了文件1（2.5G）</p>
<p>用户2上传了一样的文件，就是文件名不同</p>
<p>秒传做的就是把不同文件名的相同文件映射到第一次上传的相同文件即可，不需要重新上传</p>
<h5 id="空间优化-1"><a href="#空间优化-1" class="headerlink" title="空间优化"></a>空间优化</h5><p>定时任务清理（注解：spring Scheduler）</p>
<p>缺点：多个服务器在相同时间内输出一样的内容，用户会收到多条一样的数据，这样做是不合理的</p>
<p>除非是这台机器与本地绑定的才这样做</p>
<p>问题：如何做到多台机器执行一次任务？</p>
<p>方法1：选出一个代表</p>
<p>if(p&#x3D;a){</p>
<p>执行这台机器</p>
<p>}</p>
<p>缺点：机器换了，代码得改，不是很灵活，不太适合容器化部署，网络信息不一致的场景</p>
<p>方法2：抢分布式锁</p>
<p>方法3：分布式任务调度系统</p>
<p>批量删除的问题：用户刚上传就删了</p>
<p>解决方法1：过滤掉刚上传的文件</p>
<p>方法2：把上传的时间作为前缀</p>
<h6 id="分布式任务调度系统"><a href="#分布式任务调度系统" class="headerlink" title="分布式任务调度系统"></a>分布式任务调度系统</h6><p>类比：</p>
<p>调度系统：老板</p>
<p>服务器：员工</p>
<p><strong>XXL-JOB</strong></p>
<p>开源：<a class="link"   target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job" >https://github.com/xuxueli/xxl-job<i class="fas fa-external-link-alt"></i></a></p>
<p>文档：<a class="link"   target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/" >https://www.xuxueli.com/xxl-job/<i class="fas fa-external-link-alt"></i></a></p>
<p>运行：</p>
<p>修改数据库密码</p>
<p>测试：</p>
<p>先编写demo</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 示例任务</span><br><span class="line"> *</span><br><span class="line"> * 开发步骤：</span><br><span class="line"> *      1、任务开发：在Spring Bean实例中，开发Job方法；</span><br><span class="line"> *      2、注解配置：为Job方法添加注解 &quot;@XxlJob(value=&quot;自定义jobhandler名称&quot;, init = &quot;JobHandler初始化方法&quot;, destroy = &quot;JobHandler销毁方法&quot;)&quot;，注解value值对应的是调度中心新建任务的JobHandler属性的值。</span><br><span class="line"> *      3、执行日志：需要通过 &quot;XxlJobHelper.log&quot; 打印执行日志；</span><br><span class="line"> *      4、任务结果：默认任务结果为 &quot;成功&quot; 状态，不需要主动设置；如有诉求，比如设置任务结果为失败，可以通过 &quot;XxlJobHelper.handleFail/handleSuccess&quot; 自主设置任务结果；</span><br><span class="line"> *</span><br><span class="line"> * @author xuxueli 2019-12-11 21:52:51</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class MyJobHandler &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 1、简单任务示例（Bean模式）</span><br><span class="line">     */</span><br><span class="line">    @XxlJob(&quot;MyJobHandler&quot;)</span><br><span class="line">    public void MyJobHandler() throws Exception &#123;</span><br><span class="line">        Thread.sleep(3000);</span><br><span class="line">        System.out.println(&quot;你好，我是zlz&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>2.查看任务管理</p>
<p>XXL-job运行停止原理：任务已经触发执行，关闭这个任务照样会执行，运行中的任务完成了就不会继续执行</p>
<h6 id="文件清理机制开发"><a href="#文件清理机制开发" class="headerlink" title="文件清理机制开发"></a>文件清理机制开发</h6><p>1.引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/com.xuxueli/xxl-job-core --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.xuxueli&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;xxl-job-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>2.写配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * xxl-job config</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">@Slf4j</span><br><span class="line">public class XxlJobConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span><br><span class="line">    private String adminAddresses;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span><br><span class="line">    private String accessToken;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span><br><span class="line">    private String appname;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span><br><span class="line">    private String address;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span><br><span class="line">    private String ip;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span><br><span class="line">    private int port;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span><br><span class="line">    private String logPath;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span><br><span class="line">    private int logRetentionDays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public XxlJobSpringExecutor xxlJobExecutor() &#123;</span><br><span class="line">        log.info(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;);</span><br><span class="line">        XxlJobSpringExecutor xxlJobSpringExecutor = new XxlJobSpringExecutor();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setAddress(address);</span><br><span class="line">        xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">        xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        return xxlJobSpringExecutor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.写配置文件，让配置类能读取到配置信息（在application.yml中）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># xxl-job 配置</span><br><span class="line">xxl:</span><br><span class="line">  job:</span><br><span class="line">    admin:</span><br><span class="line">      # xxl-job admin address list, such as &quot;http://address&quot; or &quot;http://address01,http://address02&quot;</span><br><span class="line">      addresses: http://127.0.0.1:8080/xxl-job-admin</span><br><span class="line">    # xxl-job, access token</span><br><span class="line">    accessToken: default_token</span><br><span class="line">    executor:</span><br><span class="line">      # xxl-job executor appname</span><br><span class="line">      appname: code-generator-web-backend</span><br><span class="line">      # xxl-job executor registry-address: default use address to registry , otherwise use ip:port if address is null</span><br><span class="line">      address:</span><br><span class="line">      # xxl-job executor server-info</span><br><span class="line">      ip:</span><br><span class="line">      port: 9999</span><br><span class="line">      # xxl-job executor log-path</span><br><span class="line">      logpath: logs/jobhandler</span><br><span class="line">      # xxl-job executor log-retention-days</span><br><span class="line">      logretentiondays: 30</span><br></pre></td></tr></table></figure>



<p>踩坑记录：下载源码后，记得先运行源码的admin项目，然后再在后端中引入xxl-job运行</p>
<p>4.在CosManager类下添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 删除对象</span><br><span class="line"> *</span><br><span class="line"> * @param key</span><br><span class="line"> * @return</span><br><span class="line"> * @throws CosClientException</span><br><span class="line"> * @throws CosServiceException</span><br><span class="line"> */</span><br><span class="line">public void deleteObject(String key) throws CosClientException, CosServiceException&#123;</span><br><span class="line">    cosClient.deleteObject(cosClientConfig.getBucket(),key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 批量删除对象(删除多个文件时不能加前缀，不然删不掉)</span><br><span class="line"> *</span><br><span class="line"> * @param keyList</span><br><span class="line"> * @return</span><br><span class="line"> * @throws MultiObjectDeleteException</span><br><span class="line"> * @throws CosClientException</span><br><span class="line"> * @throws CosServiceException</span><br><span class="line"> */</span><br><span class="line">public DeleteObjectsResult deleteObjects(List&lt;String&gt; keyList)</span><br><span class="line">        throws MultiObjectDeleteException, CosClientException, CosServiceException&#123;</span><br><span class="line"></span><br><span class="line">    DeleteObjectsRequest deleteObjectsRequest = new DeleteObjectsRequest(cosClientConfig.getBucket());</span><br><span class="line">    // 设置要删除的key列表, 最多一次删除1000个</span><br><span class="line">    ArrayList&lt;DeleteObjectsRequest.KeyVersion&gt; keyVersions = new ArrayList&lt;&gt;();</span><br><span class="line">    // 传入要删除的文件名</span><br><span class="line">    // 注意文件名不允许以正斜线/或者反斜线\开头，例如：</span><br><span class="line">    // 存储桶目录下有a/b/c.txt文件，如果要删除，只能是 keyList.add(new KeyVersion(&quot;a/b/c.txt&quot;)), 若使用 keyList.add(new KeyVersion(&quot;/a/b/c.txt&quot;))会导致删除不成功</span><br><span class="line"></span><br><span class="line">    for (String key : keyList) &#123;</span><br><span class="line">        keyVersions.add(new DeleteObjectsRequest.KeyVersion(key));</span><br><span class="line">    &#125;</span><br><span class="line">    deleteObjectsRequest.setKeys(keyVersions);</span><br><span class="line"></span><br><span class="line">    DeleteObjectsResult deleteObjectsResult = cosClient.deleteObjects(deleteObjectsRequest);</span><br><span class="line">    return deleteObjectsResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 删除目录(按照文件前缀删除，当心误删)，所以要变成/a/才行</span><br><span class="line"> *</span><br><span class="line"> * @param delPrefix</span><br><span class="line"> * @return</span><br><span class="line"> * @throws MultiObjectDeleteException</span><br><span class="line"> * @throws CosClientException</span><br><span class="line"> * @throws CosServiceException</span><br><span class="line"> */</span><br><span class="line">public void deleteDir(String delPrefix) throws CosClientException, CosServiceException&#123;</span><br><span class="line"></span><br><span class="line">    //1.构造查询文件列表的请求</span><br><span class="line">    ListObjectsRequest listObjectsRequest = new ListObjectsRequest();</span><br><span class="line">    // 设置 bucket 名称</span><br><span class="line">    listObjectsRequest.setBucketName(cosClientConfig.getBucket());</span><br><span class="line">    // prefix 表示列出的对象名以 prefix 为前缀</span><br><span class="line">    // 这里填要列出的目录的相对 bucket 的路径</span><br><span class="line">    listObjectsRequest.setPrefix(delPrefix);</span><br><span class="line">    // 设置最大遍历出多少个对象, 一次 listobject 最大支持1000</span><br><span class="line">    listObjectsRequest.setMaxKeys(1000);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // 保存每次列出的结果</span><br><span class="line">    ObjectListing objectListing = null;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    do &#123;</span><br><span class="line">        objectListing = cosClient.listObjects(listObjectsRequest);</span><br><span class="line"></span><br><span class="line">        // 这里保存列出的对象列表</span><br><span class="line">        List&lt;COSObjectSummary&gt; cosObjectSummaries = objectListing.getObjectSummaries();</span><br><span class="line">        //如果为空，不返回会报错</span><br><span class="line">        if (CollUtil.isEmpty(cosObjectSummaries))&#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;DeleteObjectsRequest.KeyVersion&gt; delObjects = new ArrayList&lt;DeleteObjectsRequest.KeyVersion&gt;();</span><br><span class="line"></span><br><span class="line">        for (COSObjectSummary cosObjectSummary : cosObjectSummaries) &#123;</span><br><span class="line">            delObjects.add(new DeleteObjectsRequest.KeyVersion(cosObjectSummary.getKey()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DeleteObjectsRequest deleteObjectsRequest = new DeleteObjectsRequest(cosClientConfig.getBucket());</span><br><span class="line">        deleteObjectsRequest.setKeys(delObjects);</span><br><span class="line">        //得到返回结果</span><br><span class="line">        cosClient.deleteObjects(deleteObjectsRequest);</span><br><span class="line"></span><br><span class="line">        // 标记下一次开始的位置(记录当前删到了第几个)</span><br><span class="line">        String nextMarker = objectListing.getNextMarker();</span><br><span class="line">        listObjectsRequest.setMarker(nextMarker);</span><br><span class="line">    &#125; while (objectListing.isTruncated());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5.写删除逻辑</p>
<p>难点：如何搞定已删除的代码生成器对应的产物包文件</p>
<p>​	1.查出已删除的代码生成器（mybatisplus无法直接找到已经被逻辑删除的文件）</p>
<p>​	在GeneratorMapper中写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @author zlz</span><br><span class="line"> * @description 针对表【generator(代码生成器)】的数据库操作Mapper</span><br><span class="line"> * @createDate 2023-12-27 20:49:39</span><br><span class="line"> * @Entity com.yupi.web.model.entity.Generator</span><br><span class="line"> */</span><br><span class="line">public interface GeneratorMapper extends BaseMapper&lt;Generator&gt; &#123;</span><br><span class="line"></span><br><span class="line">    @Select(&quot;SELECT id, distPath FROM my_db.generator WHERE isDelete = 1&quot;)</span><br><span class="line">    List&lt;Generator&gt; listDeletedGenerator();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	2.在ClearCosHandler.java中写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 示例任务</span><br><span class="line"> *</span><br><span class="line"> * 开发步骤：</span><br><span class="line"> *      1、任务开发：在Spring Bean实例中，开发Job方法；</span><br><span class="line"> *      2、注解配置：为Job方法添加注解 &quot;@XxlJob(value=&quot;自定义jobhandler名称&quot;, init = &quot;JobHandler初始化方法&quot;, destroy = &quot;JobHandler销毁方法&quot;)&quot;，注解value值对应的是调度中心新建任务的JobHandler属性的值。</span><br><span class="line"> *      3、执行日志：需要通过 &quot;XxlJobHelper.log&quot; 打印执行日志；</span><br><span class="line"> *      4、任务结果：默认任务结果为 &quot;成功&quot; 状态，不需要主动设置；如有诉求，比如设置任务结果为失败，可以通过 &quot;XxlJobHelper.handleFail/handleSuccess&quot; 自主设置任务结果；</span><br><span class="line"> *</span><br><span class="line"> * @author xuxueli 2019-12-11 21:52:51</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">public class ClearCosHandler &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private CosManager cosManager;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private GeneratorMapper generatorMapper;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 每天执行</span><br><span class="line">     */</span><br><span class="line">    @XxlJob(&quot;clearCosHandler&quot;)</span><br><span class="line">    public void clearCosHandler() throws Exception &#123;</span><br><span class="line">        //如果有依赖：上一个任务的条件是否达成？</span><br><span class="line">        log.info(&quot;clearCosHandler start&quot;);</span><br><span class="line">        //编写业务逻辑</span><br><span class="line">        //1.包括用户上传的模板制作文件</span><br><span class="line">        cosManager.deleteDir(&quot;/generator_make_template/&quot;);</span><br><span class="line"></span><br><span class="line">        //2.已删除的代码生成器对应的产物包文件（generator_dist）</span><br><span class="line">        List&lt;Generator&gt; generatorList = generatorMapper.listDeletedGenerator();</span><br><span class="line">        //3.过滤掉distPath不为空的数据</span><br><span class="line">        List&lt;String&gt; KeyList = generatorList.stream().map(Generator::getDistPath)</span><br><span class="line">                .filter(StrUtil::isNotBlank).collect(Collectors.toList());</span><br><span class="line">        //4.调用批量删除</span><br><span class="line">        cosManager.deleteObjects(KeyList);</span><br><span class="line">        log.info(&quot;clearCosHandler end&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>场景：如果一个任务依赖于上一个任务，最灵活的方式，执行后一个任务的时候判断上一个任务的条件是否达成，可以使用xxl-job的重试机制（任务执行的逻辑不要与任务调度中心做太强的绑定）</p>
<p>6.回到调度中心的前端页面</p>
<p><img   src="/../image/Snipaste_2024-03-04_15-24-40.png"  alt="Snipaste_2024-03-04_15-24-40"></p>
<p><img   src="/../image/Snipaste_2024-03-04_15-26-06.png"  alt="Snipaste_2024-03-04_15-26-06"></p>
<p>这个界面还提供传参，可以根据不同的参数调用不同的方法</p>
<p>但是这里有个bug：腾讯云提供的批量删除的文件路径是不能有前缀，而数据库查出来的路径是有前缀的，该如何解决</p>
<p>1.修改CosManager（通用）</p>
<p>2.修改ClearCosHandler（外层）</p>
<p>优势：外层调用时不用太注意，不需要修改已写代码的逻辑</p>
<p>缺点：别人知道这个坑，可能会多在ClearCosHandler加上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//3.过滤掉distPath不为空的数据</span><br><span class="line">List&lt;String&gt; KeyList = generatorList.stream().map(Generator::getDistPath)</span><br><span class="line">        .filter(StrUtil::isNotBlank)</span><br><span class="line">        //4.移除&quot;/&quot;前缀</span><br><span class="line">        .map(distPath-&gt; distPath.substring(1))</span><br><span class="line">        .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>



<h4 id="存储成本优化"><a href="#存储成本优化" class="headerlink" title="存储成本优化"></a>存储成本优化</h4><p>1.选择合适的存储（根据存储文件的访问数量来划分）</p>
<p>2.数据沉降</p>
<p>数据在海洋里。离海岸越近越容易被用户取到</p>
<p>策略：存一个月的数据，如果访问低则移到其他存储的类型当中（与cache类似，但是原理不同）</p>
<p>过程：1.先分析 2.沉降操作</p>
<p>方法2：自己分析，然后在后端调用API实现批量沉降或者转储到其他服务</p>
<h4 id="减少访问量"><a href="#减少访问量" class="headerlink" title="减少访问量"></a>减少访问量</h4><p>本地文件缓存</p>
<h4 id="存储安全性优化"><a href="#存储安全性优化" class="headerlink" title="存储安全性优化"></a>存储安全性优化</h4><p>公有读写任何情况都不建议开（攻击者上传有病毒的同名文件，会对用户造成损失）</p>
<p>预期：代码生成器只能让登录的用户下载</p>
<p>基本的安全管理</p>
<p>1.跨域</p>
<p>什么情况下对象存储要配置跨域</p>
<p>前端直接传文件到对象存储（跨域是浏览器的限制，如果你不在浏览器中发请求就不会有跨域）</p>
<p>但本项目是后端传文件到对象存储（不适用）</p>
<p>2.防盗链（重要，对象存储一定要开）</p>
<p>如果其他用户做了跟我一样的网站，盗用跟我一样的图片，那就是用我的流量</p>
<p>referer是指：当前的请求是从哪个网站发出的（防盗链就是判断这个，如果不是referer就拒绝掉）</p>
<p>referer为空就是不告诉你请求是哪里来的请求也拒绝掉</p>
<p>3.服务端加密（不建议，会对性能有影响，除非业务场景安全性高，而且设置公有读加密的意义不大）</p>
<p>现在的对象是以明文的方式存储，而服务端加密是在对象存储到对象存储之前就进行加密（比如数据库中的密码）</p>
<p>4.盗刷风险检测(会有设置建议)</p>
<p>5.权限管理</p>
<p>代码生成器仅有登录的用户下载</p>
<p>恶意用户通过查数据库得到dist地址，并且拼接成完整地址就可以直接下载，如何防止？</p>
<p>理想情况：某些图片能被用户直接查看，代码生成器等流量占用多的，必须让用户登录，调用后端，必须从后端下载，如何实现？</p>
<p>一般情况下两种方式结合</p>
<p>权限管理</p>
<p>1.创建用户</p>
<p>搜索CAM</p>
<p>收回权限</p>
<p>生成用户后的key只显示一次</p>
<p>最小权限原则：先全部拒绝</p>
<p>前端：<a class="link"   target="_blank" rel="noopener" href="http://ip/" >http://ip<i class="fas fa-external-link-alt"></i></a></p>
<p>后端：<a class="link"   target="_blank" rel="noopener" href="http://ip/api" >http://ip/api<i class="fas fa-external-link-alt"></i></a>, 实际运行在8120,通过nginx转发（解决跨域问题）</p>
<p>nginx:80端口</p>
<p>xxl-job:<a class="link"   target="_blank" rel="noopener" href="http://ip:8080/xxl-job-admin" >http://ip:8080/xxl-job-admin<i class="fas fa-external-link-alt"></i></a> ,实际运行在8080端口</p>
<p>数据库：3306端口</p>
<p>Redis:6379端口</p>
<p>java</p>
<p>maven</p>
<p>对象存储：第三方</p>
<p>注意：xxl-job用的依赖网上找不到要修改成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;parent&gt;</span><br><span class="line">    &lt;groupId&gt;com.xuxueli&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;xxl-job&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.4.0&lt;/version&gt;</span><br><span class="line">&lt;/parent&gt;</span><br></pre></td></tr></table></figure>

<p>注意：要把logback.xml的路径改成相对路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=&quot;log.path&quot; value=&quot;/data/applogs/xxl-job/xxl-job-admin.log&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>变为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=&quot;log.path&quot; value=&quot;xxl-job/xxl-job-admin.log&quot;/&gt;</span><br></pre></td></tr></table></figure>



<h2 id="服务器部署上线"><a href="#服务器部署上线" class="headerlink" title="服务器部署上线"></a>服务器部署上线</h2><p>前端部署</p>
<p>此时没后端且会404</p>
<p>解决方法：看文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">        # 用于配合 browserHistory使用</span><br><span class="line">        try_files $uri $uri/index.html /index.html;</span><br><span class="line"></span><br><span class="line">        # 如果有资源，建议使用 https + http2，配合按需加载可以获得更好的体验</span><br><span class="line">        # rewrite ^/(.*)$ https://preview.pro.ant.design/$1 permanent;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>







<p>后端配置</p>
<p>改两处</p>
<p>1.修改maker下的jargenerator</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//调用 Process 类执行Maven 打包命令</span><br><span class="line">//先执行clean清除缓存，再打包</span><br><span class="line">// -DiskTests=true:跳过所有的测试用例，打包更快</span><br><span class="line">//不同操作系统的命令是不一样的</span><br><span class="line"></span><br><span class="line">String winMavenCommand = &quot;mvn.cmd clean package -DiskTests=true&quot;;</span><br><span class="line">String otherMavenCommand = &quot;mvn clean package -DiskTests=true&quot;;</span><br><span class="line">String mavenCommand = otherMavenCommand;</span><br></pre></td></tr></table></figure>

<p>2.修改后端项目的GeneratorController中的useGenerator</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//执行脚本</span><br><span class="line">//找到脚本文件的路径</span><br><span class="line">//要注意，如果不是windows系统，找generator文件而不是bat</span><br><span class="line">File scriptFile = FileUtil.loopFiles(unzipDistDir, 2, null)</span><br><span class="line">        .stream()</span><br><span class="line">        .filter(file -&gt; file.isFile() &amp;&amp; &quot;generator&quot;.equals(file.getName()))</span><br><span class="line">        .findFirst()</span><br><span class="line">        .orElseThrow(RuntimeException::new);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//如果是mac/linux系统，要用&quot;./generator&quot;</span><br><span class="line">String scriptAbsolutePath = scriptFile.getAbsolutePath();</span><br><span class="line">String[] commands = new String[]&#123;scriptAbsolutePath,&quot;json-generator&quot;, &quot;--file=&quot; + dataModelFilePath&#125;;</span><br></pre></td></tr></table></figure>

<p>设置好后发现无法访问后端，是因为我们每开放8120，但是实际上我们不需要开放8120，可以直接用Nginx转发</p>
<p>在前端PHP项目配置中增加</p>
<p>location &#x2F;api {<br>      proxy_pass  <a class="link"   target="_blank" rel="noopener" href="http://127.0.0.1:8120/" >http://127.0.0.1:8120<i class="fas fa-external-link-alt"></i></a>;<br>      proxy_set_header Host $proxy_host;<br>      proxy_set_header X-Real-Ip $remote_addr;<br>      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>      proxy_buffering off;<br>      proxy_set_header Connection “”;<br>    }</p>
<p>这样项目就上线成功</p>
<p>但是发现上传图片无法查看：修改对象存储的放盗链</p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/Java-FreeMarker-Picocli/">Java FreeMarker Picocli</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2024/07/17/%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2/"
                                   title="聚合搜索"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">聚合搜索</span>
                                        <span class="post-nav-item">Prev posts</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2024/03/26/%E5%AE%A2%E6%B5%81%E9%87%8F%E6%99%BA%E8%83%BD%E5%88%86%E6%9E%90%E5%B9%B3%E5%8F%B0/"
                                   title="客流量智能分析平台"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">客流量智能分析平台</span>
                                        <span class="post-nav-item">Next posts</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2024
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Keep Team</a>
        
    </div>

    <div class="theme-info info-item">
        Powered by&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;&&nbsp;Theme&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-toggle-theme-mode flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    

    <!-- tablet toc -->
    
</main>



<!-- common -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local-search -->


<!-- lazyload -->


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
